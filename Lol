-- ============================================================
-- MELAYU-HUB — BY SIGMA
-- Fly + Noclip for Herb/Treasure/Altar/Mob/Quest/Ability
-- ============================================================

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "MELAYU-HUB", LoadingTitle = "BY SIGMA",
   LoadingSubtitle = "LOADING...",
   ConfigurationSaving = { Enabled = true, FileName = "MelayuHub" },
   Discord = { Enabled = false }, KeySystem = false,
})

-- ============================================================
-- SERVICES
-- ============================================================
local Players           = game:GetService("Players")
local TweenService      = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")

local Player    = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HRP       = Character:WaitForChild("HumanoidRootPart")
local Humanoid  = Character:WaitForChild("Humanoid")

local flySpeed    = 150
local mobDistance = 6
local activeTween = nil
local activeBV    = nil -- global BodyVelocity reference to stop fly instantly

local herbActive     = false
local treasureActive = false
local altarActive    = false
local mobActive      = false
local questActive    = false
local alchemyActive  = false

-- Multi-farm priority (1 = highest). Saved via ConfigurationSaving
local farmPriority = { herb = 3, treasure = 2, altar = 1 }
local multiFarmThread = nil -- single coordinator thread for herb/treasure/altar

local selectedHerb      = nil
local selectedMob       = nil
local selectedQuest     = nil
local selectedTreasure  = {} -- table for multi-select
local selectedBloodline = {} -- table for multi-select
local questLoopEnabled  = false
local justRespawned     = false

local herbCollectCount      = 0
local treasureCollectCount  = 0
local altarCollectCount     = 0

Player.CharacterAdded:Connect(function(c)
    Character = c
    HRP       = c:WaitForChild("HumanoidRootPart")
    Humanoid  = c:WaitForChild("Humanoid")
    justRespawned = true

    -- Tunggu character fully loaded
    task.wait(2)
    justRespawned = false

    -- Reset PlatformStand dan noclip state lepas respawn
    if Humanoid then
        Humanoid.PlatformStand = false
        Humanoid.AutoRotate = true
    end
    if HRP then
        HRP.AssemblyLinearVelocity = Vector3.zero
    end

    -- Resume noclip if a farm is active
    if herbActive or treasureActive or altarActive or mobActive or questActive then
        noclipEnabled = true
    end
end)

-- ============================================================
-- FLY + NOCLIP SYSTEM
-- ============================================================
local noclipEnabled = false

-- Noclip loop — repeat setiap frame sebab Roblox reset CanCollide
local noclipConnection = RunService.Stepped:Connect(function()
    if noclipEnabled and Character then
        for _, part in ipairs(Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end
end)

local function setNoclip(state)
    noclipEnabled = state
    if not state and Character then
        for _, part in ipairs(Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
    end
end

-- Fly straight ke targetPos, noclip kekal ON sampai caller off-kan
local function flyTo(targetPos, activeCheck)
    if not HRP or not Humanoid then return false end

    Humanoid.PlatformStand = true
    setNoclip(true)

    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    bv.Velocity  = Vector3.zero
    bv.Parent    = HRP
    activeBV     = bv  -- store globally so stopFlyNoclip can kill instantly

    local maxTime = 60
    local t0      = tick()
    local reached = false

    while tick() - t0 < maxTime do
        if activeCheck and not activeCheck() then break end
        if not HRP or not HRP.Parent then break end
        if not bv or not bv.Parent then break end -- already destroyed by stop

        local currentPos = HRP.Position
        local dist       = (targetPos - currentPos).Magnitude

        if dist <= 3 then
            reached = true
            break
        end

        local dir = (targetPos - currentPos).Unit
        local speed
        if dist <= 15 then
            speed = math.max(10, flySpeed * (dist / 15))
        else
            speed = flySpeed
        end

        bv.Velocity = dir * speed
        task.wait()
    end

    -- Brake + cleanup
    if bv and bv.Parent then
        bv.Velocity = Vector3.zero
        task.wait(0.05)
        bv:Destroy()
    end
    activeBV = nil

    if reached and HRP and HRP.Parent then
        HRP.CFrame = CFrame.new(targetPos)
        HRP.AssemblyLinearVelocity = Vector3.zero
        task.wait(0.05)
    end

    Humanoid.PlatformStand = false

    return reached
end

-- Stop fly + noclip instantly
local function stopFlyNoclip()
    -- Kill tracked BodyVelocity
    if activeBV and activeBV.Parent then
        activeBV.Velocity = Vector3.zero
        activeBV:Destroy()
    end
    activeBV = nil

    -- Also destroy ANY leftover BodyVelocity on HRP (safety net)
    if HRP then
        for _, bv in ipairs(HRP:GetChildren()) do
            if bv:IsA("BodyVelocity") then
                bv.Velocity = Vector3.zero
                bv:Destroy()
            end
        end
    end

    setNoclip(false)

    if Humanoid then
        Humanoid.PlatformStand = false
        Humanoid.AutoRotate    = true
    end

    if HRP then
        HRP.AssemblyLinearVelocity  = Vector3.zero
        HRP.AssemblyAngularVelocity = Vector3.zero
        -- Anchor briefly to flush any accumulated physics momentum
        HRP.Anchored = true
        task.wait(0.15)
        HRP.Anchored = false
        HRP.AssemblyLinearVelocity  = Vector3.zero
        HRP.AssemblyAngularVelocity = Vector3.zero
    end

    -- Extra safety: force PlatformStand off again after brief wait
    -- in case a dying farm loop tried to set it back
    task.delay(0.2, function()
        if Humanoid then
            Humanoid.PlatformStand = false
            Humanoid.AutoRotate    = true
        end
        if HRP then
            HRP.AssemblyLinearVelocity  = Vector3.zero
            HRP.AssemblyAngularVelocity = Vector3.zero
        end
    end)
end

-- ============================================================
-- YEAR / ALCHEMY DATA
-- ============================================================
local YEAR_DISPLAY_LIST = {
    "One Year Old","Ten Year Old","Hundred Year Old","Thousand Year Old",
    "Ten Thousand Year Old","One Hundred Thousand Year Old",
    "Million Year Old","Ten Million Year Old",
}
local YEAR_TO_VARIATION = {
    ["One Year Old"]="One",["Ten Year Old"]="Ten",["Hundred Year Old"]="Hundred",
    ["Thousand Year Old"]="Thousand",["Ten Thousand Year Old"]="Ten Thousand",
    ["One Hundred Thousand Year Old"]="Hundred Thousand",
    ["Million Year Old"]="Million",["Ten Million Year Old"]="Ten Million",
}
local YEAR_COLOURS = {
    ["One"]=Color3.fromRGB(200,200,200),["Ten"]=Color3.fromRGB(150,230,150),
    ["Hundred"]=Color3.fromRGB(100,210,100),["Thousand"]=Color3.fromRGB(100,150,255),
    ["Ten Thousand"]=Color3.fromRGB(180,100,255),["Hundred Thousand"]=Color3.fromRGB(255,210,50),
    ["Million"]=Color3.fromRGB(255,130,50),["Ten Million"]=Color3.fromRGB(255,60,60),
}

local selectedAlchemyYear = "Thousand"
local alchemyCraftAmount  = 1

local HERB_ELEMENT = {
    ["Ginseng"]="Earth",["Taixian"]="Earth",["Qilin Berries"]="Heaven",
    ["Moonlight Flower"]="Heaven",["Twilight Bloom"]="Yin",["Spirit Grass"]="Yin",
    ["Blood Flower"]="Yin",["Yin Bush"]="Yin",["Lingzhi"]="Yang",["Yang Flower"]="Yang",
}

local ALCHEMY_RECIPES = {
    ["Breakthrough Pill"]    = {Base=40,  Elements={"Earth","Earth","Earth","Earth"},           Herbs={"Ginseng","Ginseng","Ginseng","Ginseng"},                     Requirement="Mortal I+ (Qi Rank 0+)"},
    ["Restoration Pill"]     = {Base=50,  Elements={"Earth","Earth","Earth","Yang"},            Herbs={"Ginseng","Ginseng","Ginseng","Yang Flower"},                 Requirement="Body Refining skill learned"},
    ["Health Pill"]          = {Base=80,  Elements={"Yin","Earth","Yang","Earth"},              Herbs={"Yin Bush","Ginseng","Yang Flower","Ginseng"},                Requirement="Qi Fusion I+ (Qi Rank 20+)"},
    ["Qi Pill"]              = {Base=80,  Elements={"Heaven","Heaven","Earth","Yin"},           Herbs={"Qilin Berries","Qilin Berries","Ginseng","Yin Bush"},        Requirement="True Foundation I+ (Qi Rank 40+)"},
    ["Molian Pill"]          = {Base=150, Elements={"Yin","Yin","Yang","Heaven"},               Herbs={"Yin Bush","Yin Bush","Yang Flower","Qilin Berries"},         Requirement="Core Formation I+ (Qi Rank 50+)"},
    ["Shulian Pill"]         = {Base=150, Elements={"Heaven","Heaven","Heaven","Heaven"},       Herbs={"Qilin Berries","Qilin Berries","Qilin Berries","Qilin Berries"},Requirement="Immortal I+ (Qi Rank 100+)"},
    ["Dragon Pill"]          = {Base=250, Elements={"Earth","Heaven","Yin","Yang"},             Herbs={"Ginseng","Qilin Berries","Yin Bush","Yang Flower"},          Requirement="Give 100k Year herb of each element to Shao Ruogang"},
    ["Tian Pill"]            = {Base=275, Elements={"Earth","Heaven","Heaven","Earth"},         Herbs={"Ginseng","Qilin Berries","Qilin Berries","Ginseng"},         Requirement="Creation Realm I+ (Qi Rank 200+)"},
    ["Soul Breakthrough Pill"]={Base=300, Elements={"Yin","Yang","Yin","Yang"},                 Herbs={"Yin Bush","Yang Flower","Yin Bush","Yang Flower"},           Requirement="1 Ascension"},
    ["Soul Energy Pill"]     = {Base=300, Elements={"Yin","Yin","Yang","Yang"},                 Herbs={"Yin Bush","Yin Bush","Yang Flower","Yang Flower"},           Requirement="3 Ascensions"},
    ["Soul Chance Pill"]     = {Base=400, Elements={"Yang","Yang","Yin","Yin"},                 Herbs={"Yang Flower","Yang Flower","Yin Bush","Yin Bush"},           Requirement="1 Ascension"},
    ["Soul Cap Pill"]        = {Base=300, Elements={"Yang","Yin","Yang","Yin"},                 Herbs={"Yang Flower","Yin Bush","Yang Flower","Yin Bush"},           Requirement="10 Ascensions"},
}

local recipeNames = {}
for name in pairs(ALCHEMY_RECIPES) do table.insert(recipeNames,name) end
table.sort(recipeNames)
local selectedRecipe = nil

-- Element → semua herb dalam element tu, disusun dari base value TERTINGGI
-- Script auto picks highest base value herb to maximize craft success
local ELEMENT_HERBS = {
    Earth   = {"Taixian","Ginseng"},           -- Taixian(18) > Ginseng(8)
    Heaven  = {"Moonlight Flower","Qilin Berries"}, -- Moonlight(25) > Qilin(23)
    Yin     = {"Yin Bush","Blood Flower","Twilight Bloom","Spirit Grass"}, -- 50>35>30>16
    Yang    = {"Yang Flower","Lingzhi"},        -- Yang Flower(45) > Lingzhi(15)
}

local HERB_BASE_VALUE = {
    ["Ginseng"]=8,["Taixian"]=18,["Qilin Berries"]=23,["Moonlight Flower"]=25,
    ["Twilight Bloom"]=30,["Blood Flower"]=35,["Yang Flower"]=45,["Yin Bush"]=50,
    ["Lingzhi"]=15,["Spirit Grass"]=16,
}

local YEAR_MULTIPLIER = {
    ["One"]=1,["Ten"]=2,["Hundred"]=4,["Thousand"]=8,["Ten Thousand"]=16,
    ["Hundred Thousand"]=32,["Million"]=64,["Ten Million"]=128,
}

-- Pick best herb (highest base value) for selected element + year
-- selectedHerbOverride = table {element -> herbName} if user wants to override
local selectedElementHerb = {} -- {Earth="Taixian", Heaven="Moonlight Flower", ...}

local function getBestHerbForElement(element)
    -- If user picked a specific herb for this element, use it
    if selectedElementHerb[element] then return selectedElementHerb[element] end
    -- Otherwise use highest base value herb (index 1)
    local herbs = ELEMENT_HERBS[element]
    return herbs and herbs[1] or "Ginseng"
end

local function calcRecipeBase(recipe, yearVariation)
    local total = 0
    local mult  = YEAR_MULTIPLIER[yearVariation] or 1
    for _, element in ipairs(recipe.Elements) do
        local herb = getBestHerbForElement(element)
        local base = HERB_BASE_VALUE[herb] or 8
        total += base * mult
    end
    return total
end

-- ============================================================
-- BLOODLINE DATA
-- ============================================================
local BLOODLINE_DATA = {
    ["Forbidden Apple"]=1,["Spider"]=1,["Stone Monkey"]=1,
    ["Turtle"]=2,["Wolf"]=2,["Giant"]=2,
    ["Jade Monkey"]=3,["Fairy"]=3,["Fox"]=3,
    ["True Phoenix"]=4,["Eternal Ice"]=4,["Heavenly Demon"]=4,
    ["Stellar Monarch"]=4,["Primordial Beast"]=4,
    ["Azure Dragon"]=5,["Immortal"]=5,
}
local bloodlineDropdownList = {"All Bloodlines"}
do
    local sorted={}
    for name,tier in pairs(BLOODLINE_DATA) do table.insert(sorted,{name=name,tier=tier}) end
    table.sort(sorted,function(a,b) if a.tier~=b.tier then return a.tier<b.tier end; return a.name<b.name end)
    for _, v in ipairs(sorted) do table.insert(bloodlineDropdownList,string.format("[T%d] %s",v.tier,v.name)) end
end

-- ============================================================
-- TREASURE CATEGORIES — fixed list
-- ============================================================
local TREASURE_CATEGORIES = {
    "All Treasures",
    "Common Treasure",
    "Lost Treasure",
    "Rare Treasure",
    "Very Rare Treasure",
}

-- ============================================================
-- QUEST DATA
-- ============================================================
local QUEST_DATA = {
    ["Bei Fang"]        = {Type="Slaying",    Target="Bandit",                 Amount=5,   Path=nil},
    ["Xi Hao"]          = {Type="Slaying",    Target="Commoner",               Amount=5,   Path=nil},
    ["Xiao Ling"]       = {Type="Harvesting", Target="Ginseng",                Amount=5,   Path=nil},
    ["Yang Wei"]        = {Type="Slaying",    Target="Female Blood Cultivator",Amount=7,   Path=nil},
    ["Taoist Xi"]       = {Type="Slaying",    Target="Furious Sect Member",    Amount=6,   Path=nil},
    ["Sun Tao"]         = {Type="Slaying",    Target="Male Assassin",          Amount=8,   Path=nil},
    ["Gao Xiang"]       = {Type="Slaying",    Target="Sect Master",            Amount=3,   Path=nil},
    ["Tong Li"]         = {Type="Slaying",    Target="Male Blood Cultivator",  Amount=6,   Path=nil},
    ["Wu Hao"]          = {Type="Slaying",    Target="Bao Laohu",              Amount=1,   Path=nil},
    ["Xia Hui"]         = {Type="Slaying",    Target="Corrupt Commoner",       Amount=7,   Path=nil},
    ["Zhing Xiu"]       = {Type="Slaying",    Target="Corrupt Minion",         Amount=7,   Path=nil},
    ["Xian Ling"]       = {Type="Slaying",    Target="Corrupt Admiral",        Amount=6,   Path=nil},
    ["Yang Zhu"]        = {Type="Slaying",    Target="Mount Hua Leader",       Amount=1,   Path=nil},
    ["Ling Qi"]         = {Type="Slaying",    Target="Stone Head Disciple",    Amount=6,   Path=nil},
    ["Xumian Shidi"]    = {Type="Slaying",    Target="Slatebound Disciple",    Amount=12,  Path=nil},
    ["Xumian Shixiong"] = {Type="Slaying",    Target="Slatebound Elder",       Amount=6,   Path=nil},
    ["Yuzhou"]          = {Type="Slaying",    Target="Slatebound Sovereign",   Amount=8,   Path=nil},
    ["Zhang Weiwei"]    = {Type="Harvesting", Target="Yin Bush",               Amount=100, Path=nil},
    ["Zhang Xiaoxiao"]  = {Type="Harvesting", Target="Yin Bush",               Amount=50,  Path=nil},
    ["Zhang Jingjing"]  = {Type="Harvesting", Target="Yang Flower",            Amount=50,  Path=nil},
    ["Zhang Xinxin"]    = {Type="Harvesting", Target="Yang Flower",            Amount=100, Path=nil},
    ["Zhang Yiwang"]    = {Type="Harvesting", Target="Blood Flower",           Amount=250, Path=nil},
    ["Yiwang Yaotian"]  = {Type="Harvesting", Target="Blood Flower",           Amount=500, Path=nil},
    ["Mo Gui"]          = {Type="Slaying",    Target="Professional Guard",     Amount=50,  Path=nil},
    ["Mo Yan"]          = {Type="Slaying",    Target="Loyal Guard",            Amount=100, Path=nil},
    ["Hongzhu Dashi"]   = {Type="Slaying",    Target="Diyu Mogui",             Amount=7,   Path="demon"},
    ["Shemni Nuzhu"]    = {Type="Slaying",    Target="Duyao Zhanshen",         Amount=8,   Path="demon"},
    ["Liehuo Jiangjun"] = {Type="Slaying",    Target="Siwang Zhi Zhang",       Amount=9,   Path="demon"},
}
local questNamesList={}
for name in pairs(QUEST_DATA) do table.insert(questNamesList,name) end
table.sort(questNamesList)

-- Multi-quest priority system
local selectedQuestList = {}       -- { {name="...", priority=1}, ... }
local currentQuestPriorityIndex = 1


-- ============================================================
-- STOP ALL
-- ============================================================
local function stopAll()
    herbActive=false; treasureActive=false; altarActive=false
    mobActive=false; questActive=false; alchemyActive=false; bossActive=false
    if activeTween then activeTween:Cancel(); activeTween=nil end
    herbCollectCount=0; treasureCollectCount=0; altarCollectCount=0
    stopFlyNoclip()
end

-- ============================================================
-- HELPERS
-- ============================================================
local function getCF(obj)
    if not obj then return nil end
    if typeof(obj)=="CFrame" then return obj end
    local cf
    pcall(function()
        if obj:IsA("Model") then cf=obj:GetPivot()
        elseif obj:IsA("BasePart") then cf=obj.CFrame
        elseif obj:IsA("Folder") then
            local p=obj:FindFirstChildWhichIsA("BasePart",true)
            if p then cf=p.CFrame end
        else cf=obj:GetPivot() end
    end)
    return cf
end

local function isPlayerInZone(zoneObj)
    if not zoneObj or not HRP then return false end
    local zonePart=zoneObj:IsA("BasePart") and zoneObj or zoneObj:FindFirstChildWhichIsA("BasePart",true)
    if not zonePart then return false end
    local dist=(HRP.Position-zonePart.Position).Magnitude
    local maxD=math.max(zonePart.Size.X,zonePart.Size.Y,zonePart.Size.Z)/2
    return dist<=maxD+2
end

local function getHerbVariation(obj)
    local v=nil
    pcall(function() v=obj:GetAttribute("Variation") end)
    if not v then pcall(function() local vc=obj:FindFirstChild("Variation"); if vc then v=vc.Value end end) end
    if not v then
        local n=obj.Name or ""
        for _, yr in ipairs({"Ten Million","Million","Hundred Thousand","Ten Thousand","Thousand","Hundred","Ten","One"}) do
            if n:find(yr) then v=yr; break end
        end
    end
    return v or "One"
end

local function findRandomHerb(folder,minDistance,yearFilter)
    if not folder or not HRP then return nil,0 end
    minDistance=minDistance or 5
    local valid={}
    for _, obj in pairs(folder:GetChildren()) do
        if not obj.Parent then continue end
        if yearFilter and getHerbVariation(obj)~=yearFilter then continue end
        local pos
        pcall(function()
            if obj:IsA("Model") then pos=obj:GetPivot().Position
            elseif obj:IsA("BasePart") then pos=obj.Position
            elseif obj:IsA("Folder") then local p=obj:FindFirstChildWhichIsA("BasePart",true); if p then pos=p.Position end end
        end)
        if pos then
            local d=(HRP.Position-pos).Magnitude
            if d>=minDistance then table.insert(valid,{obj=obj,dist=d}) end
        end
    end
    if #valid>0 then local c=valid[math.random(1,#valid)]; return c.obj,c.dist end
    return nil,0
end

local function findNearest(folder,minDistance,filterFunc)
    if not folder or not HRP then return nil,math.huge end
    minDistance=minDistance or 0
    local nearest,shortest=nil,math.huge
    for _, obj in pairs(folder:GetChildren()) do
        if not obj.Parent then continue end
        if filterFunc and not filterFunc(obj) then continue end
        local pos
        pcall(function()
            if obj:IsA("Model") then pos=obj:GetPivot().Position
            elseif obj:IsA("BasePart") then pos=obj.Position
            elseif obj:IsA("Folder") then local p=obj:FindFirstChildWhichIsA("BasePart",true); if p then pos=p.Position end end
        end)
        if pos then
            local d=(HRP.Position-pos).Magnitude
            if d>=minDistance and d<shortest then shortest=d; nearest=obj end
        end
    end
    return nearest,shortest
end

-- ============================================================
-- HARVEST PROGRESS BAR
-- ============================================================
local function getProgressBar()
    local gui=Player.PlayerGui
    local hp=gui:FindFirstChild("harvestPrompt")
    if hp then local pb=hp:FindFirstChild("ProgressBar"); if pb then local p=pb:FindFirstChild("Progress"); return p or pb end end
    for _, v in pairs(gui:GetDescendants()) do
        if v.Name=="Progress" and v.Parent and v.Parent.Name=="ProgressBar" then return v end
    end
    return nil
end

local function waitForHarvestComplete(activeCheck)
    local bar,t0=nil,tick()
    while tick()-t0<1.5 and activeCheck() do bar=getProgressBar(); if bar then break end; task.wait(0.02) end
    if not bar then return "swap" end
    local s0=0; pcall(function() s0=bar.Size.X.Scale end)
    task.wait(1.0)
    if not activeCheck() then return "stop" end
    local sc=0; pcall(function() sc=bar.Size.X.Scale end)
    if sc<=s0+0.01 then return "swap" end
    local prev,peaked=sc,false; local timeout=tick()
    while activeCheck() and tick()-timeout<30 do
        local s=0; pcall(function() s=bar.Size.X.Scale end)
        if s>=0.3 and not peaked then peaked=true end
        if peaked and prev>=0.2 and s<=0.02 then return "complete" end
        prev=s; task.wait(0.01)
    end
    return "timeout"
end

local function getHerbFolder(name)
    local herbs=workspace:FindFirstChild("Herbs"); if not herbs then return nil end
    local node=herbs:FindFirstChild(name); if not node then return nil end
    return node:FindFirstChild("Folder") or node
end

-- ============================================================
-- HERB FARMING (FLY + NOCLIP)
-- ============================================================

-- Collect ONE herb, return true if collected, false if nothing found
local function doOneHerb()
    local list = type(selectedHerb)=="table" and selectedHerb or {selectedHerb}
    if not list or #list == 0 then return false end

    local foundHerb = nil
    for _, herbName in ipairs(list) do
        local folder = getHerbFolder(herbName)
        if folder then
            local h = findRandomHerb(folder, 5, selectedHerbYear)
            if h then foundHerb = h; break end
        end
    end
    if not foundHerb or not foundHerb.Parent then return false end

    local zone = foundHerb:FindFirstChild("HerbZone", true)
    if not zone then return false end
    local targetCF = getCF(zone)
    if not targetCF then return false end

    local reached = flyTo(targetCF.Position, function() return herbActive or treasureActive or altarActive end)
    if not reached then return false end

    local attempt = 0
    while not isPlayerInZone(zone) and attempt < 10 and (herbActive or treasureActive or altarActive) do
        attempt += 1
        local zCF = getCF(zone)
        if zCF then HRP.CFrame = CFrame.new(zCF.Position); HRP.AssemblyLinearVelocity = Vector3.zero end
        task.wait(0.05)
    end
    if not isPlayerInZone(zone) then return false end
    task.wait(0.3)
    if not isPlayerInZone(zone) then return false end

    pcall(function() ReplicatedStorage.RemoteEvents.Harvest:FireServer() end)
    local result = waitForHarvestComplete(function() return herbActive or treasureActive or altarActive end)
    if result == "complete" then herbCollectCount += 1; return true end
    return false
end

-- ============================================================
-- TREASURE FARMING (FLY + NOCLIP)
-- ============================================================
local function firePrompt(obj)
    local kh = obj:FindFirstChild("KeyHole")
    if kh then local p = kh:FindFirstChild("OpenPrompt"); if p and p:IsA("ProximityPrompt") then fireproximityprompt(p); return true end end
    local p = obj:FindFirstChildOfClass("ProximityPrompt", true)
    if p then fireproximityprompt(p); return true end
    return false
end

local function treasureMatchesFilter(obj)
    if not selectedTreasure or #selectedTreasure == 0 then return true end
    for _, pick in ipairs(selectedTreasure) do
        if pick == "All Treasures" then return true end
        local nameLen = #pick
        if obj.Name:sub(1, nameLen) == pick then
            local nextChar = obj.Name:sub(nameLen + 1, nameLen + 1)
            if nextChar == "" or nextChar == " " or tonumber(nextChar) then return true end
        end
    end
    return false
end

-- Loot ONE treasure, return true if looted
local function doOneTreasure()
    local folder = workspace:FindFirstChild("Treasures")
    if not folder then return false end

    local treasure = findNearest(folder, 0, treasureMatchesFilter)
    if not treasure then return false end

    local cf = getCF(treasure)
    if not cf then return false end

    local reached = flyTo(cf.Position, function() return herbActive or treasureActive or altarActive end)
    if not reached or not treasure.Parent then return false end

    cf = getCF(treasure)
    if cf then
        HRP.CFrame = CFrame.new(cf.Position); HRP.AssemblyLinearVelocity = Vector3.zero; HRP.AssemblyAngularVelocity = Vector3.zero
        task.wait(0.05); HRP.Anchored = true; task.wait(0.15); HRP.Anchored = false
        HRP.AssemblyLinearVelocity = Vector3.zero; task.wait(0.3)
    end

    local hasPrompt = false; local count = 0
    while treasure.Parent and treasureActive and count < 400 do
        local curCF = getCF(treasure)
        if curCF and (HRP.Position - curCF.Position).Magnitude > 20 then
            HRP.CFrame = CFrame.new(curCF.Position); HRP.AssemblyLinearVelocity = Vector3.zero; task.wait(0.2)
        end
        if firePrompt(treasure) then hasPrompt = true end
        count += 1; task.wait(0.05)
    end

    if not treasure.Parent then treasureCollectCount += 1; return true end
    return false
end

-- ============================================================
-- ALTAR FARMING (FLY + NOCLIP)
-- ============================================================
local function fireAltarPrompt(altar)
    for _, d in pairs(altar:GetDescendants()) do
        if d:IsA("ProximityPrompt") and d.Name:lower():find("collect") then fireproximityprompt(d); return true end
    end
    local p = altar:FindFirstChildOfClass("ProximityPrompt", true)
    if p then fireproximityprompt(p); return true end
    return false
end

local function altarMatchesBloodline(altar)
    if not selectedBloodline or #selectedBloodline == 0 then return true end
    local al = altar.Name:lower()
    local bv = altar:FindFirstChild("Bloodline")
    local attr = nil; pcall(function() attr = altar:GetAttribute("Bloodline") end)
    for _, pick in ipairs(selectedBloodline) do
        local bl = pick:lower()
        if al:find(bl, 1, true) then return true end
        if bv and bv.Value and bv.Value:lower() == bl then return true end
        if attr and attr:lower() == bl then return true end
    end
    return false
end

-- Collect ONE altar, return true if collected
local function doOneAltar()
    local folder = workspace:FindFirstChild("Altars")
    if not folder then return false end
    local nearest = findNearest(folder, 0, altarMatchesBloodline)
    if not nearest then return false end
    local cf = getCF(nearest)
    if not cf then return false end
    local reached = flyTo(cf.Position, function() return herbActive or treasureActive or altarActive end)
    if not reached then return false end
    task.wait(0.5)
    fireAltarPrompt(nearest)
    task.wait(0.5)
    altarCollectCount += 1
    return true
end

-- ============================================================
-- MULTI-FARM COORDINATOR (Round-Robin by Priority)
-- ============================================================
local function runMultiFarm()
    setNoclip(true)
    -- cycleIndex tracks where in the sorted priority list we are
    local cycleIndex = 1

    while herbActive or treasureActive or altarActive do
        -- Build priority queue sorted by farmPriority value (lower number = higher priority)
        local queue = {}
        if altarActive  then table.insert(queue, {t="altar",   p=farmPriority.altar})   end
        if treasureActive then table.insert(queue, {t="treasure", p=farmPriority.treasure}) end
        if herbActive   then table.insert(queue, {t="herb",    p=farmPriority.herb})    end

        if #queue == 0 then break end
        table.sort(queue, function(a,b) return a.p < b.p end)

        -- Clamp cycleIndex to valid range
        if cycleIndex > #queue then cycleIndex = 1 end

        -- Try from cycleIndex, wrap around if needed
        local tried = 0
        local didSomething = false
        while tried < #queue do
            local farm = queue[cycleIndex]
            cycleIndex = (cycleIndex % #queue) + 1
            tried += 1

            local ok = false
            if farm.t == "altar" and altarActive then
                ok = doOneAltar()
            elseif farm.t == "treasure" and treasureActive then
                ok = doOneTreasure()
            elseif farm.t == "herb" and herbActive then
                ok = doOneHerb()
            end

            if ok then
                didSomething = true
                -- Small pause before switching to next farm type
                task.wait(0.3)
                break
            end
        end

        if not didSomething then
            -- Nothing available in any farm, wait and retry
            task.wait(2)
        end
    end

    multiFarmThread = nil
    stopFlyNoclip()
end

local function ensureMultiFarmRunning()
    if multiFarmThread then return end
    multiFarmThread = task.spawn(runMultiFarm)
end

-- ============================================================
-- MOB FARMING (FLY + NOCLIP)
-- ============================================================
local COMBAT_DISTANCE = 6

local function getCombatCFrame(mobRoot)
    -- Directly above mob's head
    local abovePos = mobRoot.Position + Vector3.new(0, mobDistance, 0)
    -- Face same direction as mob's head (copy mob's LookVector)
    -- Then tilt -90 on X to lay flat (prone)
    return CFrame.new(abovePos, abovePos + mobRoot.CFrame.LookVector) * CFrame.Angles(-math.pi/2, 0, 0)
end

local function farmMobs()
    local folder=workspace:FindFirstChild("Enemies"); if not folder then return end
    setNoclip(true)

    while mobActive do
        if justRespawned then while justRespawned and mobActive do task.wait(0.5) end end
        if not mobActive then break end
        local nearest,shortest=nil,math.huge
        for _, mob in pairs(folder:GetChildren()) do
            if mob.Name==selectedMob then
                local hum=mob:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health>0 then
                    local ok,pos=pcall(function() return mob:GetPivot().Position end)
                    if ok then local d=(HRP.Position-pos).Magnitude; if d<shortest then shortest=d; nearest=mob end end
                end
            end
        end
        if not nearest then
            Rayfield:Notify({Title="Mob Farm",Content=selectedMob.." not spawned.",Duration=2,Image=4483362458})
            task.wait(1); continue
        end
        local mobRoot=nearest:FindFirstChild("HumanoidRootPart"); if not mobRoot then task.wait(0.5); continue end

        -- Fly to hover position (above + side)
        local initCF = getCombatCFrame(mobRoot)
        flyTo(initCF.Position, function() return mobActive end)
        task.wait(0.05)
        if not mobActive then break end
        if not nearest.Parent then task.wait(0.5); continue end

        local hum=nearest:FindFirstChildOfClass("Humanoid"); if not hum or hum.Health<=0 then task.wait(0.5); continue end

        Humanoid.PlatformStand = true -- keep prone while attacking
        local attackTimeout=tick()
        while mobActive and nearest.Parent do
            if justRespawned then break end
            local h=nearest:FindFirstChildOfClass("Humanoid"); if not h or h.Health<=0 then break end
            if tick()-attackTimeout>60 then break end
            if mobRoot and mobRoot.Parent then
                -- Lock to combat position: above, prone, facing mob
                HRP.CFrame = getCombatCFrame(mobRoot)
                HRP.AssemblyLinearVelocity  = Vector3.zero
                HRP.AssemblyAngularVelocity = Vector3.zero
            end
            pcall(function() ReplicatedStorage.RemoteEvents.Attack:FireServer("Light",{["RootPart"]=HRP}) end)
            task.wait(0.1)
        end
        -- Mob died — reset immediately to prevent fling
        Humanoid.PlatformStand = false
        Humanoid.AutoRotate = true
        if HRP then
            HRP.AssemblyLinearVelocity  = Vector3.zero
            HRP.AssemblyAngularVelocity = Vector3.zero
            HRP.Anchored = true
            task.wait(0.2)
            HRP.Anchored = false
            HRP.AssemblyLinearVelocity  = Vector3.zero
        end
        task.wait(0.3)
    end
    Humanoid.PlatformStand = false
    stopFlyNoclip()
end

-- ============================================================
-- QUEST SYSTEM
-- ============================================================
local function getProgressFromServer(npcName)
    local function check(qd)
        if qd and qd:FindFirstChild("NpcName") and qd.NpcName.Value==npcName then
            if qd:FindFirstChild("Progress") and qd:FindFirstChild("ProgressEnd") then
                return qd.Progress.Value,qd.ProgressEnd.Value
            end
        end
        return nil,nil
    end
    local p,e=check(Player:FindFirstChild("QuestData")); if p then return p,e end
    return check(Player:FindFirstChild("SecondQuestData"))
end

local function acceptQuest(npcName)
    pcall(function() ReplicatedStorage.RemoteFunctions.Quest:InvokeServer(npcName,true) end)
    task.wait(0.5)
end

-- Quest Slaying — FLY + NOCLIP to mob
local function farmQuestSlaying(npcName,target,lbl)
    local folder=workspace:FindFirstChild("Enemies"); if not folder then return end
    setNoclip(true)
    while questActive do
        if justRespawned then while justRespawned and questActive do task.wait(0.5) end end
        if not questActive then break end
        local prog,pEnd=getProgressFromServer(npcName)
        if not prog then break end
        lbl:Set(" Progress: "..prog.." / "..pEnd)
        if prog>=pEnd then break end
        local nearest,shortest=nil,math.huge
        for _, mob in pairs(folder:GetChildren()) do
            if mob.Name==target then
                local hum=mob:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health>0 then
                    local ok,pos=pcall(function() return mob:GetPivot().Position end)
                    if ok then local d=(HRP.Position-pos).Magnitude; if d<shortest then shortest=d; nearest=mob end end
                end
            end
        end
        if not nearest then
            Rayfield:Notify({Title="Quest",Content=target.." not found. Waiting...",Duration=2,Image=4483362458})
            task.wait(2); continue
        end
        local mobRoot=nearest:FindFirstChild("HumanoidRootPart"); if not mobRoot then task.wait(0.5); continue end

        -- Fly to hover position (above + side of mob)
        local initCF = getCombatCFrame(mobRoot)
        flyTo(initCF.Position, function() return questActive end)
        task.wait(0.05)
        if not questActive then break end
        if not nearest.Parent then task.wait(1); continue end

        local hum=nearest:FindFirstChildOfClass("Humanoid"); if not hum or hum.Health<=0 then task.wait(0.5); continue end

        Humanoid.PlatformStand = true
        local attackTimeout=tick()
        while questActive and nearest.Parent do
            if justRespawned then break end
            local h=nearest:FindFirstChildOfClass("Humanoid"); if not h or h.Health<=0 then break end
            if tick()-attackTimeout>60 then break end
            if mobRoot and mobRoot.Parent then
                -- Lock prone combat position above mob, facing mob
                HRP.CFrame = getCombatCFrame(mobRoot)
                HRP.AssemblyLinearVelocity  = Vector3.zero
                HRP.AssemblyAngularVelocity = Vector3.zero
            end
            pcall(function() ReplicatedStorage.RemoteEvents.Attack:FireServer("Light",{["RootPart"]=HRP}) end)
            task.wait(0.1)
        end
        -- Mob died — reset immediately to prevent fling
        Humanoid.PlatformStand = false
        Humanoid.AutoRotate = true
        if HRP then
            HRP.AssemblyLinearVelocity  = Vector3.zero
            HRP.AssemblyAngularVelocity = Vector3.zero
            HRP.Anchored = true
            task.wait(0.2)
            HRP.Anchored = false
            HRP.AssemblyLinearVelocity  = Vector3.zero
        end
        task.wait(0.3)
    end
    Humanoid.PlatformStand = false
end

-- Quest Harvesting — FLY + NOCLIP ke herb
local function farmQuestHarvesting(npcName,target,lbl)
    setNoclip(true) -- Noclip ON for quest harvesting
    while questActive do
        local prog,pEnd=getProgressFromServer(npcName)
        if not prog then break end
        lbl:Set(" Progress: "..prog.." / "..pEnd)
        if prog>=pEnd then break end
        local folder=getHerbFolder(target)
        if not folder then
            Rayfield:Notify({Title="Quest Harvest",Content=target.." herb not found yet. Waiting...",Duration=3,Image=4483362458})
            task.wait(3); continue
        end
        local herb,_=findRandomHerb(folder,5,nil)
        if not herb or not herb.Parent then
            Rayfield:Notify({Title="Quest Harvest",Content=target.." herb not spawned yet. Waiting...",Duration=2,Image=4483362458})
            task.wait(2); continue
        end
        local zone=herb:FindFirstChild("HerbZone",true); if not zone then continue end
        local targetCF=getCF(zone); if not targetCF then task.wait(0.2); continue end

        -- FLY to herb zone
        local ok=flyTo(targetCF.Position, function() return questActive end)
        if not questActive then break end
        if not ok then task.wait(0.2); continue end

        local attempt=0
        while not isPlayerInZone(zone) and attempt<10 and questActive do
            attempt+=1
            local zCF=getCF(zone)
            if zCF then HRP.CFrame=CFrame.new(zCF.Position); HRP.AssemblyLinearVelocity=Vector3.zero end
            task.wait(0.05)
        end
        if not isPlayerInZone(zone) then continue end
        task.wait(0.3)
        if not isPlayerInZone(zone) or not questActive then continue end
        pcall(function() ReplicatedStorage.RemoteEvents.Harvest:FireServer() end)
        waitForHarvestComplete(function() return questActive end)
        if not questActive then break end
    end
end

local function runQuestFarm(lblNPC,lblTarget,lblProg,qLblQueue)
    -- Sort quest list by priority ascending (1 = highest)
    local function getSortedQuests()
        local sorted = {}
        for _, q in ipairs(selectedQuestList) do table.insert(sorted, q) end
        table.sort(sorted, function(a,b) return a.priority < b.priority end)
        return sorted
    end

    local function updateQueueDisplay()
        if not qLblQueue then return end
        local sorted = getSortedQuests()
        if #sorted == 0 then qLblQueue:Set(" Queue: (none)"); return end
        local parts = {}
        for i, q in ipairs(sorted) do
            table.insert(parts, "["..q.priority.."] "..q.name)
        end
        qLblQueue:Set(" Queue: "..table.concat(parts, "  |  "))
    end

    -- Helper: get current quest to run based on priority index
    local function getNextQuestToRun()
        local sorted = getSortedQuests()
        if #sorted == 0 then return nil end
        if currentQuestPriorityIndex > #sorted then currentQuestPriorityIndex = 1 end
        return sorted[currentQuestPriorityIndex]
    end

    updateQueueDisplay()

    while questActive do
        -- First: check if there is any active quest on server already (selesaikan dulu)
        local activeOnServer, progActive, pEndActive = nil, nil, nil
        for qn in pairs(QUEST_DATA) do
            local p, e = getProgressFromServer(qn)
            if p then activeOnServer = qn; progActive = p; pEndActive = e; break end
        end

        if activeOnServer then
            -- Ada quest aktif kat server — kena habiskan dulu
            local info = QUEST_DATA[activeOnServer]
            if not info then task.wait(1); continue end

            -- Notify path kalau ada
            if info.Path then
                Rayfield:Notify({
                    Title = "Quest Path",
                    Content = "this quest for (" .. info.Path .. ") path",
                    Duration = 5,
                    Image = 4483362458,
                })
            end

            lblNPC:Set(" NPC: " .. activeOnServer)
            lblTarget:Set(" " .. info.Target .. " [" .. info.Type .. "]")
            lblProg:Set(" Progress: " .. progActive .. " / " .. pEndActive)

            if info.Type == "Slaying" then
                farmQuestSlaying(activeOnServer, info.Target, lblProg)
            elseif info.Type == "Harvesting" then
                farmQuestHarvesting(activeOnServer, info.Target, lblProg)
            end

            if not questActive then break end

            local p2 = getProgressFromServer(activeOnServer)
            if not p2 then
                lblTarget:Set("  Quest done!")
                if questLoopEnabled then
                    -- Loop: kalau quest ni dalam list kita, re-accept
                    task.wait(2)
                    acceptQuest(activeOnServer)
                    task.wait(1)
                    -- Move to next priority
                    local sorted = getSortedQuests()
                    if #sorted > 1 then
                        currentQuestPriorityIndex = currentQuestPriorityIndex + 1
                        if currentQuestPriorityIndex > #sorted then currentQuestPriorityIndex = 1 end
                    end
                else
                    -- Kalau loop off dan ada quest lain dalam list, teruskan ke next
                    local sorted = getSortedQuests()
                    if #sorted > 1 then
                        currentQuestPriorityIndex = currentQuestPriorityIndex + 1
                        if currentQuestPriorityIndex > #sorted then
                            -- Habis semua, stop
                            questActive = false; stopFlyNoclip(); break
                        end
                    else
                        questActive = false; stopFlyNoclip(); break
                    end
                end
            end
            task.wait(1)
        else
            -- Tiada quest aktif kat server — accept ikut priority
            local nextQ = getNextQuestToRun()
            if not nextQ then task.wait(1); continue end

            acceptQuest(nextQ.name)
            task.wait(1)

            local questDataExists = Player:FindFirstChild("QuestData") or Player:FindFirstChild("SecondQuestData")
            if not questDataExists then
                local info = QUEST_DATA[nextQ.name]
                lblNPC:Set(" NPC: " .. nextQ.name)
                lblTarget:Set(" NOT READY FOR QUEST")
                lblProg:Set(" Progress: -")
                Rayfield:Notify({
                    Title = "Quest FAIL",
                    Content = "Not ready for " .. nextQ.name,
                    Duration = 5,
                    Image = 4483362458,
                })
                task.wait(3); continue
            end

            local prog, pEnd = getProgressFromServer(nextQ.name)
            if not prog then task.wait(3); continue end

            local info = QUEST_DATA[nextQ.name]
            if not info then task.wait(1); continue end

            -- Notify path
            if info.Path then
                Rayfield:Notify({
                    Title = "Quest Path",
                    Content = "this quest for (" .. info.Path .. ") path",
                    Duration = 5,
                    Image = 4483362458,
                })
            end

            lblNPC:Set(" NPC: " .. nextQ.name)
            lblTarget:Set(" " .. info.Target .. " [" .. info.Type .. "]")
            lblProg:Set(" Progress: " .. prog .. " / " .. pEnd)

            if info.Type == "Slaying" then
                farmQuestSlaying(nextQ.name, info.Target, lblProg)
            elseif info.Type == "Harvesting" then
                farmQuestHarvesting(nextQ.name, info.Target, lblProg)
            end

            if not questActive then break end

            local p2 = getProgressFromServer(nextQ.name)
            if not p2 then
                lblTarget:Set("  Quest done!")
                local sorted = getSortedQuests()
                if questLoopEnabled then
                    currentQuestPriorityIndex = currentQuestPriorityIndex + 1
                    if currentQuestPriorityIndex > #sorted then currentQuestPriorityIndex = 1 end
                    task.wait(2)
                    -- Next iteration will accept next quest
                else
                    if #sorted > 1 then
                        currentQuestPriorityIndex = currentQuestPriorityIndex + 1
                        if currentQuestPriorityIndex > #sorted then
                            questActive = false; stopFlyNoclip(); break
                        end
                    else
                        questActive = false; stopFlyNoclip(); break
                    end
                end
            end
            task.wait(1)
        end
    end
    stopFlyNoclip()
end

-- ============================================================
-- BOSS FARM
-- ============================================================
local bossActive = false
local BOSS_MOBS = {"Zanshi Huo Ren", "Zanshi Bing Ren"}

-- Spawn detector for boss mobs
local bossSpawnConnection = nil
local function startBossSpawnDetector()
    if bossSpawnConnection then bossSpawnConnection:Disconnect() end
    local folder = workspace:FindFirstChild("Enemies")
    if not folder then return end
    bossSpawnConnection = folder.ChildAdded:Connect(function(child)
        for _, bossName in ipairs(BOSS_MOBS) do
            if child.Name == bossName then
                for i = 1, 5 do
                    Rayfield:Notify({
                        Title = "BOSS SPAWN",
                        Content = child.Name .. " HAS SPAWN",
                        Duration = 4,
                        Image = 4483362458,
                    })
                    task.wait(0.5)
                end
                break
            end
        end
    end)
end

local function stopBossSpawnDetector()
    if bossSpawnConnection then bossSpawnConnection:Disconnect(); bossSpawnConnection = nil end
end

startBossSpawnDetector() -- Auto start on load

local selectedBossMob = nil

local function farmBoss()
    local folder = workspace:FindFirstChild("Enemies")
    if not folder then return end
    setNoclip(true)
    while bossActive do
        if justRespawned then while justRespawned and bossActive do task.wait(0.5) end end
        if not bossActive then break end
        if not selectedBossMob then task.wait(1); continue end
        local nearest, shortest = nil, math.huge
        for _, mob in pairs(folder:GetChildren()) do
            if mob.Name == selectedBossMob then
                local hum = mob:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health > 0 then
                    local ok, pos = pcall(function() return mob:GetPivot().Position end)
                    if ok then local d = (HRP.Position - pos).Magnitude; if d < shortest then shortest = d; nearest = mob end end
                end
            end
        end
        if not nearest then
            Rayfield:Notify({Title="Boss Farm", Content=selectedBossMob.." not spawned.", Duration=2, Image=4483362458})
            task.wait(2); continue
        end
        local mobRoot = nearest:FindFirstChild("HumanoidRootPart")
        if not mobRoot then task.wait(0.5); continue end
        local initCF = getCombatCFrame(mobRoot)
        flyTo(initCF.Position, function() return bossActive end)
        task.wait(0.05)
        if not bossActive then break end
        if not nearest.Parent then task.wait(0.5); continue end
        local hum = nearest:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then task.wait(0.5); continue end
        Humanoid.PlatformStand = true
        local attackTimeout = tick()
        while bossActive and nearest.Parent do
            if justRespawned then break end
            local h = nearest:FindFirstChildOfClass("Humanoid")
            if not h or h.Health <= 0 then break end
            if tick() - attackTimeout > 120 then break end
            if mobRoot and mobRoot.Parent then
                HRP.CFrame = getCombatCFrame(mobRoot)
                HRP.AssemblyLinearVelocity = Vector3.zero
                HRP.AssemblyAngularVelocity = Vector3.zero
            end
            pcall(function() ReplicatedStorage.RemoteEvents.Attack:FireServer("Light", {["RootPart"] = HRP}) end)
            task.wait(0.1)
        end
        Humanoid.PlatformStand = false
        Humanoid.AutoRotate = true
        if HRP then
            HRP.AssemblyLinearVelocity = Vector3.zero
            HRP.AssemblyAngularVelocity = Vector3.zero
            HRP.Anchored = true
            task.wait(0.2)
            HRP.Anchored = false
            HRP.AssemblyLinearVelocity = Vector3.zero
        end
        task.wait(0.3)
    end
    Humanoid.PlatformStand = false
    stopFlyNoclip()
end

-- 
--   TAB 5 QUEST  
-- 
local Tab5=Window:CreateTab(" Quest",4483362458)
local qLblNPC   = Tab5:CreateLabel(" NPC: -")
local qLblTgt   = Tab5:CreateLabel(" Target: -")
local qLblProg  = Tab5:CreateLabel(" Progress: -")
local qLblLoop  = Tab5:CreateLabel(" Loop: OFF")
local qLblQueue = Tab5:CreateLabel(" Queue: (none)")

Tab5:CreateSection(" Quest Selection")
Tab5:CreateDropdown({Name="Select Quest",Options=questNamesList,CurrentOption={"Select"},MultipleOptions=false,
    Callback=function(opt)
        local qname = opt[1]
        if not qname or qname == "Select" then return end
        local info = QUEST_DATA[qname]
        if not info then return end
        -- Check if already in list
        for _, q in ipairs(selectedQuestList) do
            if q.name == qname then
                Rayfield:Notify({Title="Quest",Content=qname.." already in queue.",Duration=2,Image=4483362458})
                return
            end
        end
        -- Add with next priority number
        local nextPriority = #selectedQuestList + 1
        table.insert(selectedQuestList, {name=qname, priority=nextPriority})
        -- Update queue display
        local parts = {}
        local sorted = {}
        for _, q in ipairs(selectedQuestList) do table.insert(sorted, q) end
        table.sort(sorted, function(a,b) return a.priority < b.priority end)
        for _, q in ipairs(sorted) do table.insert(parts, "["..q.priority.."] "..q.name) end
        qLblQueue:Set(" Queue: "..table.concat(parts, "  |  "))
        Rayfield:Notify({Title="Quest Added",Content=qname.." | Priority "..nextPriority,Duration=3,Image=4483362458})
    end})

Tab5:CreateButton({Name="Remove Last Quest from Queue",
    Callback=function()
        if #selectedQuestList == 0 then
            Rayfield:Notify({Title="Queue",Content="Queue is empty.",Duration=2,Image=4483362458})
            return
        end
        local removed = table.remove(selectedQuestList)
        -- Re-number priorities
        for i, q in ipairs(selectedQuestList) do q.priority = i end
        local parts = {}
        for _, q in ipairs(selectedQuestList) do table.insert(parts, "["..q.priority.."] "..q.name) end
        qLblQueue:Set(#selectedQuestList > 0 and " Queue: "..table.concat(parts, "  |  ") or " Queue: (none)")
        Rayfield:Notify({Title="Queue",Content="Removed: "..removed.name,Duration=2,Image=4483362458})
    end})

Tab5:CreateButton({Name="Clear Quest Queue",
    Callback=function()
        selectedQuestList = {}
        currentQuestPriorityIndex = 1
        qLblQueue:Set(" Queue: (none)")
        Rayfield:Notify({Title="Queue",Content="Queue cleared.",Duration=2,Image=4483362458})
    end})

Tab5:CreateSection(" Priority")
Tab5:CreateDropdown({Name="Move Quest to Priority 1",Options=questNamesList,CurrentOption={"Select"},MultipleOptions=false,
    Callback=function(opt)
        local qname = opt[1]
        if not qname or qname == "Select" then return end
        -- Check if in list
        local found = false
        for _, q in ipairs(selectedQuestList) do
            if q.name == qname then found = true; break end
        end
        if not found then
            Rayfield:Notify({Title="Priority",Content=qname.." not in queue. Add it first.",Duration=3,Image=4483362458})
            return
        end
        -- Remove and reinsert at front
        local newList = {{name=qname, priority=1}}
        for _, q in ipairs(selectedQuestList) do
            if q.name ~= qname then table.insert(newList, q) end
        end
        -- Re-number
        for i, q in ipairs(newList) do q.priority = i end
        selectedQuestList = newList
        currentQuestPriorityIndex = 1
        local parts = {}
        for _, q in ipairs(selectedQuestList) do table.insert(parts, "["..q.priority.."] "..q.name) end
        qLblQueue:Set(" Queue: "..table.concat(parts, "  |  "))
        Rayfield:Notify({Title="Priority",Content=qname.." set to priority 1.",Duration=3,Image=4483362458})
    end})

Tab5:CreateSection(" Farm Control")
Tab5:CreateToggle({Name="Loop Quest",CurrentValue=false,
    Callback=function(val) questLoopEnabled=val; qLblLoop:Set(" Loop: "..(val and "ON " or "OFF ")) end})
Tab5:CreateToggle({Name="Auto Farm Quest",CurrentValue=false,
    Callback=function(val)
        if val then
            if #selectedQuestList == 0 then
                Rayfield:Notify({Title="Error",Content="Add quest to queue first!",Duration=3,Image=4483362458}); return
            end
            questActive=true
            currentQuestPriorityIndex = 1
            task.spawn(function() runQuestFarm(qLblNPC,qLblTgt,qLblProg,qLblQueue) end)
            Rayfield:Notify({Title="Quest",Content="Started!",Duration=3,Image=4483362458})
        else
            questActive=false
            stopFlyNoclip()
            qLblNPC:Set(" NPC: -"); qLblTgt:Set(" -"); qLblProg:Set(" -")
            Rayfield:Notify({Title="Quest",Content="Stopped.",Duration=2,Image=4483362458})
        end
    end})

-- 
--   TAB BOSS FARM  
-- 
local TabBoss=Window:CreateTab(" Boss Farm",4483362458)
TabBoss:CreateSection(" Boss Spawn Detection")
TabBoss:CreateLabel(" Zanshi Huo Ren")
TabBoss:CreateLabel(" Zanshi Bing Ren")
TabBoss:CreateLabel(" Notify will spam 5x when boss spawns.")
TabBoss:CreateSection(" Boss Farm")
TabBoss:CreateDropdown({Name="Select Boss",Options={"Zanshi Huo Ren","Zanshi Bing Ren"},CurrentOption={"Select"},MultipleOptions=false,
    Callback=function(opt)
        selectedBossMob = opt[1]
        Rayfield:Notify({Title="Boss Farm",Content="Selected: "..opt[1],Duration=2,Image=4483362458})
    end})
TabBoss:CreateSlider({Name="Distance (studs)",Range={3,15},Increment=1,CurrentValue=6,
    Callback=function(val) mobDistance=val end})
TabBoss:CreateToggle({Name="Auto Farm Boss",CurrentValue=false,
    Callback=function(val)
        if val then
            if not selectedBossMob or selectedBossMob == "Select" then
                Rayfield:Notify({Title="Error",Content="Select a boss first!",Duration=3,Image=4483362458}); return
            end
            bossActive=true
            task.spawn(function() while bossActive do farmBoss(); if bossActive then task.wait(1) end end end)
            Rayfield:Notify({Title="Boss Farm",Content="Started! Farming "..selectedBossMob,Duration=3,Image=4483362458})
        else
            bossActive=false
            Humanoid.PlatformStand = false
            stopFlyNoclip()
            Rayfield:Notify({Title="Boss Farm",Content="Stopped.",Duration=2,Image=4483362458})
        end
    end})

--   TAB 6 TRAINING/NPC  
-- 
local Tab6=Window:CreateTab(" Training/NPC",4483362458)
Tab6:CreateSection(" Training Zones")
if #trainingList>0 then
    Tab6:CreateDropdown({Name="Training Zone",Options=trainingList,CurrentOption={"Select"},MultipleOptions=false,
        Callback=function(opt) local zone=trainingData[opt[1]]; if zone then local cf=getCF(zone); if cf then flyTo(cf.Position,function() return true end) end end end})
else Tab6:CreateLabel("No training zones found.") end
Tab6:CreateSection(" NPC Teleport")
local npcFolder=workspace:FindFirstChild("NPCs")
if npcFolder then
    local npcList={}; for _, npc in pairs(npcFolder:GetChildren()) do table.insert(npcList,npc.Name) end
    if #npcList>0 then
        Tab6:CreateDropdown({Name="Select NPC",Options=npcList,CurrentOption={"Select"},MultipleOptions=false,
            Callback=function(opt) local npc=npcFolder:FindFirstChild(opt[1]); if npc then local cf=getCF(npc); if cf then flyTo(cf.Position,function() return true end) end end end})
    else Tab6:CreateLabel("No NPCs found.") end
else Tab6:CreateLabel("NPCs folder not found.") end

-- 
--   TAB 7 ALCHEMY  
-- 
local Tab7=Window:CreateTab(" Alchemy",4483362458)
local alchLblReq       = Tab7:CreateLabel(" Requirement: -")
local alchLblElem      = Tab7:CreateLabel(" Elements: -")
local alchLblHerbsUsed = Tab7:CreateLabel(" Herbs used: -")
local alchLblStatus    = Tab7:CreateLabel(" Status: Idle")
local alchLblBaseCheck = Tab7:CreateLabel(" Base Value: Select a recipe and year first.")

local function refreshAlchLbls()
    if not selectedRecipe or not ALCHEMY_RECIPES[selectedRecipe] then return end
    local r = ALCHEMY_RECIPES[selectedRecipe]
    local herbUsed = {}
    for _, element in ipairs(r.Elements) do
        table.insert(herbUsed, getBestHerbForElement(element))
    end
    alchLblHerbsUsed:Set(" Herbs: "..table.concat(herbUsed," | "))
    local total = calcRecipeBase(r, selectedAlchemyYear)
    if total < r.Base then
        alchLblBaseCheck:Set(string.format(" Base too low! Got ~%d, need %d",total,r.Base))
    else
        alchLblBaseCheck:Set(string.format(" Base OK: ~%d / %d required.",total,r.Base))
    end
end

Tab7:CreateSection(" Recipe")
Tab7:CreateDropdown({Name="Select Recipe",Options=recipeNames,CurrentOption={"Select"},MultipleOptions=false,
    Callback=function(opt)
        selectedRecipe=opt[1]; local r=ALCHEMY_RECIPES[selectedRecipe]
        if r then
            alchLblReq:Set(" Requirement: "..r.Requirement)
            alchLblElem:Set(" Elements: "..table.concat(r.Elements," | "))
            refreshAlchLbls()
        end
    end})

Tab7:CreateSection(" Select Herb per Element")
Tab7:CreateDropdown({Name="Earth herb",Options={"Taixian","Ginseng"},CurrentOption={"Taixian"},MultipleOptions=false,
    Callback=function(opt) selectedElementHerb["Earth"]=opt[1]; refreshAlchLbls() end})
Tab7:CreateDropdown({Name="Heaven herb",Options={"Moonlight Flower","Qilin Berries"},CurrentOption={"Moonlight Flower"},MultipleOptions=false,
    Callback=function(opt) selectedElementHerb["Heaven"]=opt[1]; refreshAlchLbls() end})
Tab7:CreateDropdown({Name="Yin herb",Options={"Yin Bush","Blood Flower","Twilight Bloom","Spirit Grass"},CurrentOption={"Yin Bush"},MultipleOptions=false,
    Callback=function(opt) selectedElementHerb["Yin"]=opt[1]; refreshAlchLbls() end})
Tab7:CreateDropdown({Name="Yang herb",Options={"Yang Flower","Lingzhi"},CurrentOption={"Yang Flower"},MultipleOptions=false,
    Callback=function(opt) selectedElementHerb["Yang"]=opt[1]; refreshAlchLbls() end})

Tab7:CreateSection(" Herb Year")
Tab7:CreateDropdown({Name="Herb Year to Use",Options=YEAR_DISPLAY_LIST,CurrentOption={"Thousand Year Old"},MultipleOptions=false,
    Callback=function(opt)
        local pick=opt[1]; selectedAlchemyYear=YEAR_TO_VARIATION[pick] or "Thousand"
        if selectedRecipe and ALCHEMY_RECIPES[selectedRecipe] then
            local r=ALCHEMY_RECIPES[selectedRecipe]; local total=calcRecipeBase(r,selectedAlchemyYear)
            if total<r.Base then
                alchLblBaseCheck:Set(string.format(" Base too low! Got ~%d, need %d. Craft will FAIL!",total,r.Base))
                Rayfield:Notify({Title=" Herb Year Too Low!",Content=string.format("%s needs base %d, herbs give ~%d. Will fail!",selectedRecipe,r.Base,total),Duration=5,Image=4483362458})
            else
                alchLblBaseCheck:Set(string.format(" Base OK: ~%d / %d required.",total,r.Base))
            end
            refreshAlchLbls()
        end
    end})

Tab7:CreateSection(" Amount")
Tab7:CreateDropdown({Name="Amount to Craft",Options={"1","2","5","25","100","1000"},CurrentOption={"1"},MultipleOptions=false,
    Callback=function(opt) alchemyCraftAmount=tonumber(opt[1]) or 1 end})

Tab7:CreateSection(" Craft")
Tab7:CreateButton({Name=" Craft Once",
    Callback=function()
        if not selectedRecipe then Rayfield:Notify({Title="Alchemy",Content="Please select a recipe first!",Duration=3,Image=4483362458}); return end
        if alchemyActive then Rayfield:Notify({Title="Alchemy",Content="Already crafting, please wait!",Duration=2,Image=4483362458}); return end
        local r=ALCHEMY_RECIPES[selectedRecipe]
        if r then
            local total=calcRecipeBase(r,selectedAlchemyYear)
            if total<r.Base then Rayfield:Notify({Title=" Base Value Too Low!",Content=string.format("Herbs give ~%d base but %s needs %d.",total,selectedRecipe,r.Base),Duration=6,Image=4483362458}); return end
        end
        alchemyActive=true
        task.spawn(function() runAlchemy(alchLblStatus,false) end)
    end})
Tab7:CreateToggle({Name=" Auto Craft (Repeats until stopped)",CurrentValue=false,
    Callback=function(val)
        if val then
            if not selectedRecipe then Rayfield:Notify({Title="Alchemy",Content="Please select a recipe first!",Duration=3,Image=4483362458}); return end
            local r=ALCHEMY_RECIPES[selectedRecipe]
            if r then
                local total=calcRecipeBase(r,selectedAlchemyYear)
                if total<r.Base then
                    Rayfield:Notify({Title=" Base Value Too Low!",Content=string.format("Herbs give ~%d base but %s needs %d.",total,selectedRecipe,r.Base),Duration=6,Image=4483362458}); return
                end
            end
            alchemyActive=true
            task.spawn(function() while alchemyActive do runAlchemy(alchLblStatus,true); if alchemyActive then task.wait(0.5) end end end)
            Rayfield:Notify({Title="Auto Craft ",Content="Auto crafting: "..selectedRecipe,Duration=3,Image=4483362458})
        else
            alchemyActive=false; alchLblStatus:Set(" Auto Craft Stopped")
            Rayfield:Notify({Title="Auto Craft ",Content="Stopped",Duration=2,Image=4483362458})
        end
    end})
Tab7:CreateButton({Name=" Stop Crafting",
    Callback=function() alchemyActive=false; alchLblStatus:Set(" Stopped"); Rayfield:Notify({Title="Alchemy",Content="Stopped",Duration=2,Image=4483362458}) end})

Tab7:CreateSection(" Recipe Reference")
Tab7:CreateParagraph({Title="Breakthrough Pill",  Content="Base:40 | Earth+Earth+Earth+Earth | Herbs: Ginseng x4"})
Tab7:CreateParagraph({Title="Restoration Pill",   Content="Base:50 | Earth+Earth+Earth+Yang | Herbs: Ginseng x3, Yang Flower x1"})
Tab7:CreateParagraph({Title="Health Pill",        Content="Base:80 | Yin+Earth+Yang+Earth | Herbs: Yin Bush, Ginseng, Yang Flower, Ginseng"})
Tab7:CreateParagraph({Title="Qi Pill",            Content="Base:80 | Heaven+Heaven+Earth+Yin | Herbs: Qilin Berries x2, Ginseng, Yin Bush"})
Tab7:CreateParagraph({Title="Molian Pill",        Content="Base:150 | Yin+Yin+Yang+Heaven | Herbs: Yin Bush x2, Yang Flower, Qilin Berries"})
Tab7:CreateParagraph({Title="Shulian Pill",       Content="Base:150 | Heaven x4 | Herbs: Qilin Berries x4"})
Tab7:CreateParagraph({Title="Dragon Pill",        Content="Base:250 | Earth+Heaven+Yin+Yang | Herbs: Ginseng, Qilin Berries, Yin Bush, Yang Flower"})
Tab7:CreateParagraph({Title="Tian Pill",          Content="Base:275 | Earth+Heaven+Heaven+Earth | Herbs: Ginseng, Qilin Berries x2, Ginseng"})
Tab7:CreateParagraph({Title="Soul Breakthrough",  Content="Base:300 | Yin+Yang+Yin+Yang | Herbs: Yin Bush, Yang Flower, Yin Bush, Yang Flower"})
Tab7:CreateParagraph({Title="Soul Energy Pill",   Content="Base:300 | Yin+Yin+Yang+Yang | Herbs: Yin Bush x2, Yang Flower x2"})
Tab7:CreateParagraph({Title="Soul Chance Pill",   Content="Base:400 | Yang+Yang+Yin+Yin | Herbs: Yang Flower x2, Yin Bush x2"})
Tab7:CreateParagraph({Title="Soul Cap Pill",      Content="Base:300 | Yang+Yin+Yang+Yin | Herbs: Yang Flower, Yin Bush, Yang Flower, Yin Bush"})

-- 
-- 
--   TAB 8 SETTINGS  
-- 
-- 
local Tab8=Window:CreateTab(" Settings",4483362458)

-- Anti-AFK — auto ON when script loads
local antiAfkEnabled = true
local antiAfkConnection = nil

local function startAntiAfk()
    if antiAfkConnection then antiAfkConnection:Disconnect() end
    
    -- Method 1: VirtualUser (legacy fallback)
    pcall(function()
        local vu = game:GetService("VirtualUser")
        Player.Idled:Connect(function()
            if antiAfkEnabled then
                vu:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
                task.wait(1)
                vu:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
            end
        end)
    end)
    
    -- Method 2: Character movement anti-AFK
    antiAfkConnection = RunService.Heartbeat:Connect(function()
        if antiAfkEnabled and Character and HRP then
            if tick() % 60 < 0.1 then
                pcall(function()
                    local currentPos = HRP.Position
                    HRP.CFrame = CFrame.new(currentPos + Vector3.new(0, 0.1, 0))
                    task.wait(0.05)
                    HRP.CFrame = CFrame.new(currentPos)
                end)
            end
        end
    end)
end

local function stopAntiAfk()
    if antiAfkConnection then antiAfkConnection:Disconnect(); antiAfkConnection=nil end
end

startAntiAfk() -- Auto start on load

Tab8:CreateSection(" Anti-AFK")
Tab8:CreateToggle({Name="Anti-AFK",CurrentValue=true,
    Callback=function(val)
        antiAfkEnabled=val
        if val then
            startAntiAfk()
            Rayfield:Notify({Title="Anti-AFK ",Content="Enabled",Duration=2,Image=4483362458})
        else
            stopAntiAfk()
            Rayfield:Notify({Title="Anti-AFK ",Content="Disabled",Duration=2,Image=4483362458})
        end
    end})

Tab8:CreateSection(" Fly Settings")
Tab8:CreateSlider({Name="Fly Speed (studs/sec)",Range={50,500},Increment=10,CurrentValue=150,
    Callback=function(val) flySpeed=val end})
Tab8:CreateSection(" General")
Tab8:CreateButton({Name=" Stop All Farms",
    Callback=function() stopAll(); Rayfield:Notify({Title="Stopped",Content="All farms stopped.",Duration=2,Image=4483362458}) end})
Tab8:CreateButton({Name=" Destroy GUI",
    Callback=function() stopAll(); stopAntiAfk(); Rayfield:Destroy() end})

-- ============================================================
-- WELCOME
-- ============================================================
Rayfield:Notify({
   Title="MELAYU-HUB",
   Content="Loaded by SIGMA.",
   Duration=6,
   Image=4483362458,
})
