<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>üî• Ultimate Murim Cultivator - Complete Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Cinzel',serif;background:#0a0512;color:#e8dcc8;overflow-x:hidden}
.particle{position:fixed;pointer-events:none;z-index:9999;animation:pf 2s ease-out forwards}
@keyframes pf{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-100px) scale(0.5)}}
.shake{animation:sk 0.3s}
@keyframes sk{0%,100%{transform:translate(0)}25%{transform:translate(-5px,5px)}75%{transform:translate(5px,-5px)}}
.fx{position:fixed;inset:0;pointer-events:none;z-index:9998;transition:opacity 0.2s}
.w{max-width:1600px;margin:0 auto;padding:10px}
.top{position:sticky;top:0;z-index:1000;background:rgba(10,5,18,0.95);backdrop-filter:blur(10px);padding:10px;border-radius:12px;margin-bottom:10px;border:1px solid rgba(255,215,0,0.2);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.qa{display:flex;gap:5px;flex-wrap:wrap}
.qab{padding:8px 12px;background:linear-gradient(135deg,#1a5c2e,#27ae60);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.3s}
.qab:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(39,174,96,0.5)}
.qab.blue{background:linear-gradient(135deg,#1a3a5c,#2e5c8e)}
.qab.purple{background:linear-gradient(135deg,#4a148c,#8e44ad)}
.h{background:linear-gradient(135deg,rgba(15,10,30,0.97),rgba(30,15,50,0.97));border-radius:16px;padding:16px;margin-bottom:10px;border:1px solid rgba(255,215,0,0.15);box-shadow:0 0 40px rgba(102,30,200,0.2)}
.ht{font-size:clamp(18px,3vw,28px);font-weight:900;text-align:center;background:linear-gradient(135deg,#ffd700,#ff8c00,#ffd700);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:sh 3s infinite;letter-spacing:2px;margin-bottom:12px}
@keyframes sh{0%,100%{background-position:0%}50%{background-position:100%}}
.td{text-align:center;font-size:14px;color:#a29bfe;margin-top:5px;text-shadow:0 0 10px rgba(162,155,254,0.5)}
.cp{background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(155,89,182,0.1));border:2px solid #00d4ff;border-radius:12px;padding:14px;margin-bottom:10px;position:relative;overflow:hidden}
.cp::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,212,255,0.2),transparent);animation:slide 3s infinite}
@keyframes slide{to{left:100%}}
.ch{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
.rd{font-size:20px;font-weight:900;color:#00d4ff;text-shadow:0 0 15px #00d4ff;letter-spacing:2px}
.qd{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.4);padding:8px 16px;border-radius:20px;border:1px solid #00d4ff}
.qv{font-size:18px;color:#00d4ff;font-weight:700}
.cpg{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.cpb{background:rgba(0,0,0,0.5);height:24px;border-radius:12px;overflow:hidden;border:1px solid #00d4ff;position:relative}
.cpf{background:linear-gradient(90deg,#00d4ff,#9b59b6);height:100%;border-radius:12px;transition:width 0.5s;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
.bb{padding:8px 20px;background:linear-gradient(135deg,#00d4ff,#9b59b6);border:1px solid #00d4ff;border-radius:8px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s;white-space:nowrap}
.bb:hover:not(:disabled){transform:scale(1.05);box-shadow:0 0 20px #00d4ff}
.bb:disabled{background:#333;border-color:#555;cursor:not-allowed;opacity:0.5}
.pb{display:flex;gap:10px;padding:10px;background:rgba(155,89,182,0.1);border-radius:12px;border:1px solid #9b59b6;margin-bottom:10px;overflow-x:auto}
.ps{width:60px;height:60px;background:rgba(0,0,0,0.6);border:2px solid rgba(155,89,182,0.3);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:28px;cursor:pointer;position:relative;transition:all 0.3s;flex-shrink:0}
.ps:hover:not(.lk){transform:scale(1.1);border-color:#9b59b6;box-shadow:0 0 15px #9b59b6}
.ps.ac{border-color:#ffd700;box-shadow:0 0 20px #ffd700;animation:pulse-glow 2s infinite}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 20px #ffd700}50%{box-shadow:0 0 30px #ffd700,0 0 40px rgba(255,215,0,0.5)}}
.ps.lk{opacity:0.3;cursor:not-allowed}
.pl{position:absolute;bottom:2px;right:2px;font-size:10px;background:rgba(0,0,0,0.8);padding:2px 4px;border-radius:4px;color:#ffd700;font-weight:700}
.sb{display:flex;gap:8px;padding:10px;background:rgba(0,0,0,0.4);border-radius:12px;border:1px solid rgba(255,215,0,0.15);margin-bottom:10px;flex-wrap:wrap}
.ss{width:50px;height:50px;background:rgba(0,0,0,0.6);border:2px solid rgba(255,215,0,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;position:relative;transition:all 0.3s}
.ss:hover:not(.lk):not(.cd){transform:scale(1.1);border-color:#00d4ff;box-shadow:0 0 15px #00d4ff}
.ss.lk{opacity:0.3;cursor:not-allowed}
.ss.cd{opacity:0.5}
.ss.rd{border-color:#00ff00;box-shadow:0 0 15px #00ff00;animation:pulse-ready 1s infinite}
@keyframes pulse-ready{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.scd{position:absolute;bottom:2px;right:2px;font-size:10px;background:rgba(0,0,0,0.8);padding:2px 4px;border-radius:4px;color:#ff4444;font-weight:700}
.ms{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:12px}
.sb2{background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.15);border-radius:10px;padding:10px 12px;text-align:center;transition:all 0.3s;cursor:pointer;position:relative}
.sb2:hover{border-color:rgba(255,215,0,0.5);transform:translateY(-2px);box-shadow:0 4px 15px rgba(255,215,0,0.15)}
.rg{position:absolute;top:5px;right:5px;font-size:9px;color:#38ef7d;font-weight:700}
.sl{font-size:11px;color:#8a7a6a;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.sv{font-size:clamp(13px,2vw,19px);font-weight:700;color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,0.4)}
.fr{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding:10px 14px;background:rgba(0,0,0,0.3);border-radius:10px;border:1px solid rgba(255,100,100,0.2);margin-bottom:8px}
.ft{font-size:clamp(12px,2vw,17px);font-weight:700}
.co{font-size:14px;color:#ff6b6b;text-shadow:0 0 10px rgba(255,107,107,0.5);transition:all 0.3s;min-width:120px;text-align:center}
.co.pop{animation:pop 0.4s}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.4)}100%{transform:scale(1)}}
.co.mg{font-size:20px;color:#ffd700;text-shadow:0 0 20px #ffd700}
.fb{font-size:13px;background:linear-gradient(135deg,#1a5c2e,#27ae60);border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:8px 16px;color:#fff;font-weight:700;cursor:pointer;transition:all 0.3s}
.fb:hover{transform:scale(1.05)}
.fb.on{background:linear-gradient(135deg,#7b1a1a,#c0392b);animation:pulse-on 1.5s infinite}
@keyframes pulse-on{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,0.5)}50%{box-shadow:0 0 0 8px rgba(231,76,60,0)}}
.pbar{background:rgba(255,255,255,0.08);height:22px;border-radius:11px;overflow:hidden;border:1px solid rgba(255,215,0,0.15);margin-top:8px;position:relative}
.pf{background:linear-gradient(90deg,#1a6b3c,#27ae60,#38ef7d);background-size:200%;height:100%;border-radius:11px;transition:width 0.4s;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;animation:sh 2s infinite}
.pi{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:10px;color:#8a7a6a;pointer-events:none}
.dr{display:flex;align-items:center;gap:10px;padding:8px 14px;background:rgba(0,0,0,0.3);border-radius:8px;border:1px solid rgba(255,100,100,0.2);margin-top:8px}
.dl{font-size:11px;color:#8a7a6a;text-transform:uppercase;letter-spacing:1px}
.dv2{font-size:16px;color:#ff6b6b;font-weight:700;min-width:70px}
.dg{flex:1;height:30px;display:flex;align-items:flex-end;gap:2px;overflow:hidden}
.ds{flex:1;background:rgba(255,107,107,0.55);border-radius:2px 2px 0 0;transition:height 0.3s;min-height:2px}
.ap{background:rgba(0,0,0,0.35);border:1px solid rgba(255,215,0,0.15);border-radius:12px;padding:12px 18px;margin-bottom:10px;display:flex;flex-wrap:wrap;align-items:center;gap:8px 18px}
.ap h4{font-size:11px;letter-spacing:2px;color:#8a7a6a;text-transform:uppercase;width:100%;margin-bottom:2px}
.at{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:13px;transition:all 0.25s}
.at:hover{transform:scale(1.05)}
.ts{width:42px;height:21px;background:#333;border-radius:11px;position:relative;transition:background 0.3s;border:1px solid rgba(255,255,255,0.1)}
.ts.on{background:#27ae60}
.ts::after{content:'';position:absolute;width:17px;height:17px;background:#fff;border-radius:50%;top:1px;left:1px;transition:left 0.3s}
.ts.on::after{left:22px}
.tb{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap;background:rgba(0,0,0,0.3);border-radius:12px;padding:7px;border:1px solid rgba(255,215,0,0.15)}
.t{flex:1;min-width:65px;padding:9px 6px;background:transparent;border:1px solid transparent;border-radius:7px;color:#8a7a6a;font-size:clamp(9px,1.2vw,12px);font-weight:700;cursor:pointer;transition:all 0.25s;letter-spacing:0.5px;white-space:nowrap}
.t:hover{color:#e8dcc8;background:rgba(255,215,0,0.05);border-color:rgba(255,215,0,0.15)}
.t.active{color:#ffd700;background:rgba(255,215,0,0.1);border-color:rgba(255,215,0,0.4);box-shadow:0 0 15px rgba(255,215,0,0.15)}
.cs{display:none}.cs.active{display:block}
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:12px}
.card{background:rgba(15,10,30,0.85);border:1px solid rgba(255,215,0,0.15);border-radius:14px;padding:17px;transition:all 0.3s;position:relative;overflow:hidden;backdrop-filter:blur(4px)}
.card:hover{transform:translateY(-4px);border-color:rgba(255,215,0,0.5);box-shadow:0 8px 30px rgba(255,215,0,0.12)}
.ci{font-size:34px;filter:drop-shadow(0 0 8px rgba(255,215,0,0.3))}
.ct{font-size:14px;font-weight:700}
.cs2{font-size:11px;color:#8a7a6a;margin-top:2px}
.cl{background:rgba(255,215,0,0.15);border:1px solid rgba(255,215,0,0.3);color:#ffd700;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700}
.ub{width:100%;padding:10px;background:linear-gradient(135deg,#1a3a1a,#27ae60);border:1px solid rgba(46,204,113,0.3);border-radius:8px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s;letter-spacing:0.5px;margin-top:8px}
.ub:hover:not(:disabled){background:linear-gradient(135deg,#27ae60,#38ef7d);transform:scale(1.02);box-shadow:0 4px 15px rgba(46,204,113,0.35)}
.ub:disabled{background:#1a1a1a;color:#555;cursor:not-allowed;border-color:#333}
.ub.max{padding:6px;background:linear-gradient(135deg,#8e44ad,#9b59b6);font-size:11px;margin-top:4px}
.ub.max:hover:not(:disabled){background:linear-gradient(135deg,#9b59b6,#bb6bd9)}
.ub.all{padding:6px;background:linear-gradient(135deg,#d35400,#e67e22);font-size:11px;margin-top:4px}
.ub.all:hover:not(:disabled){background:linear-gradient(135deg,#e67e22,#f39c12)}
.dv{background:rgba(0,0,0,0.6);border:2px solid rgba(255,215,0,0.2);border-radius:16px;padding:20px;min-height:300px;position:relative;overflow:hidden}
.de{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;min-height:260px;position:relative;z-index:2}
.e{font-size:36px;position:relative;cursor:pointer;transition:transform 0.2s;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.5));user-select:none}
.e:hover{transform:scale(1.15)}
.e.m{animation:ef 3s ease-in-out infinite}
.e.h{animation:eb 2s ease-in-out infinite}
.e.p{animation:ep 2s ease-in-out infinite;font-size:24px}
.e.tg{border:2px solid #ff4444;border-radius:50%;padding:4px}
@keyframes ef{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes eb{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes ep{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-10px) rotate(360deg)}}
.ehp{position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:38px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden}
.ehpf{height:100%;background:#e74c3c;border-radius:2px;transition:width 0.2s}
.ehpf.lw{background:#ff4444;animation:pls 0.5s infinite}
@keyframes pls{0%,100%{opacity:1}50%{opacity:0.6}}
.cr{position:absolute;font-family:'Cinzel',serif;font-size:16px;font-weight:900;color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,0.8);pointer-events:none;animation:cfa 1.2s ease-out forwards;z-index:200;white-space:nowrap}
.cr.big{color:#ff4444;font-size:20px;text-shadow:0 0 15px rgba(255,68,68,1)}
.cr.mega{color:#ffd700;font-size:28px;text-shadow:0 0 25px #ffd700;animation:mcr 1s ease-out forwards}
@keyframes mcr{0%{transform:translateY(0) scale(0.5);opacity:1}50%{transform:translateY(-30px) scale(1.5);opacity:1}100%{transform:translateY(-80px) scale(0.8);opacity:0}}
.cr.sk{color:#00d4ff;font-size:18px;text-shadow:0 0 15px #00d4ff}
@keyframes cfa{0%{transform:translateY(0) scale(0.8);opacity:1}30%{transform:translateY(-20px) scale(1.2);opacity:1}100%{transform:translateY(-60px) scale(0.6);opacity:0}}
.bl{background:rgba(0,0,0,0.5);border:1px solid rgba(255,215,0,0.15);border-radius:12px;padding:12px;height:130px;overflow-y:auto;font-size:13px;line-height:1.6;margin-top:10px;scrollbar-width:thin;scrollbar-color:rgba(255,215,0,0.2) transparent}
.bl::-webkit-scrollbar{width:4px}
.bl::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.2);border-radius:2px}
.le{animation:lf 0.3s;margin-bottom:2px}
@keyframes lf{from{opacity:0;transform:translateX(-8px)}to{opacity:1}}
.lk{color:#ff7675}.ll{color:#74b9ff}.lc{color:#fdcb6e;font-weight:600}.lb{color:#e17055;font-weight:700}.lf2{color:#55efc4}.lq{color:#a29bfe}.lski{color:#00d4ff;font-weight:700}
.md{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;animation:fadein 0.3s}
.md.show{display:flex}
@keyframes fadein{from{opacity:0}}
.mc{background:linear-gradient(135deg,rgba(15,10,30,0.98),rgba(30,15,50,0.98));border:2px solid #ffd700;border-radius:16px;padding:30px;max-width:600px;width:90%;animation:slidein 0.3s;max-height:80vh;overflow-y:auto}
@keyframes slidein{from{transform:translateY(-50px);opacity:0}}
.mt{font-size:24px;color:#ffd700;margin-bottom:20px;text-align:center}
.mb{margin-bottom:20px;line-height:1.8}
.mbs{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.mbn{padding:10px 30px;background:linear-gradient(135deg,#27ae60,#38ef7d);border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;transition:all 0.3s}
.mbn:hover{transform:scale(1.05)}
.mbn.s{background:linear-gradient(135deg,#555,#777)}
.nw{position:fixed;top:14px;right:14px;z-index:9999;display:flex;flex-direction:column;gap:7px;pointer-events:none;max-width:285px}
.nt{background:rgba(15,10,30,0.95);border-left:3px solid #ffd700;border-radius:0 10px 10px 0;padding:11px 15px;box-shadow:0 4px 20px rgba(0,0,0,0.5);animation:ni 0.4s ease;backdrop-filter:blur(8px);font-size:13px;pointer-events:auto}
.nt.nk{border-color:#e74c3c}.nt.nf{border-color:#27ae60}.nt.nb{border-color:#ff4444}.nt.nski{border-color:#00d4ff}.nt.nc{border-color:#e67e22}
.ntt{font-weight:700;font-size:13px;margin-bottom:2px}
@keyframes ni{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.eb{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:linear-gradient(135deg,rgba(15,10,30,0.98),rgba(30,15,50,0.98));border:3px solid #ffd700;border-radius:20px;padding:38px 55px;z-index:10000;text-align:center;box-shadow:0 0 60px rgba(255,215,0,0.4);animation:ep3 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;pointer-events:none}
@keyframes ep3{0%{transform:translate(-50%,-50%) scale(0) rotate(-5deg)}60%{transform:translate(-50%,-50%) scale(1.05) rotate(1deg)}100%{transform:translate(-50%,-50%) scale(1) rotate(0)}}
.eb h2{font-size:clamp(20px,4vw,34px);background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.eb p{font-size:17px;opacity:0.9}
@media(max-width:768px){.ms{grid-template-columns:1fr 1fr}.tb{gap:3px;padding:5px}.t{min-width:55px;padding:7px 4px;font-size:9px}.cg{grid-template-columns:1fr}}

/* QI BAR */
.qi-bar-wrap{background:rgba(0,0,0,0.5);border:1px solid rgba(0,212,255,0.3);border-radius:10px;padding:8px 14px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
.qi-bar-label{font-size:11px;color:#8a7a6a;letter-spacing:1px;text-transform:uppercase;white-space:nowrap}
.qi-bar-track{flex:1;height:18px;background:rgba(0,0,0,0.5);border-radius:9px;overflow:hidden;border:1px solid rgba(0,212,255,0.3)}
.qi-bar-fill{height:100%;border-radius:9px;transition:width 0.15s;background:linear-gradient(90deg,#1a6b8a,#00d4ff,#a29bfe);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;min-width:24px}
.qi-bar-fill.qi-full{background:linear-gradient(90deg,#00d4ff,#ffd700)!important;animation:qi-pulse 1s infinite}
@keyframes qi-pulse{0%,100%{box-shadow:0 0 8px #00d4ff}50%{box-shadow:0 0 20px #00d4ff,0 0 30px #ffd700}}
.qi-bar-val{font-size:13px;color:#00d4ff;font-weight:700;white-space:nowrap;min-width:100px;text-align:right}
/* WORLD BADGE */
.world-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,rgba(139,90,43,0.3),rgba(255,140,0,0.3));border:1px solid rgba(255,140,0,0.5);border-radius:20px;padding:4px 12px;font-size:12px;color:#ff8c00;font-weight:700;margin-left:10px}
/* BOSS */
.boss-banner{background:linear-gradient(135deg,rgba(200,0,0,0.2),rgba(100,0,200,0.2));border:2px solid #ff4444;border-radius:12px;padding:12px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden}
.boss-banner::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,68,68,0.1),transparent);animation:boss-scan 2s infinite}
@keyframes boss-scan{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.boss-icn{font-size:40px;animation:boss-float 2s ease-in-out infinite}
@keyframes boss-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px) scale(1.05)}}
.boss-info{flex:1}
.boss-nm{font-size:16px;font-weight:900;color:#ff4444;text-shadow:0 0 10px #ff4444;letter-spacing:2px}
.boss-hp-track{background:rgba(0,0,0,0.6);height:16px;border-radius:8px;overflow:hidden;border:1px solid #ff4444;margin-top:6px}
.boss-hp-fill{height:100%;border-radius:8px;transition:width 0.3s;background:linear-gradient(90deg,#8b0000,#ff4444,#ff6b6b);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff}
.boss-tmr{background:rgba(0,0,0,0.6);border:1px solid #ff8c00;border-radius:8px;padding:6px 12px;text-align:center;min-width:70px}
.boss-tmr-v{font-size:18px;font-weight:900;color:#ff8c00}
.boss-tmr-l{font-size:9px;color:#8a7a6a}
/* DUNGEON BREAK */
.db-alert{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(20,0,0,0.98),rgba(80,0,0,0.98));border:3px solid #ff0000;border-radius:16px;padding:30px 40px;z-index:11000;text-align:center;box-shadow:0 0 80px rgba(255,0,0,0.6);max-width:480px;width:90%}
.db-alert h2{font-size:28px;color:#ff0000;text-shadow:0 0 20px #ff0000;margin-bottom:10px;animation:db-flicker 0.5s infinite}
@keyframes db-flicker{0%,100%{opacity:1}50%{opacity:0.7}}
/* FLOOR TIMER */
.floor-te{font-size:12px;color:#ff8c00;display:flex;align-items:center;gap:6px}
.floor-te.danger{color:#ff4444;animation:ftd 0.5s infinite}
@keyframes ftd{0%,100%{opacity:1}50%{opacity:0.4}}
/* BREAKTHROUGH ANIM */
@keyframes bt-bolt{0%{opacity:0;transform:translate(-50%,-50%) scale(0.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.3)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) scale(2)}}
@keyframes bt-ring{0%{opacity:1;width:0;height:0;top:50%;left:50%}100%{opacity:0;width:600px;height:600px;top:calc(50% - 300px);left:calc(50% - 300px)}}
@keyframes bt-txt{0%{opacity:0;transform:translateX(-50%) scale(0.5)}30%{opacity:1;transform:translateX(-50%) scale(1.1)}80%{opacity:1}100%{opacity:0;transform:translateX(-50%) scale(0.9) translateY(-40px)}}
.bt-overlay{position:fixed;inset:0;z-index:12000;pointer-events:none}
.bt-bolt{position:absolute;top:50%;left:50%;font-size:140px;animation:bt-bolt 1.8s ease-out forwards}
.bt-ring{position:absolute;border:4px solid #00d4ff;border-radius:50%;animation:bt-ring 1.5s ease-out forwards}
.bt-txt{position:absolute;top:33%;left:50%;transform:translateX(-50%);font-size:clamp(22px,4vw,38px);font-weight:900;color:#00d4ff;text-shadow:0 0 30px #00d4ff,0 0 60px #a29bfe;animation:bt-txt 2s ease-out forwards;white-space:nowrap;font-family:'Cinzel',serif}
/* ITEM DROP ANIMS */
@keyframes item-popup-fly{0%{opacity:0;transform:translateY(0) scale(0.5)}20%{opacity:1;transform:translateY(-20px) scale(1.1)}80%{opacity:1;transform:translateY(-50px)}100%{opacity:0;transform:translateY(-90px) scale(0.8)}}
.item-popup-el{position:fixed;z-index:9500;pointer-events:none;animation:item-popup-fly 2.5s ease-out forwards}
@keyframes item-drop-in{0%{opacity:0;transform:translateY(-20px) scale(0.7) rotate(-5deg)}60%{transform:translateY(5px) scale(1.1) rotate(2deg)}100%{opacity:1;transform:translateY(0) scale(1) rotate(0)}}
@keyframes item-glow{0%,100%{box-shadow:0 0 8px rgba(255,215,0,0.3)}50%{box-shadow:0 0 20px rgba(255,215,0,0.7)}}
.item-new{animation:item-drop-in 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards}
/* QOL BAR */
.qol-bar{display:flex;gap:6px;flex-wrap:wrap;padding:8px;background:rgba(0,0,0,0.3);border-radius:10px;border:1px solid rgba(255,215,0,0.1);margin-bottom:8px;align-items:center}
.qol-btn{padding:6px 12px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,215,0,0.2);border-radius:6px;color:#e8dcc8;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.25s;font-family:'Cinzel',serif}
.qol-btn:hover{border-color:rgba(255,215,0,0.5);background:rgba(255,215,0,0.1);transform:scale(1.03)}
.qol-btn.spd-active{border-color:#a29bfe;background:rgba(162,155,254,0.15);color:#a29bfe}
/* BLACKSMITH */
.smith-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px;margin-bottom:16px}
.smith-card{background:linear-gradient(135deg,rgba(20,10,5,0.9),rgba(40,20,5,0.9));border:1px solid rgba(255,140,0,0.25);border-radius:14px;padding:16px;transition:all 0.3s}
.smith-card:hover{transform:translateY(-3px);border-color:rgba(255,140,0,0.5);box-shadow:0 6px 20px rgba(255,140,0,0.2)}
.forge-btn{width:100%;padding:10px;background:linear-gradient(135deg,#5c2a00,#c0651a);border:1px solid rgba(255,140,0,0.4);border-radius:8px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s;margin-top:8px}
.forge-btn:hover:not(:disabled){background:linear-gradient(135deg,#c0651a,#ff8c00);transform:scale(1.02);box-shadow:0 4px 15px rgba(255,140,0,0.4)}
.forge-btn:disabled{background:#1a1a1a;color:#555;cursor:not-allowed;border-color:#333}
.item-slot{background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.15);border-radius:8px;padding:8px;display:flex;align-items:center;gap:8px;margin-bottom:6px;transition:all 0.2s}
.item-slot.eq-slot{border-color:#ffd700;background:rgba(255,215,0,0.08)}
/* VILLAGE */
.vill-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:16px}
.vill-card{background:rgba(10,20,10,0.85);border:1px solid rgba(100,200,100,0.2);border-radius:14px;padding:16px;transition:all 0.3s}
.vill-card:hover{transform:translateY(-3px);border-color:rgba(100,200,100,0.5)}
.vill-card.dmg{border-color:rgba(255,68,68,0.5);background:rgba(30,5,5,0.85)}
.pop-b{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.4);padding:8px 14px;border-radius:20px;border:1px solid rgba(100,200,100,0.3)}
.pop-v{font-size:16px;color:#38ef7d;font-weight:700}
.vhp-bar{background:rgba(0,0,0,0.5);height:20px;border-radius:10px;overflow:hidden;border:1px solid rgba(100,200,100,0.3);margin-top:4px}
.vhp-fill{height:100%;border-radius:10px;transition:width 0.5s;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff}
.vlog{background:rgba(0,0,0,0.5);border:1px solid rgba(100,200,100,0.15);border-radius:10px;padding:10px;height:100px;overflow-y:auto;font-size:12px;line-height:1.7;margin-top:8px;scrollbar-width:thin}

/* === AFK POPUP === */
.afk-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(10,5,20,0.98),rgba(20,10,40,0.98));border:2px solid #ffd700;border-radius:20px;padding:30px 40px;z-index:13000;min-width:340px;max-width:92vw;text-align:center;box-shadow:0 0 60px rgba(255,215,0,0.3);animation:afk-in 0.4s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes afk-in{from{transform:translate(-50%,-50%) scale(0.6);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
.afk-title{font-size:clamp(18px,3vw,26px);font-weight:900;background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px;letter-spacing:2px}
.afk-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
.afk-stat{background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.15);border-radius:10px;padding:12px;text-align:center}
.afk-stat-v{font-size:18px;font-weight:700;color:#ffd700}
.afk-stat-l{font-size:10px;color:#8a7a6a;text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.afk-close{padding:12px 32px;background:linear-gradient(135deg,#27ae60,#38ef7d);border:none;border-radius:10px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;font-family:'Cinzel',serif;transition:all 0.3s;letter-spacing:1px}
.afk-close:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(46,204,113,0.4)}
/* === VILLAGE EVENTS === */
.vev-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;animation:vev-pulse 2s infinite}
.vev-badge.attack{background:rgba(255,68,68,0.2);border:1px solid #ff4444;color:#ff4444}
.vev-badge.trade{background:rgba(46,204,113,0.2);border:1px solid #27ae60;color:#38ef7d}
.vev-badge.discovery{background:rgba(162,155,254,0.2);border:1px solid #a29bfe;color:#a29bfe}
@keyframes vev-pulse{0%,100%{opacity:1}50%{opacity:0.6}}
.vev-container{background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.15);border-radius:12px;padding:12px;margin-bottom:12px}
.vev-row{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;border-radius:8px;transition:background 0.2s}
.vev-row:last-child{border-bottom:none}
.vev-row:hover{background:rgba(255,215,0,0.05)}
.vev-row.done{opacity:0.4;pointer-events:none}
/* === VILLAGE BUILDING ANIMATION === */
@keyframes build-shimmer{0%{left:-100%}100%{left:200%}}
.building-progress{position:relative;overflow:hidden}
.building-progress::after{content:'';position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);animation:build-shimmer 1.5s infinite}
/* === CITIZENS === */
.citizen-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:12px}
.citizen-card{background:rgba(0,0,0,0.4);border:1px solid rgba(100,200,100,0.2);border-radius:10px;padding:12px;text-align:center;transition:all 0.3s;position:relative}
.citizen-card:hover{border-color:rgba(100,200,100,0.5);transform:translateY(-2px)}
.citizen-card.busy{border-color:rgba(255,140,0,0.4)}
.citizen-busy-bar{height:4px;background:rgba(255,140,0,0.2);border-radius:2px;margin-top:6px;overflow:hidden}
.citizen-busy-fill{height:100%;background:linear-gradient(90deg,#ff8c00,#ffd700);border-radius:2px;transition:width 1s}
/* === VILLAGE HERO === */
.vhero-card{background:linear-gradient(135deg,rgba(15,30,15,0.9),rgba(10,20,10,0.9));border:2px solid rgba(100,200,100,0.3);border-radius:14px;padding:16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:all 0.3s}
.vhero-card:hover{border-color:rgba(100,200,100,0.6);transform:translateY(-2px)}
.vhero-card.deployed{border-color:#ffd700;box-shadow:0 0 15px rgba(255,215,0,0.2)}
/* === VILLAGE MISSIONS === */
.mission-card{background:rgba(0,0,0,0.4);border:1px solid rgba(162,155,254,0.2);border-radius:12px;padding:14px;margin-bottom:10px;transition:all 0.3s}
.mission-card:hover{border-color:rgba(162,155,254,0.4)}
.mission-card.active{border-color:#a29bfe;box-shadow:0 0 10px rgba(162,155,254,0.2);animation:mission-glow 2s infinite}
@keyframes mission-glow{0%,100%{box-shadow:0 0 10px rgba(162,155,254,0.2)}50%{box-shadow:0 0 20px rgba(162,155,254,0.4)}}
.mission-prog{height:8px;background:rgba(0,0,0,0.5);border-radius:4px;overflow:hidden;margin-top:8px;border:1px solid rgba(162,155,254,0.2)}
.mission-prog-fill{height:100%;background:linear-gradient(90deg,#4a148c,#a29bfe);border-radius:4px;transition:width 0.5s}
/* === NOTIFICATION UPGRADE === */
.nt.nvill{border-color:#38ef7d}
.nt.nafk{border-color:#ffd700;background:rgba(20,15,5,0.98)}
/* === TABS ADD-ON === */
.tab-badge{position:absolute;top:-4px;right:-4px;background:#ff4444;border-radius:50%;width:14px;height:14px;font-size:9px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}

/* === VILLAGE MAP === */
.vmap-wrap{position:relative;background:linear-gradient(135deg,#0a1a0a,#0d220d,#081408);border:2px solid rgba(100,200,100,0.2);border-radius:16px;overflow:hidden;margin-bottom:14px;min-height:320px}
.vmap-bg{position:absolute;inset:0;background-image:radial-gradient(circle at 20% 30%,rgba(0,80,0,0.15) 0%,transparent 40%),radial-gradient(circle at 80% 70%,rgba(0,60,0,0.1) 0%,transparent 40%);pointer-events:none}
.vmap-grid{display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(4,1fr);gap:6px;padding:12px;min-height:320px;position:relative;z-index:2}
.vmap-cell{background:rgba(0,30,0,0.4);border:1px solid rgba(100,200,100,0.08);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;position:relative;min-height:68px}
.vmap-cell:hover{border-color:rgba(100,200,100,0.4);background:rgba(0,50,0,0.6);transform:scale(1.04)}
.vmap-cell.built{background:rgba(0,40,0,0.7);border-color:rgba(100,200,100,0.3)}
.vmap-cell.built:hover{border-color:#38ef7d;box-shadow:0 0 12px rgba(56,239,125,0.3)}
.vmap-cell.building-anim{animation:vbuild 0.6s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes vbuild{0%{transform:scale(0) rotate(-10deg);opacity:0}70%{transform:scale(1.1) rotate(2deg)}100%{transform:scale(1) rotate(0);opacity:1}}
.vmap-cell.upgrading::after{content:'‚¨ÜÔ∏è';position:absolute;top:-8px;right:-8px;font-size:14px;animation:vupg 1s infinite}
@keyframes vupg{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
.vmap-cell.under-attack{animation:vattack 0.3s infinite}
@keyframes vattack{0%,100%{border-color:#ff4444}50%{border-color:#ff0000;box-shadow:0 0 15px rgba(255,68,68,0.6)}}
.vmap-cell-icon{font-size:clamp(20px,3vw,28px);filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5))}
.vmap-cell-name{font-size:9px;color:#8a7a6a;margin-top:3px;text-align:center;letter-spacing:0.5px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 4px}
.vmap-cell-lv{position:absolute;top:3px;right:5px;font-size:9px;color:#ffd700;font-weight:700}
.vmap-cell-prod{position:absolute;bottom:3px;left:50%;transform:translateX(-50%);font-size:9px;color:#38ef7d;font-weight:700;white-space:nowrap}
.vmap-cell-empty{font-size:18px;opacity:0.3;color:#38ef7d}
/* Floating resource gain */
@keyframes float-up{0%{opacity:1;transform:translateY(0) translateX(-50%)}100%{opacity:0;transform:translateY(-50px) translateX(-50%)}}
.float-res{position:absolute;left:50%;top:20%;pointer-events:none;font-size:12px;font-weight:700;color:#ffd700;animation:float-up 1.5s ease-out forwards;z-index:100;white-space:nowrap;text-shadow:0 0 6px rgba(255,215,0,0.8)}
/* Villager dots */
.villager-dot{position:absolute;width:8px;height:8px;border-radius:50%;border:1px solid rgba(0,0,0,0.5);transition:all 2s ease;z-index:10}
@keyframes villager-bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
/* Day/night overlay */
.day-night-overlay{position:absolute;inset:0;pointer-events:none;transition:background 3s ease;z-index:1;border-radius:14px}
/* Resource bar top of map */
.vmap-res-bar{display:flex;gap:8px;padding:8px 12px;background:rgba(0,0,0,0.6);border-bottom:1px solid rgba(100,200,100,0.15);flex-wrap:wrap;align-items:center}
.vmap-res{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,0.4);padding:4px 10px;border-radius:20px;border:1px solid rgba(255,215,0,0.15)}
.vmap-res-v{font-size:12px;font-weight:700;color:#ffd700}
.vmap-res-l{font-size:10px;color:#8a7a6a}
.vmap-res-rate{font-size:10px;color:#38ef7d}
/* Building info panel */
.vbuild-panel{background:linear-gradient(135deg,rgba(5,20,5,0.95),rgba(10,30,10,0.95));border:1px solid rgba(100,200,100,0.25);border-radius:12px;padding:14px;margin-bottom:12px;animation:panel-slide 0.2s ease-out}
@keyframes panel-slide{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.vbuild-panel h4{color:#38ef7d;font-size:14px;margin-bottom:8px}
/* Day/Night indicator */
.day-night-badge{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;transition:all 1s}
.day-night-badge.day{background:rgba(255,200,0,0.15);border:1px solid rgba(255,200,0,0.4);color:#ffd700}
.day-night-badge.night{background:rgba(100,100,200,0.15);border:1px solid rgba(100,100,200,0.4);color:#a29bfe}
/* Raid alert */
.raid-alert{position:absolute;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;background:rgba(150,0,0,0.25);border-radius:14px;animation:raid-pulse 0.5s infinite}
@keyframes raid-pulse{0%,100%{background:rgba(150,0,0,0.2)}50%{background:rgba(150,0,0,0.4)}}
/* Citizen walker */
@keyframes walk-lr{0%{left:10%}100%{left:85%}}
@keyframes walk-rl{0%{left:85%}100%{left:10%}}
.cwalker{position:absolute;bottom:20%;font-size:14px;animation:walk-lr 8s linear infinite;z-index:15;pointer-events:none;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.5))}
.cwalker:nth-child(2n){animation:walk-rl 10s linear infinite;bottom:35%}
.cwalker:nth-child(3n){animation:walk-lr 12s linear infinite;bottom:50%;animation-delay:-3s}

/* === SECT SYSTEM === */
.sect-wrap{background:linear-gradient(135deg,rgba(15,5,30,0.97),rgba(30,10,50,0.97));border:2px solid rgba(139,92,246,0.3);border-radius:16px;padding:16px;margin-bottom:12px}
.sect-rank-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:700;letter-spacing:1px}
.sect-rank-badge.outer{background:rgba(100,100,100,0.2);border:1px solid #666;color:#aaa}
.sect-rank-badge.inner{background:rgba(0,150,255,0.15);border:1px solid #0096ff;color:#74b9ff}
.sect-rank-badge.core{background:rgba(100,200,0,0.15);border:1px solid #64c800;color:#38ef7d}
.sect-rank-badge.elder{background:rgba(255,140,0,0.15);border:1px solid #ff8c00;color:#ffd700}
.sect-rank-badge.grand-elder{background:rgba(255,0,100,0.15);border:1px solid #ff006e;color:#ff6b9d}
.sect-rank-badge.sovereign{background:rgba(255,215,0,0.2);border:1px solid #ffd700;color:#ffd700;box-shadow:0 0 15px rgba(255,215,0,0.3)}
.sect-contrib-bar{background:rgba(0,0,0,0.5);height:20px;border-radius:10px;overflow:hidden;border:1px solid rgba(139,92,246,0.3);margin-top:8px}
.sect-contrib-fill{height:100%;background:linear-gradient(90deg,#4a148c,#7c3aed,#a78bfa);border-radius:10px;transition:width 0.5s;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
.sect-skill-card{background:rgba(0,0,0,0.4);border:1px solid rgba(139,92,246,0.2);border-radius:12px;padding:14px;margin-bottom:10px;transition:all 0.3s}
.sect-skill-card:hover{border-color:rgba(139,92,246,0.5);transform:translateY(-2px)}
.sect-skill-card.unlocked{border-color:#7c3aed;box-shadow:0 0 10px rgba(124,58,237,0.2)}
.sect-btn{padding:8px 16px;background:linear-gradient(135deg,#4a148c,#7c3aed);border:1px solid rgba(139,92,246,0.4);border-radius:8px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;font-family:'Cinzel',serif}
.sect-btn:hover:not(:disabled){background:linear-gradient(135deg,#7c3aed,#a78bfa);transform:scale(1.03)}
.sect-btn:disabled{background:#1a1a1a;color:#555;cursor:not-allowed;border-color:#333}
/* === DAO LAWS === */
.dao-wrap{background:linear-gradient(135deg,rgba(5,15,30,0.97),rgba(10,30,50,0.97));border:2px solid rgba(0,212,255,0.2);border-radius:16px;padding:16px;margin-bottom:12px}
.dao-node{background:rgba(0,0,0,0.5);border:2px solid rgba(0,212,255,0.15);border-radius:50%;width:70px;height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;position:relative;flex-shrink:0}
.dao-node:hover:not(.dao-locked){border-color:#00d4ff;box-shadow:0 0 15px rgba(0,212,255,0.3);transform:scale(1.08)}
.dao-node.dao-active{border-color:#ffd700;box-shadow:0 0 20px rgba(255,215,0,0.4);background:rgba(255,215,0,0.1)}
.dao-node.dao-locked{opacity:0.3;cursor:not-allowed}
.dao-node.dao-maxed{border-color:#38ef7d;box-shadow:0 0 15px rgba(56,239,125,0.3);background:rgba(56,239,125,0.08)}
.dao-path{display:flex;align-items:center;gap:4px;margin-bottom:20px;flex-wrap:nowrap;overflow-x:auto;padding:8px 0}
.dao-connector{width:24px;height:2px;background:rgba(0,212,255,0.2);flex-shrink:0}
.dao-connector.lit{background:linear-gradient(90deg,#00d4ff,#a29bfe)}
.dao-tree{display:flex;flex-direction:column;gap:16px}
.dao-row-label{font-size:11px;color:#8a7a6a;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.dao-pts-bar{display:flex;align-items:center;gap:10px;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.15);border-radius:10px;padding:8px 14px;margin-bottom:14px}
/* === TRIBULATION === */
.trib-wrap{position:fixed;inset:0;z-index:11500;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);animation:trib-in 0.3s ease}
@keyframes trib-in{from{opacity:0}to{opacity:1}}
.trib-box{background:linear-gradient(135deg,rgba(5,0,20,0.99),rgba(20,0,40,0.99));border:3px solid #7c3aed;border-radius:20px;padding:30px 40px;max-width:500px;width:90%;text-align:center;box-shadow:0 0 80px rgba(124,58,237,0.5)}
@keyframes lightning-flash{0%,90%,100%{opacity:0}92%,96%{opacity:1}94%,98%{opacity:0.5}}
.trib-lightning{animation:lightning-flash 2s infinite;position:absolute;inset:0;background:rgba(162,155,254,0.05);pointer-events:none;border-radius:16px}
.trib-hp-bar{background:rgba(0,0,0,0.6);height:24px;border-radius:12px;overflow:hidden;border:1px solid #7c3aed;margin:12px 0}
.trib-hp-fill{height:100%;background:linear-gradient(90deg,#4a148c,#7c3aed,#a78bfa);border-radius:12px;transition:width 0.3s;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
.trib-wave-badge{display:inline-block;background:rgba(124,58,237,0.2);border:1px solid #7c3aed;border-radius:20px;padding:4px 14px;font-size:12px;color:#a78bfa;margin-bottom:10px}

/* ===== DAILY QUESTS ===== */
.dq-card{background:rgba(0,0,0,0.45);border:1px solid rgba(162,155,254,0.2);border-radius:12px;padding:14px;margin-bottom:8px;transition:all 0.3s}
.dq-card.done{border-color:rgba(56,239,125,0.4);background:rgba(0,40,0,0.3)}
.dq-prog-bar{height:8px;background:rgba(0,0,0,0.5);border-radius:4px;margin-top:8px;overflow:hidden;border:1px solid rgba(162,155,254,0.15)}
.dq-prog-fill{height:100%;background:linear-gradient(90deg,#4a148c,#a29bfe);border-radius:4px;transition:width 0.4s}
.dq-timer{font-size:11px;color:#ff8c00;font-weight:700}
/* ===== SKILL TREE ===== */
.sk-tree-node{background:rgba(0,0,0,0.5);border:2px solid rgba(0,212,255,0.2);border-radius:12px;padding:12px;text-align:center;transition:all 0.3s;cursor:pointer;position:relative}
.sk-tree-node:hover{border-color:#00d4ff;transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,212,255,0.2)}
.sk-tree-node.unlocked{border-color:#00d4ff;background:rgba(0,50,80,0.5)}
.sk-tree-node.maxed{border-color:#ffd700;background:rgba(30,25,0,0.6)}
.sk-tree-node.locked{opacity:0.4;cursor:not-allowed}
.sk-node-tier{font-size:9px;color:#8a7a6a;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.sk-node-lv{position:absolute;top:4px;right:6px;font-size:10px;color:#ffd700;font-weight:700}
/* ===== ELEMENTAL ===== */
.el-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
.el-Fire{background:rgba(255,80,0,0.2);border:1px solid #ff5000;color:#ff8c00}
.el-Water{background:rgba(0,100,255,0.2);border:1px solid #0064ff;color:#74b9ff}
.el-Thunder{background:rgba(255,200,0,0.2);border:1px solid #ffc800;color:#ffd700}
.el-Wind{background:rgba(100,255,100,0.2);border:1px solid #64ff64;color:#38ef7d}
.el-Earth{background:rgba(150,100,50,0.2);border:1px solid #966432;color:#e17055}
.el-choice{background:rgba(0,0,0,0.5);border:2px solid transparent;border-radius:16px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s}
.el-choice:hover{transform:scale(1.05)}
/* ===== DUNGEON ROOMS ===== */
.room-banner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(10,5,25,0.97),rgba(20,10,40,0.97));border:2px solid;border-radius:16px;padding:24px 32px;z-index:300;text-align:center;max-width:380px;width:90%;animation:room-in 0.4s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes room-in{from{transform:translate(-50%,-55%) scale(0.8);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
.room-choice-btn{padding:10px 20px;margin:5px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,215,0,0.3);border-radius:8px;color:#e8dcc8;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s;font-family:'Cinzel',serif}
.room-choice-btn:hover{border-color:#ffd700;background:rgba(255,215,0,0.1);transform:scale(1.03)}
/* ===== COMBO MILESTONE ===== */
.combo-milestone-pop{position:fixed;top:30%;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(255,100,0,0.95),rgba(200,50,0,0.95));border:2px solid #ffd700;border-radius:14px;padding:16px 28px;z-index:9998;text-align:center;font-size:16px;font-weight:900;color:#fff;letter-spacing:2px;animation:milestone-pop 2s ease-out forwards;pointer-events:none;box-shadow:0 0 40px rgba(255,100,0,0.6)}
@keyframes milestone-pop{0%{opacity:0;transform:translateX(-50%) scale(0.5)}20%{opacity:1;transform:translateX(-50%) scale(1.1)}80%{opacity:1;transform:translateX(-50%) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-30px) scale(0.9)}}
/* ===== INSIGHT ===== */
.insight-flash{position:fixed;top:20%;right:20px;background:rgba(162,155,254,0.95);border:1px solid #a29bfe;border-radius:12px;padding:12px 16px;z-index:9997;max-width:240px;animation:insight-anim 3s ease-out forwards;pointer-events:none;box-shadow:0 0 20px rgba(162,155,254,0.4)}
@keyframes insight-anim{0%{opacity:0;transform:translateX(50px)}10%{opacity:1;transform:translateX(0)}80%{opacity:1}100%{opacity:0;transform:translateX(30px)}}
.insight-title{font-size:12px;font-weight:900;color:#0a0512;margin-bottom:3px;letter-spacing:1px}
.insight-body{font-size:11px;color:#1a0a30}
/* ===== AUCTION HOUSE ===== */
.auction-card{background:linear-gradient(135deg,rgba(20,10,40,0.9),rgba(10,5,20,0.9));border:1px solid rgba(255,215,0,0.2);border-radius:12px;padding:14px;transition:all 0.3s}
.auction-card:hover{border-color:rgba(255,215,0,0.5);transform:translateY(-2px)}
.auction-timer{font-size:20px;font-weight:900;color:#ff8c00;text-align:center}
.auction-timer.urgent{color:#ff4444;animation:tick 1s infinite}
@keyframes tick{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.bid-btn{padding:8px 16px;background:linear-gradient(135deg,#c0651a,#ff8c00);border:none;border-radius:8px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;font-family:'Cinzel',serif}
.bid-btn:hover{background:linear-gradient(135deg,#ff8c00,#ffd700);transform:scale(1.05)}
.bid-btn:disabled{background:#333;color:#555;cursor:not-allowed}
/* ===== RANKING ===== */
.rank-row{display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(0,0,0,0.4);border-radius:10px;margin-bottom:6px;border:1px solid rgba(255,215,0,0.1);transition:all 0.2s}
.rank-row:hover{border-color:rgba(255,215,0,0.3);background:rgba(255,215,0,0.05)}
.rank-num{font-size:18px;font-weight:900;min-width:32px;text-align:center}
.rank-num.gold{color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,0.5)}
.rank-num.silver{color:#c0c0c0}
.rank-num.bronze{color:#cd7f32}
/* ===== QOL TOOLTIP ===== */
.tooltip{position:relative}
.tooltip:hover::after{content:attr(data-tip);position:absolute;bottom:110%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:#e8dcc8;font-size:10px;padding:4px 8px;border-radius:6px;white-space:nowrap;z-index:999;border:1px solid rgba(255,215,0,0.2);pointer-events:none}
</style>
</head>
<body>
<div class="fx" id="fx"></div>
<div class="nw" id="nWrap"></div>
<div id="modal" class="md" onclick="if(event.target===this)hideModal()">
<div class="mc">
<div class="mt" id="mTitle"></div>
<div class="mb" id="mBody"></div>
<div class="mbs" id="mBtns"></div>
</div>
</div>
<div class="w">
<div class="top">
<div class="qa">
<button class="qab" onclick="maxAll()">‚ö° Max All</button>
<button class="qab blue" onclick="showCodex()">üìñ Codex</button>
<button class="qab purple" onclick="showAchievements()">üèÜ Achievements</button>
<button class="qab" onclick="autoSellItems()">üí∞ Auto-Sell</button>
<button class="qab" onclick="exportSave()">üíæ Export</button>
<button class="qab" onclick="importSave()">üì• Import</button>
<button class="qab" onclick="swTab('quests',document.querySelector('.t'))" style="background:linear-gradient(135deg,#4a148c,#8e44ad)">üìã Quests</button>
<button class="qab" onclick="spawnAuction()" style="background:linear-gradient(135deg,#5c2a00,#c0651a)">üèõÔ∏è Auction</button>
</div>
<div style="font-size:11px;color:#8a7a6a">‚ö° <span id="totalG">0</span> contribution | ‚è±Ô∏è <span id="sessionTime">0:00</span></div>
</div>
<div class="h">
<div class="ht">üî• ULTIMATE MURIM CULTIVATOR üî•</div>
<div class="td" id="titleD">The Nameless</div>
<div class="cp">
<div class="ch">
<div style="display:flex;align-items:center;flex-wrap:wrap;gap:8px"><div class="rd" id="realmD">MORTAL I</div><span class="world-badge" id="worldBadge">üåç World 1</span></div>
<div class="qd">
<span style="font-size:20px">‚ö°</span>
<div>
<div style="font-size:10px;color:#8a7a6a">QI ENERGY</div>
<div class="qv"><span id="qiC">0</span>/<span id="qiM">100</span></div>
</div>
</div>
</div>
<div class="cpg">
<div class="cpb"><div class="cpf" id="cultP" style="width:0%">0%</div></div>
<button class="bb" id="btBtn" onclick="breakthrough()">BREAKTHROUGH</button>
</div>
</div>
<div class="qi-bar-wrap"><div class="qi-bar-label">‚ö° Qi Flow</div><div class="qi-bar-track"><div class="qi-bar-fill" id="qiBarFill" style="width:0%">0%</div></div><div class="qi-bar-val" id="qiBarVal">0 / 100</div></div>
<div class="boss-banner" id="bossBanner" style="display:none"><div class="boss-icn" id="bossIcon">üëπ</div><div class="boss-info"><div class="boss-nm" id="bossName">BOSS: ???</div><div style="font-size:11px;color:#8a7a6a;margin-top:2px" id="bossDesc">Defeat!</div><div class="boss-hp-track"><div class="boss-hp-fill" id="bossHpFill" style="width:100%">100%</div></div></div><div class="boss-tmr"><div class="boss-tmr-v" id="bossTimerVal">60</div><div class="boss-tmr-l">SECONDS</div></div></div>
<div class="pb" id="petBar"></div>
<div class="sb" id="skillsBar"></div>
<div class="ms">
<div class="sb2" onclick="showStats('gold')">
<div class="sl">üí∞ Gold/s</div>
<div class="sv" id="sGps">0</div>
<div class="rg" id="goldG">+0</div>
</div>
<div class="sb2" onclick="showStats('gold')"><div class="sl">üíé Gold</div><div class="sv" id="sGold">0</div></div>
<div class="sb2" onclick="showStats('kills')"><div class="sl">üíÄ Kills</div><div class="sv" id="sKills">0</div></div>
<div class="sb2" onclick="showStats('sect')"><div class="sl">üèØ Sect Rank</div><div class="sv" id="sSectRank">Outer</div></div>
<div class="sb2"><div class="sl">üêâ Pet Pow</div><div class="sv" id="sPetP">0</div></div>
<div class="sb2" onclick="showStats('dps')"><div class="sl">‚ö° DPS</div><div class="sv" id="sDps">0</div></div>
</div>
<div class="fr">
<div class="ft">üåê W<span id="cWorld">1</span> | üè∞ Floor <span id="cFloor">1</span>/1000 ‚Äî <span id="cBiome">DARK CAVES</span></div><div class="floor-te" id="floorTE">‚è±Ô∏è <span id="floorTV">--</span>s</div>
<div class="co" id="comboEl"></div>
<button class="fb" id="farmBtn" onclick="toggleFarm()">üåæ Farm: OFF</button>
<button class="qab blue" onclick="quickProgress()">‚ö° Quick</button>
</div>
<div class="pbar">
<div class="pf" id="fProg" style="width:0%">0%</div>
<div class="pi" id="pbarInfo"></div>
</div>
<div class="dr">
<div class="dl">BATTLE DPS</div>
<div class="dv2" id="dpsV">0</div>
<div class="dg" id="dpsG"></div>
</div>
</div>
<div class="ap">
<h4>ü§ñ AUTOMATION & SETTINGS</h4>
<div class="at" onclick="toggleAuto('collect')"><div class="ts on" id="ta-collect"></div><span>Auto-Collect</span></div>
<div class="at" onclick="toggleAuto('upgrade')"><div class="ts" id="ta-upgrade"></div><span>Auto-Upgrade</span></div>
<div class="at" onclick="toggleAuto('breakthrough')"><div class="ts" id="ta-break"></div><span>Auto-Breakthrough</span></div>
<div class="at" onclick="toggleAuto('skills')"><div class="ts on" id="ta-skills"></div><span>Auto-Skills</span></div>
<div class="at" onclick="toggleSet('smart')"><div class="ts on" id="ts-smart"></div><span>Smart Target</span></div>
<div class="at" onclick="toggleSet('fx')"><div class="ts on" id="ts-fx"></div><span>Visual FX</span></div>
<div class="at" onclick="toggleSet('sound')"><div class="ts" id="ts-sound"></div><span>Sound FX</span></div>
</div>
<div class="qol-bar"><span style="font-size:11px;color:#8a7a6a">‚öôÔ∏è QOL:</span><button class="qol-btn spd-active" id="spd1" onclick="setGameSpeed(1)">1√ó</button><button class="qol-btn" id="spd2" onclick="setGameSpeed(2)">2√ó</button><button class="qol-btn" id="spd5" onclick="setGameSpeed(5)">5√ó</button><button class="qol-btn" onclick="resetFloorTimer()">üîÑ Reset Timer</button><button class="qol-btn" onclick="rushBoss()">‚öîÔ∏è Rush Boss</button><button class="qol-btn" onclick="collectGold()">üí∞ Collect Gold</button><button class="qol-btn" onclick="swTab('blacksmith',{classList:{add:function(){},remove:function(){}}})">üéí Item Bag</button><button class="qol-btn" onclick="autoEquipBest()">‚öîÔ∏è Auto-Equip</button><button class="qol-btn" onclick="disenchantAll()">‚ö´ Disenchant</button></div>
<div class="tb">
<button class="t active" onclick="swTab('dungeon',this)">üè∞ Dungeon</button>
<button class="t" onclick="swTab('cultivation',this)">‚ö° Cultivation</button>
<button class="t" onclick="swTab('pets',this)">üêâ Pets</button>
<button class="t" onclick="swTab('weapons',this)">‚öîÔ∏è Weapons</button>
<button class="t" onclick="swTab('monsters',this)">üëæ Monsters</button>
<button class="t" onclick="swTab('heroes',this)">‚öîÔ∏è Heroes</button>
<button class="t" onclick="swTab('titles',this)">üé≠ Titles</button>
<button class="t" onclick="swTab('blacksmith',this)">‚öíÔ∏è Blacksmith</button>
<button class="t" onclick="swTab('village',this)">üèòÔ∏è Village</button>
<button class="t" onclick="swTab('quests',this)">üìã Quests</button>
<button class="t" onclick="swTab('skillTree',this)">üîÆ Skills</button>
<button class="t" onclick="swTab('auction',this)">üèõÔ∏è Auction</button>
<button class="t" onclick="swTab('ranking',this)">üèÜ Ranking</button>
<button class="t" onclick="swTab('sect',this)">üèØ Sect</button>
<button class="t" onclick="swTab('daolaws',this)">‚òØÔ∏è Dao Laws</button>
</div>
<div id="dungeon" class="cs active">
<div class="dv"><div class="de" id="dEntities"></div></div>
<div class="bl" id="bLog"><div class="le" style="color:#ffd700">‚öîÔ∏è Your cultivation journey begins, young master...</div></div>
</div>
<div id="cultivation" class="cs"><div id="cultContent"></div></div>
<div id="pets" class="cs"><div id="petsContent"></div></div>
<div id="weapons" class="cs"><div id="weaponsContent"></div></div>
<div id="monsters" class="cs"><div class="cg" id="mCards"></div></div>
<div id="heroes" class="cs"><div class="cg" id="hCards"></div></div>
<div id="titles" class="cs"><div id="titlesContent"></div></div>
<div id="blacksmith" class="cs"><div id="smithContent"></div></div>
<div id="village" class="cs"><div id="villageContent"></div></div>
<div id="sect" class="cs"><div id="sectContent"></div></div>
<div id="daolaws" class="cs"><div id="daoContent"></div></div>
<div id="quests" class="cs"><div id="questsContent"></div></div>
<div id="skillTree" class="cs"><div id="skillTreeContent"></div></div>
<div id="auction" class="cs"><div id="auctionContent"></div></div>
<div id="ranking" class="cs"><div id="rankingContent"></div></div>
</div>
</div>
<script>
const GD={
realms:[
{n:'MORTAL',m:1,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'QI GATHERING',m:2,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'FOUNDATION',m:4,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'CORE FORMATION',m:8,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'NASCENT SOUL',m:16,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'SPIRIT SEVERING',m:32,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'VOID TRIBULATION',m:64,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'DAO SEEKING',m:128,stages:['I','II','III','IV','V','VI','VII','VIII','IX']},
{n:'IMMORTAL ASCENSION',m:256,stages:['I','II','III','IV','V','VI','VII','VIII','IX']}
],
skills:{
blast:{n:'Qi Blast',e:'üî•',c:20,cd:5,dmg:50,aoe:true,fx:'fire'},
lightning:{n:'Lightning Strike',e:'‚ö°',c:30,cd:8,dmg:150,aoe:false,fx:'lightning'},
heal:{n:'Heavenly Heal',e:'üíö',c:25,cd:10,heal:200,fx:'heal'},
tempest:{n:'Void Tempest',e:'üå™Ô∏è',c:40,cd:12,dmg:100,hits:3,fx:'wind'},
ascend:{n:'Divine Buff',e:'‚ú®',c:50,cd:30,buff:2,fx:'divine'}
},
pets:{
phoenix:{n:'Phoenix',e:'üî•',p:10,c:1000,u:true},
dragon:{n:'Dragon',e:'üêâ',p:25,c:5000,u:false},
tiger:{n:'Tiger',e:'üêØ',p:15,c:2500,u:false},
turtle:{n:'Turtle',e:'üê¢',p:8,c:1500,u:false},
lion:{n:'Lion',e:'ü¶Å',p:20,c:4000,u:false},
eagle:{n:'Eagle',e:'ü¶Ö',p:12,c:2000,u:false}
},
weapons:{
sword:{n:'Sword',e:'‚öîÔ∏è',dmg:1.2,m:0},
spear:{n:'Spear',e:'üî±',dmg:1.15,m:0},
axe:{n:'Axe',e:'ü™ì',dmg:1.3,m:0},
bow:{n:'Bow',e:'üèπ',dmg:1.1,m:0},
staff:{n:'Staff',e:'üîÆ',dmg:1.25,m:0},
fist:{n:'Fist',e:'üëä',dmg:1.0,m:0}
},
titles:{
nameless:{n:'The Nameless',b:0},
slayer:{n:'Monster Slayer',b:10,req:100},
master:{n:'Dungeon Master',b:25,req:1000},
immortal:{n:'Immortal Cultivator',b:50,req:10000},
god:{n:'God of War',b:100,req:50000}
},
monsters:{
bat:{lv:1,sr:4,dr:1,c:100,e:'ü¶á'},zombie:{lv:0,sr:2.5,dr:2,c:500,e:'üßü'},ghost:{lv:0,sr:1.8,dr:3,c:2000,e:'üëª'},spider:{lv:0,sr:3,dr:1.5,c:5000,e:'üï∑Ô∏è'},wolf:{lv:0,sr:2,dr:4,c:15000,e:'üê∫'},troll:{lv:0,sr:1.2,dr:10,c:50000,e:'üßå'},dragon:{lv:0,sr:0.5,dr:50,c:200000,e:'üêâ'},demon:{lv:0,sr:0.3,dr:100,c:1000000,e:'üëπ'},wraith:{lv:0,sr:0.8,dr:30,c:80000,e:'üëÅÔ∏è'},golem:{lv:0,sr:0.4,dr:70,c:300000,e:'üóø'},banshee:{lv:0,sr:1,dr:20,c:40000,e:'üå´Ô∏è'},harpy:{lv:0,sr:1.5,dr:8,c:20000,e:'ü¶Ö'},hydra:{lv:0,sr:0.2,dr:200,c:2000000,e:'üêç'},cerberus:{lv:0,sr:0.15,dr:300,c:5000000,e:'üêï'},lich:{lv:0,sr:0.1,dr:500,c:10000000,e:'üíÄ'}
},
heroes:{
warrior:{lv:1,p:5,ar:1.2,c:200,e:'‚öîÔ∏è'},archer:{lv:0,p:12,ar:1.5,c:1000,e:'üèπ'},mage:{lv:0,p:20,ar:1,c:5000,e:'üßô'},tank:{lv:0,p:8,ar:0.8,c:15000,e:'üõ°Ô∏è'},assassin:{lv:0,p:30,ar:2,c:50000,e:'üó°Ô∏è'},paladin:{lv:0,p:35,ar:1.3,c:200000,e:'‚ú®'},necro:{lv:0,p:40,ar:1.1,c:500000,e:'üíÄ'},berserk:{lv:0,p:50,ar:1.8,c:1000000,e:'ü™ì'},monk:{lv:0,p:45,ar:1.6,c:2000000,e:'üßò'},summoner:{lv:0,p:60,ar:1.0,c:5000000,e:'üåü'},dragonknight:{lv:0,p:80,ar:1.4,c:20000000,e:'üêâ'},soulblade:{lv:0,p:100,ar:1.7,c:100000000,e:'‚ö°'},voidwalker:{lv:0,p:150,ar:2.0,c:500000000,e:'‚ö´'},celestialsage:{lv:0,p:200,ar:1.2,c:2000000000,e:'‚òÄÔ∏è'},daoanchor:{lv:0,p:500,ar:0.8,c:10000000000,e:'üåå'}
},
biomes:[
{f:[1,50],n:'DARK CAVES',b:'ü¶á Bat King'},{f:[51,100],n:'SPIDER CATACOMBS',b:'üï∑Ô∏è Spider Queen'},
{f:[101,150],n:'HAUNTED CRYPTS',b:'üëª Phantom Lord'},{f:[151,200],n:'VOLCANIC DEPTHS',b:'üî• Magma Titan'},
{f:[201,250],n:'FROZEN WASTELAND',b:'‚ùÑÔ∏è Ice Wyrm'},{f:[251,300],n:'STORM CITADEL',b:'‚ö° Storm Dragon'},
{f:[301,350],n:'VOID DIMENSION',b:'‚ö´ Void Entity'},{f:[351,400],n:'HELL GATES',b:'üòà Demon King'},
{f:[401,450],n:'NECROPOLIS',b:'üíÄ Lich Emperor'},{f:[451,500],n:'FINAL ASCENSION',b:'üëø Dark God'},
{f:[501,550],n:'SPIRIT PLAINS',b:'üëë Soul Sovereign'},{f:[551,600],n:'VOID ABYSS',b:'‚ö´ Void Emperor'},
{f:[601,650],n:'CELESTIAL REALM',b:'‚ú® Star God'},{f:[651,700],n:'PRIMORDIAL SEA',b:'üåä Sea Emperor'},
{f:[701,750],n:'ANCIENT RUINS',b:'üóø Ancient One'},{f:[751,800],n:'SHADOW KINGDOM',b:'üëë Shadow King'},
{f:[801,850],n:'DIVINE MOUNTAIN',b:'üèîÔ∏è Mountain God'},{f:[851,900],n:'DEMON PALACE',b:'üëπ Demon Emperor'},
{f:[901,950],n:'HEAVENLY THRONE',b:'‚òÄÔ∏è Heaven Lord'},{f:[951,1000],n:'DAO REALM',b:'üåå Dao God'}
],
achievements:[
{id:'fk',n:'First Blood',e:'ü©∏',d:'Kill first monster',req:()=>GS.mk>=1},
{id:'k100',n:'Slayer',e:'‚öîÔ∏è',d:'Kill 100 monsters',req:()=>GS.mk>=100},
{id:'k1k',n:'Butcher',e:'üó°Ô∏è',d:'Kill 1,000 monsters',req:()=>GS.mk>=1000},
{id:'k10k',n:'Executioner',e:'üíÄ',d:'Kill 10,000 monsters',req:()=>GS.mk>=10000},
{id:'f10',n:'Delver',e:'üïØÔ∏è',d:'Reach Floor 10',req:()=>GS.cf>=10},
{id:'f50',n:'Abyss Walker',e:'üåë',d:'Reach Floor 50',req:()=>GS.cf>=50},
{id:'f100',n:'Dungeon Master',e:'üëë',d:'Reach Floor 100',req:()=>GS.cf>=100},
{id:'r5',n:'Cultivator',e:'‚ö°',d:'Reach QI GATHERING',req:()=>GS.realm>=1},
{id:'r9',n:'Immortal',e:'‚ú®',d:'Reach IMMORTAL ASCENSION',req:()=>GS.realm>=8},
{id:'f500',n:'World Beater',e:'üåç',d:'Reach Floor 500',req:()=>GS.cf>=500},
{id:'f1000',n:'Dao Conqueror',e:'üåå',d:'Reach Floor 1000',req:()=>GS.cf>=1000},
{id:'w2',n:'World Traveler',e:'üåê',d:'Enter World 2',req:()=>GS.worldUnlocked>=2},
{id:'boss1',n:'Boss Slayer',e:'üí™',d:'Kill first boss',req:()=>(GS.bossKills||0)>=1},
{id:'db1',n:'Survivor',e:'üõ°Ô∏è',d:'Survive Dungeon Break',req:()=>(GS.dbSurvived||0)>=1},
{id:'vill1',n:'Village Chief',e:'üèòÔ∏è',d:'Build first structure',req:()=>(GS.villBuilt||0)>=1},
{id:'item1',n:'Collector',e:'üéí',d:'Get first item drop',req:()=>GS.itemBag.length>=1}
]
};

const GS={
gold:0,de:0,mk:0,cf:1,fp:0,pc:0,tge:0,fm:false,contribution:0,am:[],ah:[],ap:[],combo:0,mc:0,lkt:0,
cworld:1,worldUnlocked:1,bossActive:false,bossHp:0,bossMaxHp:0,bossTimer:0,bossData:null,bossKills:0,
floorTimer:0,dbActive:false,dbTimer:0,dbSurvived:0,gameSpeed:1,
itemBag:[],equipped:{weapon:null,armor:null,ring:null,amulet:null,boots:null,helm:null},smithMats:{iron:0,essence:0,crystal:0},
village:{wall:0,barracks:0,farm:0,market:0,shrine:0,hospital:0,forge:0,watchtower:0},villagePop:10,villageMaxPop:20,villageHp:100,villageMaxHp:100,villageLog:[],villBuilt:0,
realm:0,stage:0,cp:0,qi:100,qiMax:100,scd:{},sbuff:1,sbuffT:0,
activePet:null,petLvl:{},activeWpn:'sword',activeTitle:'nameless',
settings:{smartTarget:true,autoSkills:true,fx:true,sound:false},
targetIdx:-1,cdps:0,dh:[],lastGold:0,goldGain:0,sessionStart:Date.now(),
ac:true,au:false,ap:false,abreak:false,askills:true,
achievements:new Set(),
element:null,elementChosen:false,
skills_lv:{blast:0,lightning:0,heal:0,tempest:0,ascend:0},skillPoints:0,
dailyQuests:[],dailyReset:0,dailyDone:0,
insights:[],insightTotal:0,insightBonus:0,
comboMilestones:{100:false,500:false,1000:false,5000:false},
auctionItems:[],auctionTimer:0,auctionActive:false,
rankingBoard:[],
dungeonRoom:null,
pendingAFK:null,
citizens:[],missions:[],missionProgress:{},vheroes:[],vevents:[],totalAFKTime:0,
lastSaveTime:0
};

const fmt=n=>{if(n>=1e15)return(n/1e15).toFixed(2)+'Qa';if(n>=1e12)return(n/1e12).toFixed(2)+'T';if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(2)+'M';if(n>=1e3)return(n/1e3).toFixed(2)+'K';return Math.floor(n)};
const mult=()=>1;
const cultMult=()=>GD.realms[GS.realm]?.m||1;
const wpnMult=()=>GD.weapons[GS.activeWpn]?.dmg||1;
const petMult=()=>{if(!GS.activePet)return 1;const p=GD.pets[GS.activePet];const lv=GS.petLvl[GS.activePet]||1;return 1+(p.p*lv)/100;};
const titleMult=()=>{const t=GD.titles[GS.activeTitle];return 1+(t?.b||0)/100;};
const totalMult=()=>mult()*cultMult()*wpnMult()*petMult()*titleMult()*itemMult();
const rk=()=>Math.max(10,Math.floor(50+GS.cf*10));
const biome=f=>GD.biomes.find(b=>f>=b.f[0]&&f<=b.f[1])||GD.biomes[0];

function createParticles(x,y,count,color){
if(!GS.settings.fx)return;
for(let i=0;i<count;i++){
const p=document.createElement('div');
p.className='particle';
p.style.left=x+'px';
p.style.top=y+'px';
p.style.color=color;
p.textContent=['‚ú®','‚≠ê','üí´','‚ú¶'][Math.floor(Math.random()*4)];
document.body.appendChild(p);
setTimeout(()=>p.remove(),2000);
}
}

function screenFlash(c){
if(!GS.settings.fx)return;
const fx=document.getElementById('fx');
fx.style.background=c;
fx.style.opacity='0.3';
setTimeout(()=>fx.style.opacity='0',200);
}

function screenShake(){
if(!GS.settings.fx)return;
document.body.classList.add('shake');
setTimeout(()=>document.body.classList.remove('shake'),300);
}

function skillFX(type){
if(!GS.settings.fx)return;
switch(type){
case 'fire':screenFlash('rgba(255,100,0,0.5)');break;
case 'lightning':screenShake();screenFlash('rgba(100,200,255,0.5)');break;
case 'heal':screenFlash('rgba(0,255,100,0.3)');break;
case 'wind':screenFlash('rgba(200,100,255,0.3)');break;
case 'divine':screenFlash('rgba(255,215,0,0.4)');screenShake();break;
}
}

function init(){
loadGame();
if(!GS.petLvl.phoenix)GS.petLvl.phoenix=1;
renderSkills();
renderAll();
startLoop();
startDpsGraph();
}

function renderAll(){
renderM();
renderH();
renderCult();
renderPets();
renderWpns();
renderTitles();
updateUI();
// render whichever tab is currently active
const activeTab=document.querySelector('.cs.active');
if(activeTab){
const id=activeTab.id;
if(id==='dungeon')   renderDungeon();
if(id==='village')   renderVillage();
if(id==='blacksmith')renderBlacksmith();
if(id==='sect')      renderSect();
if(id==='daolaws')   renderDaoLaws();
if(id==='quests')    renderQuests();
if(id==='skillTree') renderSkillTree();
if(id==='auction')   renderAuction();
if(id==='ranking')   renderRanking();
}
}

let lt=0;
function itemMult(){
let bonus=1;
const slots=['weapon','armor','ring','amulet','boots','helm'];
slots.forEach(function(s){
const eq=GS.equipped[s];
if(eq&&eq.stat){
const val=parseFloat(eq.val)||0;
if(eq.stat==='dmg'||eq.stat==='all')bonus+=val;
}
});
// Elemental bonus
const _el_=GS.element&&typeof ELEMENTS!=='undefined'?ELEMENTS[GS.element]:null;
const _elB_=_el_?(1+(_el_.bonusDmg||0)):1;
// Insight bonus
const _insB_=1+(GS.insightBonus||0);
// Sect + Dao bonus
const _sb_=typeof sectBonusMult==='function'?sectBonusMult():1;
const _db_=typeof getDaoBonus==='function'?getDaoBonus():{dmg:0,dmg_big:0};
const _dmB_=(1+(_db_.dmg||0))*(1+((_db_.dmg_big)||0));
return bonus*_elB_*_insB_*_sb_*_dmB_;
}

function killM(m,idx){
const now=Date.now();
let g=m.dr*(1+GS.cf*0.2)*totalMult();

if(now-GS.lkt<3000){
GS.combo++;
if(GS.combo>GS.mc)GS.mc=GS.combo;
}else{
GS.combo=1;
}
GS.lkt=now;

g*=1+(GS.combo-1)*0.02;

// Dao gold bonus
const _dkb_=getDaoBonus();
if((_dkb_.gold_kill||0)>0){const _ex_=m.dr*_dkb_.gold_kill;g+=_ex_;}

GS.gold+=g;
GS.tge=(GS.tge||0)+g;
GS.mk++;
GS.contribution=(GS.contribution||0)+g;

if(!GS.fm)GS.fp++;

if(Math.random()<0.2)spawnCrit('+'+fmt(g),'');

GS.am.splice(idx,1);

if(GS.activeWpn)GD.weapons[GS.activeWpn].m+=0.01;

if(!GS.fm)chkFloor();
updCombo();
dropMats(GS.cf);

// Dao/sect checks
checkDaoPoints();
checkSectPoints();

// Combo milestones
checkComboMilestone();

// Cultivation insight (rare)
if(Math.random()<0.003+GS.cf*0.0001)triggerInsight();

// Daily quest tracking
updateDailyQuestProgress('kill',1);
}

function breakthrough(){
const _oldRealm_=GS.realm;
const r=GD.realms[GS.realm];
if(!r||GS.cp<100||GS.qi<GS.qiMax)return;

const cost=1000*Math.pow(2,GS.realm)*Math.pow(1.5,GS.stage);
if(GS.gold<cost)return;

GS.gold-=cost;
GS.cp=0;
GS.stage++;

if(GS.stage>=9){
GS.stage=0;
GS.realm++;
if(GS.realm>=GD.realms.length){
GS.realm=GD.realms.length-1;
GS.stage=8;
notify('üåü MAX REALM!','You have reached the peak!','nski');
return;
}
GS.qiMax+=50;
}

renderCult();
if(typeof showBreakthroughAnim==='function')showBreakthroughAnim(`${GD.realms[GS.realm].n} ${GD.realms[GS.realm].stages[GS.stage]}`);
showBanner('‚ö° BREAKTHROUGH!',`${GD.realms[GS.realm].n} ${GD.realms[GS.realm].stages[GS.stage]}`);
notify('‚ö° Breakthrough',`${GD.realms[GS.realm].n} ${GD.realms[GS.realm].stages[GS.stage]}`,'nski');
screenFlash('rgba(0,212,255,0.5)');
screenShake();
addLog(`‚ö° Breakthrough to ${GD.realms[GS.realm].n} ${GD.realms[GS.realm].stages[GS.stage]}!`,'lski');

// Skill point reward
GS.skillPoints=(GS.skillPoints||0)+1;
notify('üîÆ +1 Skill Point','Spend in Skills tab!','nski');

// Daily quest tracking
updateDailyQuestProgress('breakthrough',1);

// Tribulation check (only on realm change)
if(GS.realm!==_oldRealm_){
const _tribbed_=checkTribulation(GS.realm);
if(_tribbed_)addLog('‚ö° Breakthrough triggers tribulation!','lski');
}
}

function loop(ts){
if(!lt)lt=ts;
const dt=Math.min((ts-lt)/1000,0.1);
lt=ts;

const dt2=dt*(GS.gameSpeed||1);
GS.qi=Math.min(GS.qi+dt2*(typeof getTotalQiRegen==="function"?getTotalQiRegen():5+vQiB()),GS.qiMax);

if(GS.qi>=GS.qiMax*0.9)GS.cp=Math.min(GS.cp+dt2*10,100);

if(GS.sbuffT>0){
GS.sbuffT-=dt;
if(GS.sbuffT<=0)GS.sbuff=1;
}

if(GS.askills&&GS.settings.autoSkills)autoUseSkills();

if(GS.abreak&&GS.cp>=100&&GS.qi>=GS.qiMax){
const cost=1000*Math.pow(2,GS.realm)*Math.pow(1.5,GS.stage);
if(GS.gold>=cost)breakthrough();
}

spawnEnts(dt);
heroAtk(dt);
petAtk(dt);
comboDecay();
updateUI();
renderDungeon();

if(GS.au&&GS.cf>=10)autoUp();

// prestige removed

checkAchievements();
// Auction timer
if(GS.auctionActive&&GS.auctionTimer>0){
GS.auctionTimer=Math.max(0,GS.auctionTimer-dt2);
if(GS.auctionTimer<=0)endAuction();
}
// Daily quest reset check
const _now=Date.now();
if(!GS.dailyReset||_now-GS.dailyReset>86400000)resetDailyQuests();
// QI BAR
const _qp=(GS.qi/GS.qiMax)*100;
const _qf=document.getElementById('qiBarFill');
if(_qf){_qf.style.width=_qp+'%';_qf.textContent=Math.floor(_qp)+'%';if(_qp>=95)_qf.classList.add('qi-full');else _qf.classList.remove('qi-full');}
const _qv=document.getElementById('qiBarVal');
if(_qv)_qv.textContent=Math.floor(GS.qi)+' / '+GS.qiMax+' Qi';
// BOSS
if(GS.bossActive){
GS.bossTimer-=dt2;
const _btv=document.getElementById('bossTimerVal');if(_btv)_btv.textContent=Math.max(0,Math.ceil(GS.bossTimer));
let _bd=0;
GS.ah.forEach(function(h){_bd+=h.pw*h.ar*dt2;});
if(GS.activePet){const _pp=GD.pets[GS.activePet];const _pl=GS.petLvl[GS.activePet]||1;_bd+=_pp.p*_pl*cultMult()*dt2;}
GS.bossHp=Math.max(0,GS.bossHp-_bd);
const _bpct=(GS.bossHp/GS.bossMaxHp)*100;
const _bhf=document.getElementById('bossHpFill');if(_bhf){_bhf.style.width=_bpct+'%';_bhf.textContent=Math.floor(_bpct)+'%';}
if(GS.bossHp<=0)bossKilled();else if(GS.bossTimer<=0)bossEscaped();
}
// DUNGEON BREAK
if(GS.dbActive){
GS.dbTimer-=dt2;
const _dc=document.getElementById('dbCountdown');if(_dc)_dc.textContent=Math.max(0,Math.ceil(GS.dbTimer));
if(GS.dbTimer<=0)resolveDungeonBreak();
}
// FLOOR TIMER
if(!GS.fm&&!GS.bossActive&&!GS.dbActive){
GS.floorTimer+=dt2;
const _lim=120+GS.cf*0.5;
const _ftv=document.getElementById('floorTV');const _fte=document.getElementById('floorTE');
if(_ftv)_ftv.textContent=Math.max(0,Math.floor(_lim-GS.floorTimer));
if(_fte){if(_lim-GS.floorTimer<20)_fte.className='floor-te danger';else _fte.className='floor-te';}
if(GS.floorTimer>_lim)triggerDungeonBreak();
}
requestAnimationFrame(loop);
}

function startLoop(){
setInterval(saveGame,30000);
// Save on page hide (tab close / switch)
document.addEventListener('visibilitychange',function(){
if(document.visibilityState==='hidden')saveGame();
});
window.addEventListener('beforeunload',function(){saveGame();});
// Spawn auction every 5 minutes
setInterval(function(){
if(!GS.auctionActive)spawnAuction();
},300000);
setInterval(function(){
const _spd=GS.gameSpeed||1;
const _dt=_spd*5;
tickCitizens(_dt);
tickMissions(_dt);
tickVillageEvents(_dt);
tickDayNight(_dt);
if(typeof tickTribulation==="function")tickTribulation(_dt);
const _gb=vGoldB();
if(_gb>0){const _bonus=GS.cdps*0.01*_gb*5;GS.gold+=_bonus;GS.contribution+=_bonus;}
},5000);
setInterval(()=>{
const gain=Math.max(0,GS.gold-GS.lastGold);
GS.goldGain=gain;
if(gain>0){GS.tge=(GS.tge||0)+gain;}
GS.lastGold=GS.gold;
if(gain>0)updateDailyQuestProgress('earn_gold',gain);
document.getElementById('goldG').textContent='+'+fmt(gain);
const elapsed=Math.floor((Date.now()-GS.sessionStart)/1000);
document.getElementById('sessionTime').textContent=`${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`;
},1000);
requestAnimationFrame(loop);
}

function startDpsGraph(){
const g=document.getElementById('dpsG');
for(let i=0;i<20;i++){
const s=document.createElement('div');
s.className='ds';
g.appendChild(s);
GS.dh.push(0);
}
setInterval(()=>{
GS.dh.push(GS.cdps);
if(GS.dh.length>20)GS.dh.shift();
const mx=Math.max(...GS.dh,1);
const segs=g.querySelectorAll('.ds');
segs.forEach((s,i)=>{
s.style.height=Math.max(4,(GS.dh[i]/mx)*100)+'%';
});
},500);
}



function renderCult(){
const r=GD.realms[GS.realm];
const s=r.stages[GS.stage];
const _rdEl=document.getElementById('realmD');if(_rdEl)_rdEl.textContent=r.n+' '+s;
const _qmEl=document.getElementById('qiM');if(_qmEl)_qmEl.textContent=GS.qiMax;

let html='<h2 style="color:#00d4ff;margin-bottom:20px;text-align:center;font-size:24px">üåü CULTIVATION REALMS üåü</h2>';
html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px">';
GD.realms.forEach((realm,i)=>{
const cur=i===GS.realm;
const lck=i>GS.realm;
html+=`<div style="background:rgba(0,0,0,0.5);border:2px solid ${cur?'#00d4ff':'rgba(255,215,0,0.15)'};border-radius:10px;padding:15px;text-align:center;transition:all 0.3s;${lck?'opacity:0.4':''}${cur?';box-shadow:0 0 20px #00d4ff':''}">`;
html+=`<div style="font-size:14px;font-weight:700;color:#00d4ff;margin-bottom:5px">${realm.n}</div>`;
html+=`<div style="font-size:12px;color:#8a7a6a">${cur?realm.stages[GS.stage]:'I-IX'}</div>`;
html+=`<div style="font-size:11px;color:#38ef7d;margin-top:5px">√ó${realm.m} Power</div>`;
html+=`</div>`;
});
html+='</div>';

html+='<h2 style="color:#00d4ff;margin:30px 0 20px;text-align:center;font-size:24px">üî• ACTIVE SKILLS üî•</h2>';
html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">';
for(const k in GD.skills){
const sk=GD.skills[k];
html+=`<div class="card" style="text-align:center">`;
html+=`<div style="font-size:40px;margin-bottom:10px">${sk.e}</div>`;
html+=`<div style="font-size:14px;font-weight:700;margin-bottom:5px">${sk.n}</div>`;
html+=`<div style="font-size:11px;color:#8a7a6a">Cost: ${sk.c} Qi | CD: ${sk.cd}s</div>`;
if(sk.dmg)html+=`<div style="font-size:11px;color:#38ef7d">DMG: ${sk.dmg}${sk.aoe?' (AOE)':''}</div>`;
if(sk.heal)html+=`<div style="font-size:11px;color:#38ef7d">HEAL: ${sk.heal}</div>`;
if(sk.buff)html+=`<div style="font-size:11px;color:#38ef7d">BUFF: ${sk.buff}x for 10s</div>`;
html+=`</div>`;
}
html+='</div>';

document.getElementById('cultContent').innerHTML=html;
}

function renderPets(){
const pb=document.getElementById('petBar');
if(!pb)return;
pb.innerHTML='';
for(const k in GD.pets){
const p=GD.pets[k];
const lv=GS.petLvl[k]||0;
const ps=document.createElement('div');
ps.className='ps'+(GS.activePet===k?' ac':'')+(p.u?'':' lk');
ps.innerHTML=p.e+(lv>0?`<div class="pl">Lv${lv}</div>`:'');
if(p.u)ps.onclick=()=>equipPet(k);
pb.appendChild(ps);
}

let html='<h2 style="text-align:center;color:#9b59b6;margin-bottom:20px;font-size:24px">üêâ SPIRIT BEASTS üêâ</h2>';
html+='<div class="cg">';
for(const k in GD.pets){
const p=GD.pets[k];
const lv=GS.petLvl[k]||0;
const cost=p.c*Math.pow(1.5,lv);
html+=`<div class="card">`;
html+=`<div style="text-align:center">`;
html+=`<div style="font-size:60px;margin-bottom:10px">${p.e}</div>`;
html+=`<div style="font-size:16px;font-weight:700;margin-bottom:5px">${p.n}</div>`;
html+=`<div style="font-size:12px;color:#8a7a6a;margin-bottom:10px">Level ${lv}</div>`;
html+=`<div style="font-size:11px;color:#38ef7d;margin-bottom:15px">+${p.p*lv}% Power</div>`;
if(p.u){
html+=`<button class="ub" onclick="upgradePet('${k}')" ${GS.gold<cost?'disabled':''}>Upgrade ‚Äî üí∞ ${fmt(cost)}</button>`;
html+=`<button class="ub" ${GS.activePet===k?'disabled':''} onclick="equipPet('${k}')">${GS.activePet===k?'‚úÖ ACTIVE':'Equip'}</button>`;
}else{
html+=`<button class="ub" disabled>üîí Locked - Coming Soon</button>`;
}
html+=`</div></div>`;
}
html+='</div>';
document.getElementById('petsContent').innerHTML=html;
}

function equipPet(k){
GS.activePet=k;
renderPets();
notify('üêâ Pet Equipped',GD.pets[k].n,'nc');
addLog(`üêâ ${GD.pets[k].n} is now active!`,'lq');
}

function upgradePet(k){
const p=GD.pets[k];
const lv=GS.petLvl[k]||0;
const cost=p.c*Math.pow(1.5,lv);
if(GS.gold>=cost){
GS.gold-=cost;
GS.petLvl[k]=(GS.petLvl[k]||0)+1;
renderPets();
notify('üêâ Pet Upgraded',`${p.n} Lv${GS.petLvl[k]}`,'nc');
}
}

function petAtk(dt){
if(!GS.activePet||!GS.am.length)return;
const p=GD.pets[GS.activePet];
const lv=GS.petLvl[GS.activePet]||1;
const dmg=p.p*lv*cultMult();
const atkChance=dt*0.5;
if(Math.random()<atkChance){
const idx=Math.floor(Math.random()*GS.am.length);
const m=GS.am[idx];
m.hp=Math.max(0,m.hp-dmg);
if(m.hp<=0)killM(m,idx);
}
}

function renderWpns(){
let html='<h2 style="text-align:center;color:#ffd700;margin-bottom:20px;font-size:24px">‚öîÔ∏è WEAPON MASTERY ‚öîÔ∏è</h2>';
html+='<div class="cg">';
for(const k in GD.weapons){
const w=GD.weapons[k];
html+=`<div class="card ${GS.activeWpn===k?'style="border-color:#00d4ff;box-shadow:0 0 20px #00d4ff"':''}">`;
html+=`<div style="text-align:center">`;
html+=`<div style="font-size:60px;margin-bottom:10px">${w.e}</div>`;
html+=`<div style="font-size:16px;font-weight:700;margin-bottom:5px">${w.n}</div>`;
html+=`<div style="font-size:12px;color:#8a7a6a;margin-bottom:10px">Mastery ${w.m.toFixed(0)}</div>`;
html+=`<div style="font-size:11px;color:#38ef7d;margin-bottom:15px">√ó${w.dmg.toFixed(2)} Damage</div>`;
html+=`<button class="ub" ${GS.activeWpn===k?'disabled':''} onclick="equipWpn('${k}')">${GS.activeWpn===k?'‚úÖ EQUIPPED':'Equip'}</button>`;
html+=`</div></div>`;
}
html+='</div>';
const _el_weaponsContent=document.getElementById('weaponsContent');if(_el_weaponsContent)_el_weaponsContent.innerHTML=html;
}

function equipWpn(k){
GS.activeWpn=k;
renderWpns();
notify('‚öîÔ∏è Weapon Equipped',GD.weapons[k].n,'nc');
addLog(`‚öîÔ∏è Equipped ${GD.weapons[k].n}!`,'lq');
}

function renderTitles(){
let html='<h2 style="text-align:center;color:#a29bfe;margin-bottom:20px;font-size:24px">üé≠ TITLES & HONORS üé≠</h2>';
html+='<div class="cg">';
for(const k in GD.titles){
const t=GD.titles[k];
const unlocked=!t.req||GS.mk>=t.req;
html+=`<div class="card ${!unlocked?'style="opacity:0.5"':''}">`;
html+=`<div style="text-align:center">`;
html+=`<div style="font-size:60px;margin-bottom:10px">${unlocked?'üèÜ':'üîí'}</div>`;
html+=`<div style="font-size:16px;font-weight:700;margin-bottom:5px">${t.n}</div>`;
html+=`<div style="font-size:11px;color:#38ef7d;margin-bottom:10px">+${t.b}% Power</div>`;
if(t.req)html+=`<div style="font-size:10px;color:#8a7a6a;margin-bottom:10px">${unlocked?'‚úÖ ':''} Kill ${fmt(t.req)} monsters</div>`;
html+=`<button class="ub" ${!unlocked||GS.activeTitle===k?'disabled':''} onclick="equipTitle('${k}')">${GS.activeTitle===k?'‚úÖ ACTIVE':unlocked?'Equip':'üîí Locked'}</button>`;
html+=`</div></div>`;
}
html+='</div>';
const _el_titlesContent=document.getElementById('titlesContent');if(_el_titlesContent)_el_titlesContent.innerHTML=html;
}

function equipTitle(k){
const t=GD.titles[k];
const unlocked=!t.req||GS.mk>=t.req;
if(!unlocked)return;
GS.activeTitle=k;
document.getElementById('titleD').textContent=t.n;
renderTitles();
notify('üé≠ Title Equipped',t.n,'nc');
addLog(`üé≠ ${t.n} activated!`,'lq');
}

function renderSkills(){
const sb=document.getElementById('skillsBar');
if(!sb)return;
sb.innerHTML='';
for(const k in GD.skills){
const sk=GD.skills[k];
const ss=document.createElement('div');
ss.className='ss';
ss.textContent=sk.e;
ss.title=sk.n+' ('+sk.c+' Qi, '+sk.cd+'s CD)';
ss.onclick=()=>useSkill(k);
ss.id=`sk-${k}`;
sb.appendChild(ss);
}
}

function useSkill(k){
const sk=GD.skills[k];
const now=Date.now()/1000;

if(GS.scd[k]&&GS.scd[k]>now){
notify('‚è∞ Cooldown!','Skill on cooldown','');
return;
}

if(GS.qi<sk.c){
notify('‚ö†Ô∏è Not enough Qi!','Need '+sk.c+' Qi','');
return;
}

GS.qi-=sk.c;
GS.scd[k]=now+sk.cd;

const targets=sk.aoe?GS.am.slice(0,5):[GS.am[0]];

if(sk.dmg){
targets.forEach(m=>{
if(m){
const dmg=sk.dmg*cultMult()*wpnMult();
m.hp=Math.max(0,m.hp-dmg);
spawnCrit(fmt(dmg)+' '+sk.e,false,'sk');
if(m.hp<=0)killM(m,GS.am.indexOf(m));
}
});
}

if(sk.hits){
for(let i=0;i<sk.hits;i++){
setTimeout(()=>{
const m=GS.am[Math.floor(Math.random()*GS.am.length)];
if(m){
const dmg=sk.dmg*cultMult();
m.hp=Math.max(0,m.hp-dmg);
if(m.hp<=0)killM(m,GS.am.indexOf(m));
}
},i*300);
}
}

if(sk.buff){
GS.sbuff=sk.buff;
GS.sbuffT=10;
notify('‚ú® Buffed!',`${sk.buff}x power for 10s`,'nski');
}

skillFX(sk.fx);
addLog(`‚ö° ${sk.n} activated!`,'lski');
notify('‚ö° Skill Used',sk.n,'nski');
updateDailyQuestProgress('use_skill',1);
}

function autoUseSkills(){
if(GS.am.length<3)return;
const now=Date.now()/1000;

for(const k in GD.skills){
const sk=GD.skills[k];
if(GS.qi>=sk.c&&(!GS.scd[k]||GS.scd[k]<=now)){
if(Math.random()<0.2){
useSkill(k);
break;
}
}
}
}

function updateSkillCd(){
const now=Date.now()/1000;
for(const k in GD.skills){
const el=document.getElementById(`sk-${k}`);
if(!el)continue;

if(GS.scd[k]&&GS.scd[k]>now){
const rem=Math.ceil(GS.scd[k]-now);
el.classList.add('cd');
el.classList.remove('rd');
el.innerHTML=`${GD.skills[k].e}<div class="scd">${rem}</div>`;
}else{
el.classList.remove('cd');
if(GS.qi>=GD.skills[k].c)el.classList.add('rd');
else el.classList.remove('rd');
el.innerHTML=GD.skills[k].e;
}
}
}

function spawnEnts(dt){
if(GS.fm||GS.bossActive||GS.dbActive)return;
const spb=cultMult();
const maxM=35,maxH=25;
const curM=getCurM();
for(const k in curM){
const m=curM[k];
if(!m.lv||GS.am.length>=maxM)continue;
const spawnChance=m.sr*Math.min(m.lv,10)*dt*spb*0.15;
if(Math.random()<spawnChance){
const hp=50*(1+GS.cf*0.3);
GS.am.push({type:k,e:m.e,hp:hp,mhp:hp,dr:m.dr*mult()});
}
}
for(const k in GD.heroes){
const h=GD.heroes[k];
if(!h.lv||GS.ah.length>=maxH)continue;
const spawnChance=0.8*Math.min(h.lv,10)*dt*0.15;
if(Math.random()<spawnChance){
const pw=h.p*h.lv*totalMult()*GS.sbuff;
GS.ah.push({type:k,e:h.e,pw:pw,ar:h.ar});
}
}
}

function heroAtk(dt){
let td=0;

for(let i=0;i<GS.ah.length;i++){
const h=GS.ah[i];
const numAtk=Math.floor(h.ar*dt)+((Math.random()<(h.ar*dt%1))?1:0);

for(let a=0;a<numAtk;a++){
const isCrit=Math.random()<0.15;
const isMega=Math.random()<0.03;
const dmg=h.pw*(isCrit?2:1)*(isMega?5:1);

if(GS.am.length>0){
let idx;
if(GS.settings.smartTarget){
let lowestHP=Infinity;
idx=0;
for(let j=0;j<GS.am.length;j++){
if(GS.am[j].hp<lowestHP){
lowestHP=GS.am[j].hp;
idx=j;
}
}
GS.targetIdx=idx;
}else{
idx=Math.floor(Math.random()*GS.am.length);
}

const monster=GS.am[idx];
monster.hp=Math.max(0,monster.hp-dmg);
td+=dmg;

if(Math.random()<0.15)spawnCrit(fmt(dmg)+(isCrit?' CRIT!':''),isMega?'mega':isCrit);

if(monster.hp<=0){
killM(monster,idx);
GS.targetIdx=-1;
}
}
}
}

GS.cdps=GS.cdps*0.7+td*0.3;
}



function chkFloor(){
if(GS.fp>=rk()){
GS.fp=0;GS.floorTimer=0;
const bd=BOSS_DATA[GS.cworld]&&BOSS_DATA[GS.cworld][GS.cf];
if(bd){spawnBoss(bd);return;}
// Dungeon special rooms every ~10 floors
if(!GS.fm&&GS.cf>0&&GS.cf%10===0&&Math.random()<0.6){
spawnDungeonRoom();return;
}
GS.cf++;
if(GS.cf>WORLD_MAX[GS.cworld]){chkWorldClear();return;}
const b=biome(GS.cf);
document.getElementById('cBiome').textContent=b.n;
notify('üè∞ New Floor!',`Floor ${GS.cf}`,'nf');
addLog(`üè∞ Floor ${GS.cf}! ${b.n}`,'lf2');
}
}
function chkWorldClear(){
if(GS.cworld===1&&GS.worldUnlocked<2){
GS.worldUnlocked=2;GS.cworld=2;GS.cf=501;GS.fp=0;
W2M.specter.lv=1;
addLog('üåå World 2 Unlocked!','lc');
notify('üåå WORLD 2!','Spirit Realm ‚Äî Floor 501','nski');
showBanner('üåå NEW WORLD!','Spirit Realm!');
screenFlash('rgba(162,155,254,0.6)');screenShake();renderM();
}else{
notify('üèÜ VICTORY!','All 1000 floors cleared!','nski');
showBanner('üèÜ VICTORY!','Dao God defeated!');
}
}

function updCombo(){
const el=document.getElementById('comboEl');
if(GS.combo>1){
el.textContent=`üî• ${GS.combo}√ó COMBO`;
el.classList.add('pop');
if(GS.combo>=50)el.classList.add('mg');
else el.classList.remove('mg');
setTimeout(()=>el.classList.remove('pop'),350);
}else el.textContent='';
}

function comboDecay(){
if(GS.combo>0&&Date.now()-GS.lkt>3000){
GS.combo=0;
updCombo();
}
}

function spawnCrit(txt,big,cls){
const c=document.getElementById('dEntities');
if(!c)return;
const el=document.createElement('div');
el.className='cr'+(big==='mega'?' mega':big?' big':'')+(cls?' '+cls:'');
el.textContent=txt;
el.style.left=(10+Math.random()*80)+'%';
el.style.top=(10+Math.random()*80)+'%';
c.appendChild(el);
setTimeout(()=>el.remove(),big==='mega'?2000:1300);
}

function upM(t){
const m=GD.monsters[t];
const cost=Math.floor(m.c*Math.pow(1.15,m.lv));
if(GS.gold>=cost){
GS.gold-=cost;
m.lv++;
renderM();
updateUI();
}
}

function upH(t){
const h=GD.heroes[t];
const cost=Math.floor(h.c*Math.pow(1.15,h.lv));
if(GS.gold>=cost){
GS.gold-=cost;
h.lv++;
renderH();
updateUI();
}
}

function maxUpM(t){
const m=GD.monsters[t];
let cnt=0;
while(GS.gold>=Math.floor(m.c*Math.pow(1.15,m.lv))&&cnt<100){
upM(t);
cnt++;
}
if(cnt>0)notify('‚ö° Max Upgrade',`${GD.monsters[t].e} +${cnt} levels!`,'nc');
}

function maxUpH(t){
const h=GD.heroes[t];
let cnt=0;
while(GS.gold>=Math.floor(h.c*Math.pow(1.15,h.lv))&&cnt<100){
upH(t);
cnt++;
}
if(cnt>0)notify('‚ö° Max Upgrade',`${GD.heroes[t].e} +${cnt} levels!`,'nc');
}

function maxAll(){
let tm=0,th=0;
const curM=getCurM();
for(const k in curM){if(!curM[k].lv)continue;let c2=0;while(GS.gold>=Math.floor(curM[k].c*Math.pow(1.15,curM[k].lv))&&c2<100){upMX(k);c2++;}tm+=c2;}
for(const k in GD.heroes){if(!GD.heroes[k].lv)continue;let c2=0;while(GS.gold>=Math.floor(GD.heroes[k].c*Math.pow(1.15,GD.heroes[k].lv))&&c2<100){upH(k);c2++;}th+=c2;}
notify('‚ö°‚ö° Max All!','M:'+tm+' H:'+th,'nc');
}

function toggleFarm(){
GS.fm=!GS.fm;
const b=document.getElementById('farmBtn');
b.textContent=`üåæ Farm: ${GS.fm?'ON':'OFF'}`;
b.classList.toggle('on',GS.fm);
notify('üåæ Farm Mode',GS.fm?'Farming items!':'Back to exploring!',GS.fm?'nl':'nf');
}

function quickProgress(){
const cost=GS.cf*100;
if(GS.gold<cost){
notify('‚ùå Need Gold',`${fmt(cost)} gold needed`,'');
return;
}
GS.gold-=cost;
GS.fp=Math.min(GS.fp+Math.floor(rk()*0.5),rk());
notify('‚ö° Progress Boost','Jumped ahead!','nf');
chkFloor();
}

function autoUp(){
let b=null,br=0;
for(const k in GD.monsters){
const m=GD.monsters[k];
if(!m.lv)continue;
const cost=m.c*Math.pow(1.15,m.lv);
const r=(m.sr*m.dr)/cost;
if(GS.gold>=cost&&r>br){br=r;b={t:'m',k};}
}
for(const k in GD.heroes){
const h=GD.heroes[k];
if(!h.lv)continue;
const cost=h.c*Math.pow(1.15,h.lv);
const r=(h.p*h.ar)/cost;
if(GS.gold>=cost&&r>br){br=r;b={t:'h',k};}
}
if(b)b.t==='m'?upM(b.k):upH(b.k);
}


function renderDungeon(){
const c=document.getElementById('dEntities');
const crits=[...c.querySelectorAll('.cr')];
c.innerHTML='';
crits.forEach(x=>c.appendChild(x));

GS.am.slice(0,20).forEach((m,i)=>{
const e=document.createElement('div');
e.className='e m';
if(i===GS.targetIdx)e.classList.add('tg');
e.textContent=m.e;
e.style.animationDelay=`${i*0.13}s`;
const hb=document.createElement('div');
hb.className='ehp';
const hf=document.createElement('div');
hf.className='ehpf';
if(m.hp/m.mhp<0.3)hf.classList.add('lw');
hf.style.width=((m.hp/m.mhp)*100)+'%';
hb.appendChild(hf);
e.appendChild(hb);
c.appendChild(e);
});

GS.ah.slice(0,15).forEach((h,i)=>{
const e=document.createElement('div');
e.className='e h';
e.textContent=h.e;
e.style.animationDelay=`${i*0.16}s`;
c.appendChild(e);
});

if(GS.activePet){
const e=document.createElement('div');
e.className='e p';
e.textContent=GD.pets[GS.activePet].e;
c.appendChild(e);
}
}

function renderM(){
const c=document.getElementById('mCards');
if(!c)return;
c.innerHTML='';
const curM=getCurM();
const hdr=document.createElement('div');
hdr.className='card';hdr.style.gridColumn='1/-1';
hdr.innerHTML='<div style="text-align:center"><div style="font-size:15px;margin-bottom:8px">'+(GS.cworld===2?'üåå Spirit Realm':'üåç Mortal Realm')+' ‚Äî Floor '+GS.cf+'/'+WORLD_MAX[GS.cworld]+'</div>'+(GS.worldUnlocked>=2&&GS.cworld===1?'<button class="qab purple" style="margin:4px" onclick="switchWorld(2)">üåå World 2</button>':'')+(GS.cworld===2?'<button class="qab" style="margin:4px" onclick="switchWorld(1)">üåç World 1</button>':'')+'<button class="ub all" style="margin-top:8px" onclick="maxAll()">‚ö°‚ö° MAX ALL ‚ö°‚ö°</button></div>';
c.appendChild(hdr);
for(const k in curM){
const m=curM[k];
const cost=Math.floor(m.c*Math.pow(1.15,m.lv));
const can=GS.gold>=cost;
const d=document.createElement('div');
d.className='card';
d.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div class="ci">${m.e}</div><div style="flex:1"><div class="ct">${k.toUpperCase()}</div><div class="cs2">W${GS.cworld}</div></div><div class="cl">Lv ${m.lv}</div></div><div style="font-size:12px;margin:10px 0">‚ö° ${(m.sr*Math.min(m.lv,10)*0.2).toFixed(2)}/s | üí∞ ${(m.dr*mult()).toFixed(1)}</div><button class="ub" onclick="upMX('${k}')" ${!can?'disabled':''}>Upgrade ‚Äî üí∞ ${fmt(cost)}</button><button class="ub max" onclick="maxUpMX('${k}')">‚ö° Max</button>`;
c.appendChild(d);
}
}

function renderH(){
const c=document.getElementById('hCards');
if(!c)return;
c.innerHTML='';
for(const k in GD.heroes){
const h=GD.heroes[k];
const cost=Math.floor(h.c*Math.pow(1.15,h.lv));
const can=GS.gold>=cost;
const pw=h.p*h.lv*totalMult();
const d=document.createElement('div');
d.className='card';
d.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div class="ci">${h.e}</div><div style="flex:1"><div class="ct">${k.toUpperCase()}</div><div class="cs2">Hero</div></div><div class="cl">Lv ${h.lv}</div></div><div style="font-size:12px;margin:10px 0">‚öîÔ∏è Power: ${fmt(pw)} | üîÑ Attack: ${h.ar.toFixed(1)}/s</div><button class="ub" onclick="upH('${k}')" ${!can?'disabled':''}>Upgrade ‚Äî üí∞ ${fmt(cost)}</button><button class="ub max" onclick="maxUpH('${k}')">‚ö° Max Upgrade</button>`;
c.appendChild(d);
}
}

function updateUI(){
let gps=0;
GS.ah.forEach(h=>gps+=h.pw*h.ar*0.5);
gps*=totalMult();

const _set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
const _sty=(id,prop,v)=>{const e=document.getElementById(id);if(e)e.style[prop]=v;};

_set('sGps',fmt(gps));
_set('sGold',fmt(GS.gold));
_set('sKills',fmt(GS.mk));
_set('sEss',fmt(GS.de||0));
_set('sDps',fmt(GS.cdps));
_set('dpsV',fmt(GS.cdps));
_set('sPetP',fmt(GS.activePet?(GD.pets[GS.activePet].p*(GS.petLvl[GS.activePet]||1)):0));
_set('totalG',fmt(GS.tge||0));
_set('cFloor',GS.cf);

const rq=rk();
const pct=Math.min((GS.fp/rq)*100,100);
const fp=document.getElementById('fProg');
if(fp){fp.style.width=pct+'%';fp.textContent=Math.floor(pct)+'%';}
_set('pbarInfo',GS.fp+'/'+rq+' kills');

_set('qiC',Math.floor(GS.qi));

const cprog=document.getElementById('cultP');
if(cprog){cprog.style.width=GS.cp+'%';cprog.textContent=Math.floor(GS.cp)+'%';}

const btb=document.getElementById('btBtn');
if(btb){
const _btCost=1000*Math.pow(2,GS.realm)*Math.pow(1.5,GS.stage);
const _btReady=GS.cp>=100&&GS.qi>=GS.qiMax*0.95;
const _btAfford=GS.gold>=_btCost;
btb.disabled=!(_btReady&&_btAfford);
btb.textContent=!_btReady?'BREAKTHROUGH':!_btAfford?'‚ö° Need üí∞'+fmt(_btCost):'‚ö° BREAKTHROUGH!';
}

_set('cWorld',GS.cworld);
const _wbEl=document.getElementById('worldBadge');
if(_wbEl)_wbEl.textContent=(GS.cworld===2?'üåå':'üåç')+' World '+GS.cworld;

updateSkillCd();
}

function toggleAuto(f){
const m={
collect:{k:'ac',id:'ta-collect'},
upgrade:{k:'au',id:'ta-upgrade'},

breakthrough:{k:'abreak',id:'ta-break'},
skills:{k:'askills',id:'ta-skills'}
};
const cfg=m[f];
if(!cfg)return;
GS[cfg.k]=!GS[cfg.k];
document.getElementById(cfg.id).classList.toggle('on',GS[cfg.k]);
notify('ü§ñ Automation',`${f}: ${GS[cfg.k]?'ON':'OFF'}`,'');
}

function toggleSet(s){
const m={smart:'smartTarget',fx:'fx',sound:'sound'};
if(!m[s])return;
GS.settings[m[s]]=!GS.settings[m[s]];
document.getElementById('ts-'+s).classList.toggle('on',GS.settings[m[s]]);
notify('‚öôÔ∏è Settings',`${s}: ${GS.settings[m[s]]?'ON':'OFF'}`,'');
}

function checkAchievements(){
GD.achievements.forEach(a=>{
if(!GS.achievements.has(a.id)&&a.req()){
GS.achievements.add(a.id);
notify('üèÜ Achievement!',a.n,'nq');
addLog(`üèÜ ${a.n} unlocked!`,'lq');
screenFlash('rgba(255,215,0,0.3)');
}
});
}

function showCodex(){
const totalAch=GD.achievements.length;
const unlocked=GS.achievements.size;
showModal('üìñ Codex',`<div style="line-height:2">
<strong>Monsters Slain:</strong> ${fmt(GS.mk)}<br>
<strong>Total Floors:</strong> ${GS.cf}/100<br>
<strong>Current Biome:</strong> ${biome(GS.cf).n}<br>
<strong>Cultivation Realm:</strong> ${GD.realms[GS.realm].n} ${GD.realms[GS.realm].stages[GS.stage]}<br>
<strong>Active Pet:</strong> ${GS.activePet?GD.pets[GS.activePet].n:'None'}<br>
<strong>Active Weapon:</strong> ${GD.weapons[GS.activeWpn].n}<br>
<strong>Active Title:</strong> ${GD.titles[GS.activeTitle].n}<br>
<strong>Achievements:</strong> ${unlocked}/${totalAch}<br>
<strong>Total Multiplier:</strong> ${totalMult().toFixed(1)}√ó
</div>`,[{text:'Close'}]);
}

function showAchievements(){
let html='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">';
GD.achievements.forEach(a=>{
const unlocked=GS.achievements.has(a.id);
html+=`<div style="background:rgba(0,0,0,0.5);border:1px solid ${unlocked?'#ffd700':'#555'};border-radius:8px;padding:15px;text-align:center;${unlocked?'':'opacity:0.5'}">`;
html+=`<div style="font-size:40px;margin-bottom:10px">${unlocked?a.e:'üîí'}</div>`;
html+=`<div style="font-size:14px;font-weight:700;margin-bottom:5px">${a.n}</div>`;
html+=`<div style="font-size:11px;color:#8a7a6a">${a.d}</div>`;
html+=`</div>`;
});
html+='</div>';
showModal('üèÜ Achievements',html,[{text:'Close'}]);
}

function autoSellItems(){
notify('üí∞ Auto-Sell','No items to sell yet!','');
}

function showModal(title,body,btns){
document.getElementById('mTitle').textContent=title;
document.getElementById('mBody').innerHTML=body;
const bc=document.getElementById('mBtns');
bc.innerHTML='';
btns.forEach(b=>{
const btn=document.createElement('button');
btn.className='mbn'+(b.s?' s':'');
btn.textContent=b.text;
btn.onclick=()=>{if(b.cb)b.cb();hideModal();};
bc.appendChild(btn);
});
document.getElementById('modal').classList.add('show');
}

function hideModal(){
document.getElementById('modal').classList.remove('show');
}

function showStats(type){
if(type==='gold'){
showModal('üí∞ Gold Statistics',`<div style="line-height:2">
<strong>Current Gold:</strong> ${fmt(GS.gold)}<br>
<strong>Total Gold Earned:</strong> ${fmt(GS.contribution)}<br>
<strong>Gold/sec:</strong> ${fmt(GS.ah.reduce((s,h)=>s+h.pw*h.ar*0.5,0)*totalMult())}<br>
<strong>Total Multiplier:</strong> ${totalMult().toFixed(1)}√ó<br>
<strong>Combo Bonus:</strong> +${((GS.combo-1)*2).toFixed(0)}%
</div>`,[{text:'Close'}]);
}else if(type==='kills'){
showModal('üíÄ Kill Statistics',`<div style="line-height:2">
<strong>Kills:</strong> ${fmt(GS.mk)}<br>
<strong>Current Combo:</strong> ${GS.combo}√ó<br>
<strong>Max Combo:</strong> ${GS.mc}√ó<br>
<strong>Current Floor:</strong> ${GS.cf}/100<br>
<strong>Biome:</strong> ${biome(GS.cf).n}
</div>`,[{text:'Close'}]);
}else if(type==='dps'){
showModal('‚ö° DPS Statistics',`<div style="line-height:2">
<strong>Current DPS:</strong> ${fmt(GS.cdps)}<br>
<strong>Active Heroes:</strong> ${GS.ah.length}/25<br>
<strong>Active Monsters:</strong> ${GS.am.length}/35<br>
<strong>Realm Multiplier:</strong> ${cultMult()}√ó<br>
<strong>Weapon Multiplier:</strong> ${wpnMult().toFixed(2)}√ó<br>
<strong>Pet Multiplier:</strong> ${petMult().toFixed(2)}√ó<br>
<strong>Title Multiplier:</strong> ${titleMult().toFixed(2)}√ó
</div>`,[{text:'Close'}]);
}
}

function exportSave(){
try{
const data=JSON.stringify(createSaveData());
const blob=new Blob([data],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`murim-save-${Date.now()}.json`;
a.click();
URL.revokeObjectURL(url);
notify('üíæ Exported','Save file downloaded!','nf');
}catch(e){
notify('‚ùå Error','Export failed!','nk');
}
}

function importSave(){
const input=document.createElement('input');
input.type='file';
input.accept='.json';
input.onchange=e=>{
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=event=>{
try{
const data=JSON.parse(event.target.result);
loadSaveData(data);
renderAll();
notify('üì• Imported','Save loaded successfully!','nf');
}catch(err){
notify('‚ùå Error','Import failed!','nk');
}
};
reader.readAsText(file);
};
input.click();
}

function createSaveData(){
const d={
gold:GS.gold,de:GS.de||0,mk:GS.mk,cf:GS.cf,fp:GS.fp,pc:GS.pc||0,tge:GS.tge||0,contribution:GS.contribution||0,fm:GS.fm,
combo:GS.combo,mc:GS.mc,
realm:GS.realm,stage:GS.stage,qiMax:GS.qiMax,cp:GS.cp,
activePet:GS.activePet,petLvl:GS.petLvl,
activeWpn:GS.activeWpn,activeTitle:GS.activeTitle,
settings:GS.settings,
ac:GS.ac,au:GS.au,ap:GS.ap,abreak:GS.abreak,askills:GS.askills,
achievements:[...GS.achievements],
cworld:GS.cworld,worldUnlocked:GS.worldUnlocked,bossKills:GS.bossKills,dbSurvived:GS.dbSurvived,
gameSpeed:GS.gameSpeed,itemBag:GS.itemBag,equipped:GS.equipped,smithMats:GS.smithMats,
village:GS.village,villageHp:GS.villageHp,villageMaxHp:GS.villageMaxHp,
villagePop:GS.villagePop,villageMaxPop:GS.villageMaxPop,villageLog:GS.villageLog,villBuilt:GS.villBuilt,
m:{},h:{},w:{},w2m:{}
};
for(const k in GD.monsters)d.m[k]=GD.monsters[k].lv;
for(const k in GD.heroes)d.h[k]=GD.heroes[k].lv;
for(const k in GD.weapons)d.w[k]=GD.weapons[k].m;
for(const k in W2M)d.w2m[k]=W2M[k].lv;
d.lastSaveTime=Date.now();
d.villBuilt=GS.villBuilt;
d.citizens=GS.citizens;
d.missions=GS.missions;
d.missionProgress=GS.missionProgress;
d.vheroes=GS.vheroes;
d.vevents=GS.vevents;
d.totalAFKTime=GS.totalAFKTime;
d.element=GS.element;d.elementChosen=GS.elementChosen;
d.skills_lv=GS.skills_lv;d.skillPoints=GS.skillPoints;
d.dailyQuests=GS.dailyQuests;d.dailyReset=GS.dailyReset;d.dailyDone=GS.dailyDone;
d.insights=GS.insights;d.insightTotal=GS.insightTotal;d.insightBonus=GS.insightBonus;
d.comboMilestones=GS.comboMilestones;
d.auctionItems=GS.auctionItems;d.auctionTimer=GS.auctionTimer;d.auctionActive=GS.auctionActive;
d.rankingBoard=GS.rankingBoard;
d.isDay=GS.isDay;
d.sectSkills=GS.sectSkills;
d.sectPoints=GS.sectPoints;
d.sectPointsSpent=GS.sectPointsSpent;
d.daoNodes=GS.daoNodes;
d.daoPoints=GS.daoPoints;
d.killPoints=GS.killPoints;
d.completedTribs=GS.completedTribs||[];
d.dayTimer=GS.dayTimer;
d.vResources=GS.vResources;
return d;
}

function loadSaveData(d){
const ks=['gold','de','mk','cf','fp','pc','tge','contribution','fm','combo','mc','realm','stage','qiMax','cp','activePet','petLvl','activeWpn','activeTitle','settings','ac','au','ap','abreak','askills','cworld','worldUnlocked','bossKills','dbSurvived','gameSpeed','itemBag','equipped','smithMats','village','villageHp','villageMaxHp','villagePop','villageMaxPop','villageLog','villBuilt','citizens','missions','missionProgress','vheroes','vevents','totalAFKTime','isDay','dayTimer','vResources','sectSkills','sectPoints','sectPointsSpent','daoNodes','daoPoints','killPoints','completedTribs','element','elementChosen','skills_lv','skillPoints','dailyQuests','dailyReset','dailyDone','insights','insightTotal','insightBonus','comboMilestones','auctionItems','auctionTimer','auctionActive','rankingBoard','lastSaveTime'];
ks.forEach(k=>{if(d[k]!==undefined)GS[k]=d[k];});
if(d.achievements)GS.achievements=new Set(d.achievements);
if(d.m)for(const k in d.m){if(GD.monsters[k])GD.monsters[k].lv=d.m[k];}
if(d.h)for(const k in d.h){if(GD.heroes[k])GD.heroes[k].lv=d.h[k];}
if(d.w)for(const k in d.w){if(GD.weapons[k])GD.weapons[k].m=d.w[k];}
if(d.w2m)for(const k in d.w2m){if(W2M[k])W2M[k].lv=d.w2m[k];}
}

function saveGame(){
try{
const d=createSaveData();
d.lastSaveTime=Date.now();    // always fresh timestamp
const json=JSON.stringify(d);
localStorage.setItem('murimUltimate', json);
// two rotating backup slots (prevent double-corruption)
const slot='murimBak'+(GS._bakSlot=(GS._bakSlot||0)^1);
localStorage.setItem(slot, json);
GS.lastSaveTime=d.lastSaveTime;
}catch(e){
console.error('[save] save failed:',e);
}
}

function loadGame(){
try{
// ‚îÄ‚îÄ try primary key, fall back to two rotating backups ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let raw=localStorage.getItem('murimUltimate');
if(!raw){
raw=localStorage.getItem('murimBak0')||localStorage.getItem('murimBak1');
if(raw) console.warn('[save] loaded from backup');
}
if(!raw) return;            // brand new player
let d;
try{ d=JSON.parse(raw); }
catch(e){
// primary corrupted ‚Äì try backup
const bk=localStorage.getItem('murimBak0')||localStorage.getItem('murimBak1');
if(!bk) return;
try{ d=JSON.parse(bk); } catch(e2){ return; }
console.warn('[save] primary corrupt ‚Äì used backup');
}

// ‚îÄ‚îÄ restore state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadSaveData(d);

// safety defaults for fields that might be missing in old saves
if(!GS.tge)    GS.tge    = GS.gold||0;
if(!GS.de)     GS.de     = 0;
if(!GS.pc)     GS.pc     = 0;
if(!GS.realm && GS.realm!==0) GS.realm = 0;
if(!GS.cf)     GS.cf     = 1;

// restore qi to full
GS.qi = GS.qiMax||100;

// ‚îÄ‚îÄ restore UI toggles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['ac','au','ap','abreak','askills'].forEach((k,i)=>{
const ids=['ta-collect','ta-upgrade','ta-prestige','ta-break','ta-skills'];
const el=document.getElementById(ids[i]);
if(el) el.classList.toggle('on', !!GS[k]);
});
['smart','fx','sound'].forEach(k=>{
const map={smart:'smartTarget',fx:'fx',sound:'sound'};
const el=document.getElementById('ts-'+k);
if(el) el.classList.toggle('on', !!(GS.settings&&GS.settings[map[k]]));
});
if(GS.fm){
const fb=document.getElementById('farmBtn');
if(fb){fb.textContent='üåæ Farm: ON';fb.classList.add('on');}
}

// title
const titleKey=GD.titles[GS.activeTitle]?GS.activeTitle:'nameless';
GS.activeTitle=titleKey;
const titleEl=document.getElementById('titleD');
if(titleEl) titleEl.textContent=GD.titles[titleKey].n;

// biome
const biomeEl=document.getElementById('cBiome');
if(biomeEl) biomeEl.textContent=biome(GS.cf).n;

// floor counter (immediate DOM update before first rAF)
const floorEl=document.getElementById('cFloor');
if(floorEl) floorEl.textContent=GS.cf;

// ‚îÄ‚îÄ AFK calc using the timestamp that came FROM the save data ‚îÄ‚îÄ
if(d.lastSaveTime){
const offSec=Math.min((Date.now()-d.lastSaveTime)/1000, 3600*8);
if(offSec>30){
const afkResult=calcAFK(offSec);
afkResult.seconds=Math.floor(offSec);
setTimeout(function(){ showAFKPopup(afkResult,offSec); },1500);
}
}

}catch(e){
console.error('[save] load failed:',e);
}
}

function notify(title,msg,cls){
const w=document.getElementById('nWrap');
const d=document.createElement('div');
d.className=`nt ${cls}`;
d.innerHTML=`<div class="ntt">${title}</div><div>${msg}</div>`;
w.appendChild(d);
setTimeout(()=>d.remove(),3500);
while(w.children.length>6)w.removeChild(w.firstChild);
}

function addLog(msg,t){
const l=document.getElementById('bLog');
if(!l)return;
if(l.children.length>60)l.removeChild(l.firstChild);
const d=document.createElement('div');
d.className='le '+(t||'');
const tm=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
d.textContent='['+tm+'] '+msg;
l.appendChild(d);
l.scrollTop=l.scrollHeight;
}

function showBanner(t,m){
const d=document.createElement('div');
d.className='eb';
d.innerHTML=`<h2>${t}</h2><p>${m}</p>`;
document.body.appendChild(d);
setTimeout(()=>d.remove(),3200);
}

function swTab(tab,btn){
document.querySelectorAll('.t').forEach(b=>b.classList.remove('active'));
document.querySelectorAll('.cs').forEach(s=>s.classList.remove('active'));
if(btn&&btn.classList) btn.classList.add('active');
const tabEl=document.getElementById(tab);
if(tabEl) tabEl.classList.add('active');

// render content for tab
const renders={
dungeon:    function(){ renderDungeon(); },
cultivation:function(){ renderCult(); },
pets:       function(){ renderPets(); },
weapons:    function(){ renderWpns(); },
titles:     function(){ renderTitles(); },
monsters:   function(){ renderM(); },
heroes:     function(){ renderH(); },
village:    function(){ renderVillage(); },
blacksmith: function(){ renderBlacksmith(); },
quests:     function(){ renderQuests(); },
skillTree:  function(){ renderSkillTree(); },
auction:    function(){ renderAuction(); },
ranking:    function(){ renderRanking(); },
sect:       function(){ renderSect(); },
daolaws:    function(){ renderDaoLaws(); },
};
if(renders[tab]) renders[tab]();
}

// ============================================================
// NEW DATA
// ============================================================
const WORLD_MAX={1:500,2:1000};
const BOSS_DATA={
1:{100:{n:'Shadow King',e:'üëë',hp:50000,reward:5000},200:{n:'Void Serpent',e:'üêç',hp:200000,reward:20000},300:{n:'Demon Lord',e:'üòà',hp:1000000,reward:100000},400:{n:'Ancient Dragon',e:'üêâ',hp:5000000,reward:500000},500:{n:'World Guardian',e:'üåç',hp:20000000,reward:2000000}},
2:{600:{n:'Soul Sovereign',e:'üëë',hp:100000000,reward:10000000},700:{n:'Void Emperor',e:'‚ö´',hp:500000000,reward:50000000},800:{n:'Spirit God',e:'‚ú®',hp:2000000000,reward:200000000},900:{n:'Primordial Lord',e:'üåÄ',hp:10000000000,reward:1000000000},1000:{n:'Dao God',e:'üåå',hp:100000000000,reward:10000000000}}
};
const W2M={
specter:{lv:0,sr:4,dr:5,c:500000,e:'üëª'},soulreaper:{lv:0,sr:2.5,dr:15,c:2000000,e:'üíÄ'},
voidbeast:{lv:0,sr:1.8,dr:30,c:10000000,e:'‚ö´'},spiritdrake:{lv:0,sr:3,dr:10,c:5000000,e:'üê≤'},
celestial:{lv:0,sr:2,dr:20,c:8000000,e:'‚ú®'},demonprince:{lv:0,sr:1.2,dr:80,c:50000000,e:'üëπ'},
deityshard:{lv:0,sr:0.5,dr:200,c:200000000,e:'üíé'},voidlord:{lv:0,sr:0.3,dr:500,c:1000000000,e:'üåë'},
spiritking:{lv:0,sr:0.8,dr:100,c:80000000,e:'üëë'},stormwraith:{lv:0,sr:1,dr:60,c:30000000,e:'‚õàÔ∏è'},
ashphoenix:{lv:0,sr:1.5,dr:40,c:15000000,e:'üî•'},abyssworm:{lv:0,sr:0.2,dr:1000,c:5000000000,e:'üêõ'},
spiritgiant:{lv:0,sr:0.15,dr:2000,c:10000000000,e:'üßå'},divineape:{lv:0,sr:0.1,dr:3000,c:50000000000,e:'ü¶ç'},
primordial:{lv:0,sr:0.05,dr:10000,c:100000000000,e:'üåÄ'}
};
const VSTRUCTS={
wall:{n:'Village Wall',e:'üß±',desc:'Protects from dungeon breaks',baseCost:500,costMult:2,maxLv:20,defense:50,pop:0,qiB:0,goldB:0},
barracks:{n:'Barracks',e:'üèõÔ∏è',desc:'Trains village guards',baseCost:1000,costMult:2.2,maxLv:15,defense:30,pop:5,qiB:0,goldB:0},
farm:{n:'Village Farm',e:'üåæ',desc:'Food for villagers',baseCost:800,costMult:1.8,maxLv:20,defense:0,pop:10,qiB:0,goldB:0.01},
market:{n:'Marketplace',e:'üè™',desc:'Increases gold income',baseCost:2000,costMult:2.5,maxLv:15,defense:0,pop:3,qiB:0,goldB:0.02},
shrine:{n:'Cultivation Shrine',e:'‚õ©Ô∏è',desc:'Boosts Qi regen',baseCost:5000,costMult:3,maxLv:10,defense:0,pop:2,qiB:0.5,goldB:0},
hospital:{n:'Healing House',e:'üè•',desc:'Heals village after breaks',baseCost:3000,costMult:2.3,maxLv:10,defense:0,pop:5,qiB:0,goldB:0},
forge:{n:'Weapon Forge',e:'‚öíÔ∏è',desc:'Improves weapon power',baseCost:8000,costMult:3,maxLv:8,defense:0,pop:1,qiB:0,goldB:0.05},
watchtower:{n:'Watch Tower',e:'üóº',desc:'Warning before dungeon break',baseCost:4000,costMult:2.5,maxLv:5,defense:20,pop:0,qiB:0,goldB:0}
};
const FORGE_RECIPES={
ironBlade:{n:'Iron Blade',e:'‚öîÔ∏è',desc:'Basic forged sword',color:'#38ef7d',cost:{iron:5},slot:'weapon',stat:'dmg',val:0.3,rarity:'Uncommon',rarIdx:1},
voidRing:{n:'Void Ring',e:'üíç',desc:'Channels void energy',color:'#74b9ff',cost:{iron:3,essence:2},slot:'ring',stat:'qiMax',val:20,rarity:'Rare',rarIdx:2},
dragonArmor:{n:'Dragon Scale',e:'üõ°Ô∏è',desc:'Ancient dragon scales',color:'#a29bfe',cost:{iron:8,crystal:3},slot:'armor',stat:'def',val:25,rarity:'Epic',rarIdx:3},
soulAmulet:{n:'Soul Amulet',e:'üìø',desc:'Amplifies all power',color:'#ffd700',cost:{essence:10,crystal:5},slot:'amulet',stat:'mult',val:0.15,rarity:'Legendary',rarIdx:4},
swiftBoots:{n:'Swift Boots',e:'üë¢',desc:'Increases attack speed',color:'#74b9ff',cost:{iron:4,essence:2},slot:'boots',stat:'spd',val:0.2,rarity:'Rare',rarIdx:2},
crystalHelm:{n:'Crystal Helm',e:'‚õëÔ∏è',desc:'Increases critical chance',color:'#a29bfe',cost:{crystal:6,essence:3},slot:'helm',stat:'crit',val:0.05,rarity:'Epic',rarIdx:3}
};
const RARITY_COLORS=['#aaa','#38ef7d','#74b9ff','#a29bfe','#ffd700'];
const RARITY_MULT=[1,1.5,2.5,4,8];

// ============================================================
// HELPER FUNCTIONS
// ============================================================
function getCurM(){return GS.cworld===2?W2M:GD.monsters;}
function vDef(){let d=0;for(const k in GS.village){if(VSTRUCTS[k])d+=VSTRUCTS[k].defense*(GS.village[k]||0);}return d;}
function vQiB(){let q=0;for(const k in GS.village){if(VSTRUCTS[k])q+=VSTRUCTS[k].qiB*(GS.village[k]||0);}return q;}
function vGoldB(){let g=0;for(const k in GS.village){if(VSTRUCTS[k])g+=VSTRUCTS[k].goldB*(GS.village[k]||0);}return g;}

function getEquipBonus(){
const b={dmg:0,def:0,qiMax:0,mult:0,spd:0,crit:0};
for(const slot in GS.equipped){const item=GS.equipped[slot];if(item&&b[item.stat]!==undefined)b[item.stat]+=item.val;}
return b;
}

// ============================================================
// WORLD SYSTEM
// ============================================================
function switchWorld(w){
if(w>GS.worldUnlocked){notify('üîí Locked','Clear World '+GS.cworld+' first!','nk');return;}
GS.cworld=w;GS.am=[];GS.ah=[];
notify('üåê World Switched',w===2?'Spirit Realm':'Mortal Realm','nski');
renderM();
}

// ============================================================
// BOSS SYSTEM
// ============================================================
function spawnBoss(bd){
GS.bossActive=true;GS.bossHp=bd.hp;GS.bossMaxHp=bd.hp;
GS.bossTimer=Math.max(60,90-GS.cf*0.05);GS.bossData=bd;GS.am=[];
const bb=document.getElementById('bossBanner');if(bb)bb.style.display='flex';
document.getElementById('bossIcon').textContent=bd.e;
document.getElementById('bossName').textContent='‚ö†Ô∏è BOSS: '+bd.n;
document.getElementById('bossDesc').textContent='Defeat within the time limit!';
document.getElementById('bossHpFill').style.width='100%';
document.getElementById('bossHpFill').textContent='100%';
screenFlash('rgba(255,0,0,0.6)');screenShake();
addLog('‚ö†Ô∏è BOSS: '+bd.n+'!','lb');notify('‚ö†Ô∏è BOSS!',bd.n,'nb');
showBanner('‚ö†Ô∏è BOSS!',bd.n);
}
function bossKilled(){
if(!GS.bossData)return;
const bd=GS.bossData;
GS.bossActive=false;GS.bossData=null;GS.bossKills=(GS.bossKills||0)+1;GS.floorTimer=0;
const rew=bd.reward*(1+0*0.1)*cultMult();
GS.gold+=rew;GS.contribution+=rew;
const bb=document.getElementById('bossBanner');if(bb)bb.style.display='none';
screenFlash('rgba(255,215,0,0.7)');screenShake();
addLog('üèÜ Boss '+bd.n+' defeated! +'+fmt(rew),'lc');
notify('üèÜ Boss Defeated!','+'+fmt(rew)+' Gold','nf');
showBanner('üèÜ BOSS DEFEATED!','+'+fmt(rew)+' Gold!');
GS.fp=0;GS.cf++;
if(GS.cf>WORLD_MAX[GS.cworld])chkWorldClear();
else{const b=biome(GS.cf);document.getElementById('cBiome').textContent=b.n;}
}
function bossEscaped(){
GS.bossActive=false;GS.bossData=null;
const bb=document.getElementById('bossBanner');if(bb)bb.style.display='none';
addLog('üíÄ Boss escaped!','lk');notify('üíÄ Boss Escaped!','Dungeon Break!','nk');
triggerDungeonBreak();
}

// ============================================================
// DUNGEON BREAK
// ============================================================
function triggerDungeonBreak(){
if(GS.dbActive)return;
GS.dbActive=true;GS.dbTimer=30;GS.am=[];GS.ah=[];
screenFlash('rgba(200,0,0,0.8)');screenShake();
addLog('üö® DUNGEON BREAK!','lk');notify('üö® DUNGEON BREAK!','Village attacked!','nb');
let box=document.getElementById('dbAlertBox');
if(!box){box=document.createElement('div');box.className='db-alert';box.id='dbAlertBox';document.body.appendChild(box);}
box.innerHTML='<h2>üö® DUNGEON BREAK! üö®</h2><p style="color:#ff8888;margin-bottom:12px">Monsters invade!</p><div style="font-size:14px;margin-bottom:12px">Defense: <span style="color:#38ef7d">'+fmt(vDef())+'</span></div><p id="dbCountdown" style="font-size:36px;color:#ff4444;font-weight:900">30</p>';
}
function resolveDungeonBreak(){
GS.dbActive=false;GS.floorTimer=0;
const box=document.getElementById('dbAlertBox');if(box)box.remove();
const dmg=Math.max(1,Math.floor(25-vDef()/60));
GS.villageHp=Math.max(0,GS.villageHp-dmg);GS.dbSurvived=(GS.dbSurvived||0)+1;
addVillageLog('üö® Dungeon Break! Took '+dmg+' damage. HP: '+GS.villageHp+'/'+GS.villageMaxHp);
notify('üèòÔ∏è Break Over','Village HP: '+GS.villageHp+'/'+GS.villageMaxHp,'nc');
if(GS.villageHp<=0){GS.villageHp=5;addVillageLog('üíÄ Village destroyed!');}
renderVillage();
}

// ============================================================
// BREAKTHROUGH ANIMATION
// ============================================================
function showBreakthroughAnim(txt){
if(!GS.settings.fx)return;
const ov=document.createElement('div');
ov.className='bt-overlay';
ov.innerHTML='<div class="bt-bolt">‚ö°</div><div class="bt-ring"></div><div class="bt-txt">‚ö° '+txt+' ‚ö°</div>';
document.body.appendChild(ov);
screenFlash('rgba(0,212,255,0.8)');
setTimeout(function(){screenFlash('rgba(162,155,254,0.5)');},500);
setTimeout(function(){ov.remove();},2200);
}

// ============================================================
// ITEM SYSTEM
// ============================================================
function genItem(){
const types=['weapon','armor','ring','amulet','boots','helm'];
const stats={weapon:'dmg',armor:'def',ring:'qiMax',amulet:'mult',boots:'spd',helm:'crit'};
const emojis={weapon:'‚öîÔ∏è',armor:'üõ°Ô∏è',ring:'üíç',amulet:'üìø',boots:'üë¢',helm:'‚õëÔ∏è'};
const prefixes=['Ancient','Sacred','Void','Divine','Celestial','Shadow','Storm','Soul'];
const slot=types[Math.floor(Math.random()*types.length)];
const statVals={dmg:0.1,def:5,qiMax:10,mult:0.05,spd:0.1,crit:0.02};
let rarIdx=0;
const r2=Math.random();
const drops=[0.50,0.28,0.15,0.06,0.01];
let acc=0;
for(let i=0;i<drops.length;i++){acc+=drops[i];if(r2<acc){rarIdx=i;break;}}
const rarNames=['Common','Uncommon','Rare','Epic','Legendary'];
const val=parseFloat((statVals[stats[slot]]*RARITY_MULT[rarIdx]*(1+GS.cf*0.01)).toFixed(2));
const pre=prefixes[Math.floor(Math.random()*prefixes.length)];
const nNames={weapon:'Blade',armor:'Armor',ring:'Ring',amulet:'Amulet',boots:'Boots',helm:'Helm'};
return{id:Date.now()+Math.random(),slot:slot,n:pre+' '+nNames[slot],e:emojis[slot],stat:stats[slot],val:val,rarity:rarNames[rarIdx],rarIdx:rarIdx,color:RARITY_COLORS[rarIdx]};
}
function showItemPopup(item){
if(!GS.settings.fx)return;
const p=document.createElement('div');
p.className='item-popup-el';
p.style.left=(15+Math.random()*70)+'%';
p.style.top='55%';
p.innerHTML='<div style="background:rgba(0,0,0,0.9);border:2px solid '+item.color+';border-radius:8px;padding:8px 12px;text-align:center;box-shadow:0 0 15px '+item.color+'"><div style="font-size:20px">'+item.e+'</div><div style="font-size:11px;color:'+item.color+';font-weight:700">'+item.n+'</div><div style="font-size:10px;color:#8a7a6a">'+item.rarity+'</div></div>';
document.body.appendChild(p);
setTimeout(function(){p.remove();},2500);
}
function dropMats(floor){
const r=Math.random();
if(r<0.12){GS.smithMats.iron=(GS.smithMats.iron||0)+Math.floor(1+floor*0.02);}
else if(r<0.18){GS.smithMats.essence=(GS.smithMats.essence||0)+1;}
else if(r<0.20){GS.smithMats.crystal=(GS.smithMats.crystal||0)+1;}
}
function equipItem(idx){
const item=GS.itemBag[idx];if(!item)return;
const old=GS.equipped[item.slot];
GS.equipped[item.slot]=item;
GS.itemBag.splice(idx,1);
if(old)GS.itemBag.push(old);
notify('‚öîÔ∏è Equipped!',item.n,'nf');
renderBlacksmith();
}
function sellItem(idx){
const item=GS.itemBag[idx];if(!item)return;
const price=Math.floor(100*RARITY_MULT[item.rarIdx]*(1+GS.cf*0.1));
GS.gold+=price;GS.contribution+=price;
GS.itemBag.splice(idx,1);
notify('üí∞ Sold!',item.n+' +'+fmt(price),'nf');
renderBlacksmith();
}
function sellAllCommon(){
let sold=0,total=0;
GS.itemBag=GS.itemBag.filter(function(item){
if(item.rarIdx===0){const p=Math.floor(100*(1+GS.cf*0.1));GS.gold+=p;GS.contribution+=p;total+=p;sold++;return false;}
return true;
});
if(sold>0)notify('üí∞ Sold '+sold+' items','+'+fmt(total),'nf');
renderBlacksmith();
}
function forgeItem(rk){
const r=FORGE_RECIPES[rk];if(!r)return;
for(const mat in r.cost){if((GS.smithMats[mat]||0)<r.cost[mat]){notify('‚ùå Materials','Need more '+mat,'nk');return;}}
for(const mat in r.cost)GS.smithMats[mat]-=r.cost[mat];
const item={id:Date.now(),slot:r.slot,n:'Forged '+r.n,e:r.e,stat:r.stat,val:r.val*(1+GS.cf*0.005),rarity:r.rarity,rarIdx:r.rarIdx,color:RARITY_COLORS[r.rarIdx]};
GS.itemBag.push(item);
showItemPopup(item);
notify('‚öíÔ∏è Forged!',item.n,'nf');
addLog('‚öíÔ∏è Forged: '+item.n,'lc');
renderBlacksmith();
}

// ============================================================
// BLACKSMITH RENDER
// ============================================================
function renderBlacksmith(){
const bonus=getEquipBonus();
let h='<div style="background:linear-gradient(135deg,rgba(20,10,5,0.9),rgba(40,20,5,0.9));border:1px solid rgba(255,140,0,0.3);border-radius:12px;padding:14px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">';
h+='<div><div style="font-size:20px;font-weight:900;color:#ff8c00;margin-bottom:4px">‚öíÔ∏è BLACKSMITH</div><div style="font-size:12px;color:#8a7a6a">Forge & equip gear</div></div>';
h+='<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:12px">';
h+='<span>ü™® Iron: <b style="color:#e8dcc8">'+Math.floor(GS.smithMats.iron||0)+'</b></span>';
h+='<span>‚ö´ Essence: <b style="color:#a29bfe">'+Math.floor(GS.smithMats.essence||0)+'</b></span>';
h+='<span>üíé Crystal: <b style="color:#74b9ff">'+Math.floor(GS.smithMats.crystal||0)+'</b></span>';
h+='</div></div>';
// Equipped
h+='<h3 style="color:#ff8c00;margin-bottom:10px;font-size:15px">‚öîÔ∏è EQUIPPED</h3>';
const slotIcons={weapon:'‚öîÔ∏è',armor:'üõ°Ô∏è',ring:'üíç',amulet:'üìø',boots:'üë¢',helm:'‚õëÔ∏è'};
const slotNames={weapon:'Weapon',armor:'Armor',ring:'Ring',amulet:'Amulet',boots:'Boots',helm:'Helm'};
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:14px">';
for(const slot in slotNames){
const eq=GS.equipped[slot];
h+='<div class="item-slot'+(eq?' eq-slot':'')+'">';
h+='<span style="font-size:20px">'+(eq?eq.e:slotIcons[slot])+'</span>';
h+='<div style="flex:1;min-width:0">';
if(eq){h+='<div style="font-size:11px;font-weight:700;color:'+eq.color+'">'+eq.n.substring(0,14)+'</div><div style="font-size:10px;color:#8a7a6a">+'+eq.val+' '+eq.stat+'</div>';}
else{h+='<div style="font-size:11px;color:#555">'+slotNames[slot]+'</div><div style="font-size:10px;color:#333">Empty</div>';}
h+='</div></div>';
}
h+='</div>';
if(Object.values(bonus).some(function(v){return v>0;})){
h+='<div style="background:rgba(0,0,0,0.4);border:1px solid rgba(255,140,0,0.2);border-radius:10px;padding:10px;margin-bottom:14px;display:flex;gap:12px;flex-wrap:wrap;font-size:12px">';
if(bonus.dmg>0)h+='<span style="color:#ff8c00">‚öîÔ∏è +'+bonus.dmg.toFixed(2)+' DMG</span>';
if(bonus.def>0)h+='<span style="color:#74b9ff">üõ°Ô∏è +'+bonus.def.toFixed(0)+' DEF</span>';
if(bonus.qiMax>0)h+='<span style="color:#00d4ff">‚ö° +'+bonus.qiMax.toFixed(0)+' Qi</span>';
if(bonus.mult>0)h+='<span style="color:#ffd700">‚ú® +'+Math.floor(bonus.mult*100)+'% Power</span>';
if(bonus.crit>0)h+='<span style="color:#ff6b6b">üí• +'+Math.floor(bonus.crit*100)+'% Crit</span>';
h+='</div>';
}
// Forge
h+='<h3 style="color:#ff8c00;margin-bottom:10px;font-size:15px">üî® FORGE</h3>';
h+='<div class="smith-grid">';
for(const rk in FORGE_RECIPES){
const r=FORGE_RECIPES[rk];
const canF=Object.keys(r.cost).every(function(m){return(GS.smithMats[m]||0)>=r.cost[m];});
h+='<div class="smith-card"><div style="text-align:center;font-size:30px;margin-bottom:8px">'+r.e+'</div>';
h+='<div style="font-size:13px;font-weight:700;text-align:center;margin-bottom:4px;color:'+r.color+'">'+r.n+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a;text-align:center;margin-bottom:8px">'+r.desc+'</div>';
for(const mat in r.cost){const have=Math.floor(GS.smithMats[mat]||0);const need=r.cost[mat];h+='<div style="font-size:11px;margin-bottom:3px;color:'+(have>=need?'#38ef7d':'#ff4444')+'">'+mat+': '+have+'/'+need+'</div>';}
h+='<button class="forge-btn" onclick="forgeItem(\'' + rk + '\')" '+(canF?'':'disabled')+'>üî® Forge</button></div>';
}
h+='</div>';
// Bag
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">';
h+='<h3 style="color:#ff8c00;font-size:15px">üéí ITEM BAG ('+GS.itemBag.length+'/50)</h3>';
h+='<button class="forge-btn" style="width:auto;padding:6px 14px" onclick="sellAllCommon()">üí∞ Sell All Common</button></div>';
if(GS.itemBag.length===0){
h+='<div style="text-align:center;color:#8a7a6a;padding:30px;font-size:14px">No items yet.<br>Kill monsters to get drops!</div>';
}else{
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">';
GS.itemBag.forEach(function(item,idx){
h+='<div class="smith-card item-new" style="border-color:'+item.color+'50">';
h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
h+='<span style="font-size:24px">'+item.e+'</span>';
h+='<div><div style="font-size:12px;font-weight:700;color:'+item.color+'">'+item.n+'</div>';
h+='<div style="font-size:10px;color:'+item.color+'">'+item.rarity+'</div></div></div>';
h+='<div style="font-size:11px;color:#8a7a6a;margin-bottom:8px">+'+item.val+' '+item.stat+'</div>';
h+='<div style="display:flex;gap:6px">';
h+='<button class="forge-btn" style="margin-top:0;flex:1;padding:6px;font-size:11px" onclick="equipItem('+idx+')">Equip</button>';
const price=Math.floor(100*RARITY_MULT[item.rarIdx]*(1+GS.cf*0.1));
h+='<button class="forge-btn" style="margin-top:0;flex:1;padding:6px;font-size:11px;background:linear-gradient(135deg,#1a3a1a,#27ae60)" onclick="sellItem('+idx+')">üí∞ '+fmt(price)+'</button>';
h+='</div></div>';
});
h+='</div>';
}
document.getElementById('smithContent').innerHTML=h;
}

// ============================================================
// VILLAGE
// ============================================================
function addVillageLog(msg){
GS.villageLog=GS.villageLog||[];
GS.villageLog.push('['+new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'})+'] '+msg);
if(GS.villageLog.length>30)GS.villageLog.shift();
const vl=document.getElementById('villLogEl');
if(vl){vl.innerHTML=GS.villageLog.map(function(l){return'<div>'+l+'</div>';}).join('');vl.scrollTop=vl.scrollHeight;}
}
function buildStructure(k){
const s=VSTRUCTS[k];if(!s)return;
const lv=GS.village[k]||0;
if(lv>=s.maxLv){notify('‚úÖ Max Level','Already maxed','');return;}
const cost=Math.floor(s.baseCost*Math.pow(s.costMult,lv));
if(GS.gold<cost){notify('‚ùå Need Gold',fmt(cost)+' required','');return;}
GS.gold-=cost;GS.village[k]=(GS.village[k]||0)+1;GS.villBuilt=(GS.villBuilt||0)+1;
GS.villageMaxPop+=s.pop;
addVillageLog('üèóÔ∏è '+s.n+' Lv'+GS.village[k]);
notify('üèòÔ∏è Built!',s.n+' Lv'+GS.village[k],'nf');
renderVillage();updateUI();
}
function repairVillage(){
const needed=GS.villageMaxHp-GS.villageHp;
if(needed<=0){notify('‚úÖ Full HP','Village is fine!','nf');return;}
const cost=Math.ceil(needed*100);
if(GS.gold<cost){notify('‚ùå Need Gold',fmt(cost)+' for repairs','');return;}
GS.gold-=cost;GS.villageHp=GS.villageMaxHp;
addVillageLog('üî® Village repaired!');notify('üî® Repaired!','Village restored','nf');renderVillage();
}


// ============================================================
// QOL FUNCTIONS
// ============================================================
function setGameSpeed(s){
GS.gameSpeed=s;
['1','2','5'].forEach(function(n){
const el=document.getElementById('spd'+n);
if(el)el.classList.remove('spd-active');
});
const btn=document.getElementById('spd'+s);if(btn)btn.classList.add('spd-active');
notify('‚ö° Speed','Game speed: '+s+'√ó','nski');
}
function resetFloorTimer(){GS.floorTimer=0;notify('üîÑ Timer Reset','Floor timer reset!','nf');}
function rushBoss(){
const bosses=BOSS_DATA[GS.cworld];
const keys=Object.keys(bosses).map(Number).filter(function(f){return f>GS.cf;}).sort(function(a,b){return a-b;});
if(!keys.length){notify('‚öîÔ∏è No Boss','No upcoming boss!','');return;}
const next=keys[0];
const cost=Math.floor(next*500);
if(GS.gold<cost){notify('‚ùå Need Gold',fmt(cost)+' to rush','nk');return;}
GS.gold-=cost;GS.cf=next-1;GS.fp=rk()-1;GS.floorTimer=0;
const b=biome(GS.cf);document.getElementById('cBiome').textContent=b.n;
notify('‚öîÔ∏è Rushed!','Boss at Floor '+next,'nf');
}
function collectGold(){
const bonus=GS.cdps*3;
GS.gold+=bonus;GS.contribution+=bonus;
notify('üí∞ Collected','+'+fmt(bonus)+' gold!','nf');
screenFlash('rgba(255,215,0,0.3)');
}
function upMX(t){
const m=getCurM()[t];if(!m)return;
const cost=Math.floor(m.c*Math.pow(1.15,m.lv));
if(GS.gold>=cost){GS.gold-=cost;m.lv++;renderM();updateUI();}
}
function maxUpMX(t){
const m=getCurM()[t];if(!m)return;
let c2=0;
while(GS.gold>=Math.floor(m.c*Math.pow(1.15,m.lv))&&c2<100){upMX(t);c2++;}
if(c2>0)notify('‚ö° Max',m.e+' +'+c2,'nc');
}

// ============================================================
// EXPOSE ALL FUNCTIONS TO WINDOW (CodePen fix)
// ============================================================
window.breakthrough=breakthrough;
window.toggleFarm=toggleFarm;
window.quickProgress=quickProgress;
window.toggleAuto=toggleAuto;
window.toggleSet=toggleSet;
window.swTab=swTab;
window.maxAll=maxAll;
window.showCodex=showCodex;
window.showAchievements=showAchievements;
window.autoSellItems=autoSellItems;
window.exportSave=exportSave;
window.importSave=importSave;
window.showStats=showStats;
window.hideModal=hideModal;
window.equipPet=equipPet;
window.upgradePet=upgradePet;
window.equipWpn=equipWpn;
window.equipTitle=equipTitle;
window.useSkill=useSkill;
window.upM=upM;
window.upH=upH;
window.maxUpM=maxUpM;
window.maxUpH=maxUpH;
window.upMX=upMX;
window.maxUpMX=maxUpMX;
window.switchWorld=switchWorld;
window.buildStructure=buildStructure;
window.repairVillage=repairVillage;
window.forgeItem=forgeItem;
window.equipItem=equipItem;
window.sellItem=sellItem;
window.sellAllCommon=sellAllCommon;
window.renderBlacksmith=renderBlacksmith;
window.renderVillage=renderVillage;
window.setGameSpeed=setGameSpeed;
window.resetFloorTimer=resetFloorTimer;
window.rushBoss=rushBoss;
window.collectGold=collectGold;
window.showBreakthroughAnim=showBreakthroughAnim;

// ================================================================
// AFK / OFFLINE PROGRESS SYSTEM
// ================================================================
function calcAFK(seconds){
const result={gold:0,kills:0,items:[],floors:0,seconds:Math.floor(seconds),materials:{iron:0,essence:0,crystal:0}};
const dps=GS.cdps||0;
const gps=(function(){let g=0;Object.keys(GD.heroes).forEach(function(k){const h=GD.heroes[k];if(h.lv)g+=h.p*h.lv*0.5;});return g*totalMult();}());

// Offline efficiency caps at 50% of online (fair AFK)
const eff=0.5;
result.gold=Math.floor(gps*seconds*eff*(1+vGoldB()));

// Kills estimate
const killsPerSec=(dps>0?dps/Math.max(50*(1+GS.cf*0.3),1):1)*eff;
result.kills=Math.floor(killsPerSec*seconds);

// Floor progress
const floorTime=Math.max(30,120-GS.cf*0.3);
result.floors=Math.floor(seconds/floorTime*eff);

// Item drops
const itemChance=(0.05+GS.cf*0.001)*eff;
const expectedItems=Math.floor(result.kills*itemChance);
for(let i=0;i<Math.min(expectedItems,8);i++){
if(typeof genItem==='function')result.items.push(genItem());
}

// Materials
result.materials.iron=Math.floor(result.kills*0.12);
result.materials.essence=Math.floor(result.kills*0.05);
result.materials.crystal=Math.floor(result.kills*0.015);

// Village missions progress offline
if(GS.missions){
GS.missions.forEach(function(m){
if(m.active&&!m.done){
const prog=GS.missionProgress[m.id]||0;
GS.missionProgress[m.id]=Math.min(prog+seconds*m.spd*eff,m.goal);
if(GS.missionProgress[m.id]>=m.goal){
m.done=true;m.active=false;
result.gold+=m.reward;
GS.gold+=m.reward;GS.contribution+=m.reward;
}
}
});
}
return result;
}

function applyAFK(result){
// gold
GS.gold+=(result.gold||0);
GS.tge=(GS.tge||0)+(result.gold||0);
GS.contribution=(GS.contribution||0)+(result.gold||0);

// kills
GS.mk+=(result.kills||0);

// afk time
GS.totalAFKTime=(GS.totalAFKTime||0)+(result.seconds||0);

// floor progress ‚Äì each AFK "floor" = 1 full floor cleared
const maxFloor=WORLD_MAX[GS.cworld]||1000;
const floorsToAdd=Math.min(result.floors||0, maxFloor-GS.cf);
GS.cf=Math.min(GS.cf+floorsToAdd, maxFloor);
GS.fp=0;   // reset partial progress

// update biome display
const biomeEl=document.getElementById('cBiome');
if(biomeEl) biomeEl.textContent=biome(GS.cf).n;
const floorEl=document.getElementById('cFloor');
if(floorEl) floorEl.textContent=GS.cf;

// items
(result.items||[]).forEach(function(item){
if(GS.itemBag.length<50) GS.itemBag.push(item);
});

// materials
GS.smithMats.iron    =(GS.smithMats.iron    ||0)+(result.materials.iron    ||0);
GS.smithMats.essence =(GS.smithMats.essence ||0)+(result.materials.essence ||0);
GS.smithMats.crystal =(GS.smithMats.crystal ||0)+(result.materials.crystal ||0);
}

function showAFKPopup(result,seconds){
GS.pendingAFK=result;
const h=Math.floor(seconds/3600);
const m=Math.floor((seconds%3600)/60);
const timeStr=(h>0?h+'h ':'')+m+'m';
const box=document.createElement('div');
box.className='afk-popup';
box.innerHTML='<div class="afk-title">‚è∞ WELCOME BACK!</div>'+
'<div style="font-size:13px;color:#8a7a6a;margin-bottom:12px">Away for <b style="color:#ffd700">'+timeStr+'</b></div>'+
'<div class="afk-grid">'+
'<div class="afk-stat"><div class="afk-stat-v">üí∞ '+fmt(result.gold)+'</div><div class="afk-stat-l">Gold Earned</div></div>'+
'<div class="afk-stat"><div class="afk-stat-v">üíÄ '+fmt(result.kills)+'</div><div class="afk-stat-l">Monsters Killed</div></div>'+
'<div class="afk-stat"><div class="afk-stat-v">üè∞ +'+result.floors+'</div><div class="afk-stat-l">Floors Cleared</div></div>'+
'<div class="afk-stat"><div class="afk-stat-v">üéí '+result.items.length+'</div><div class="afk-stat-l">Items Dropped</div></div>'+
'</div>'+
'<div style="font-size:12px;color:#8a7a6a;margin-bottom:12px">ü™® +'+result.materials.iron+' Iron | ‚ö´ +'+result.materials.essence+' Essence | üíé +'+result.materials.crystal+' Crystal</div>'+
'<button class="afk-close" onclick="claimPendingAFK(this.parentNode)">‚úÖ CLAIM REWARDS</button>';
document.body.appendChild(box);
}

function claimAFK(box,result){
applyAFK(result);
if(box && box.remove) box.remove();
notify('‚è∞ AFK Rewards','Claimed! Keep grinding!','nf');
addLog('‚è∞ AFK: +'+fmt(result.gold)+' gold | +'+fmt(result.kills)+' kills | +'+result.floors+' floors','lc');
updateUI();
renderAll();
saveGame();
}
function claimPendingAFK(box){
if(!GS.pendingAFK)return;
claimAFK(box,GS.pendingAFK);
GS.pendingAFK=null;
}

// ================================================================
// VILLAGE CITIZEN SYSTEM
// ================================================================
const CITIZEN_ROLES=[
{id:'farmer',n:'Farmer',e:'üë®‚Äçüåæ',desc:'Produces food & gold passively',goldPerSec:0.5,reqBuilding:'farm'},
{id:'guard',n:'Guard',e:'üíÇ',desc:'Defends village from attacks',defense:20,reqBuilding:'barracks'},
{id:'merchant',n:'Merchant',e:'üè™',desc:'Increases gold income',goldMult:0.02,reqBuilding:'market'},
{id:'healer',n:'Healer',e:'üíä',desc:'Slowly heals village HP',healPerSec:0.1,reqBuilding:'hospital'},
{id:'scholar',n:'Scholar',e:'üìö',desc:'Boosts Qi regen',qiBoost:0.3,reqBuilding:'shrine'},
{id:'smith',n:'Blacksmith',e:'‚öíÔ∏è',desc:'Crafts materials over time',matsPerMin:1,reqBuilding:'forge'},
{id:'scout',n:'Scout',e:'üó∫Ô∏è',desc:'Explores & finds treasures',expPerMin:1,reqBuilding:'watchtower'},
{id:'captain',n:'Captain',e:'‚öîÔ∏è',desc:'Commands all guards +50% eff',guardBuff:0.5,reqBuilding:'barracks',req:3}
];

function getCitizenCost(roleId){
const existing=(GS.citizens||[]).filter(function(c){return c.roleId===roleId;}).length;
return Math.floor(500*Math.pow(2,existing));
}
function hireCitizen(roleId){
const role=CITIZEN_ROLES.find(function(r){return r.id===roleId;});
if(!role)return;
if(role.reqBuilding&&!(GS.village[role.reqBuilding]>0)){notify('üîí Need Building',role.reqBuilding+' required!','nk');return;}
if(role.req){
const existing=(GS.citizens||[]).filter(function(c){return c.roleId===roleId;}).length;
if(existing>=role.req){notify('‚úÖ Max','Max citizens for this role','');return;}
}
const cost=getCitizenCost(roleId);
if(GS.gold<cost){notify('‚ùå Gold','Need '+fmt(cost),'nk');return;}
GS.gold-=cost;
GS.citizens=GS.citizens||[];
GS.citizens.push({id:Date.now(),roleId:roleId,name:role.n,e:role.e,busy:false,busyTimer:0,busyTask:'',exp:0});
notify('üë• Hired!',role.n+' joined!','nvill');
addLog('üë• Hired '+role.n,'lf2');
renderVillage();
}
function fireCitizen(idx){
if(!GS.citizens||!GS.citizens[idx])return;
const c=GS.citizens[idx];
GS.citizens.splice(idx,1);
notify('üë• Dismissed',c.name+' left','');
renderVillage();
}
function tickCitizens(dt2){
if(!GS.citizens||!GS.citizens.length)return;
GS.citizens.forEach(function(c){
const role=CITIZEN_ROLES.find(function(r){return r.id===c.roleId;});
if(!role)return;
c.exp=(c.exp||0)+dt2;
if(role.goldPerSec)GS.gold+=role.goldPerSec*dt2*(1+Math.floor(c.exp/100)*0.1);
if(role.healPerSec&&GS.villageHp<GS.villageMaxHp){
GS.villageHp=Math.min(GS.villageMaxHp,GS.villageHp+role.healPerSec*dt2);
}
if(role.matsPerMin&&Math.random()<dt2/60){
GS.smithMats.iron=(GS.smithMats.iron||0)+1;
}
if(role.expPerMin&&Math.random()<dt2/120){
const item=genItem();
GS.itemBag.push(item);
if(GS.itemBag.length>50)GS.itemBag.shift();
}
});
}

// ================================================================
// VILLAGE MISSIONS SYSTEM
// ================================================================
const MISSION_TEMPLATES=[
{id:'patrol',n:'Forest Patrol',e:'üå≤',desc:'Send scouts to patrol the forest',duration:120,spd:1/120,goal:1,reward:500,type:'scout',reqBuilding:'watchtower'},
{id:'trade',n:'Trade Caravan',e:'üê™',desc:'Send merchants to trade city',duration:300,spd:1/300,goal:1,reward:2000,type:'trade',reqBuilding:'market'},
{id:'gather',n:'Herb Gathering',e:'üåø',desc:'Gather herbs for medicine',duration:180,spd:1/180,goal:1,reward:800,type:'gather',reqBuilding:'farm'},
{id:'mining',n:'Iron Mining',e:'‚õèÔ∏è',desc:'Mine iron ore',duration:240,spd:1/240,goal:1,rewardMat:{iron:20},type:'mine',reqBuilding:'forge'},
{id:'training',n:'Guard Training',e:'üèãÔ∏è',desc:'Train village guards',duration:600,spd:1/600,goal:1,rewardDef:50,type:'train',reqBuilding:'barracks'},
{id:'explore',n:'Ancient Ruins',e:'üóø',desc:'Explore ruins for treasure',duration:900,spd:1/900,goal:1,rewardItem:true,type:'explore',reqBuilding:'watchtower'},
{id:'ritual',n:'Qi Ritual',e:'‚õ©Ô∏è',desc:'Perform shrine ritual',duration:1800,spd:1/1800,goal:1,rewardQi:50,type:'ritual',reqBuilding:'shrine'},
{id:'siege',n:'Defend Against Raiders',e:'‚öîÔ∏è',desc:'Fight off attackers',duration:60,spd:1/60,goal:1,rewardGold:5000,type:'defend',reqBuilding:'barracks'}
];
function initMissions(){
if(!GS.missions||GS.missions.length===0){
GS.missions=MISSION_TEMPLATES.map(function(t){
return Object.assign({},t,{active:false,done:false,cooldown:0});
});
GS.missionProgress={};
}
}
function startMission(id){
initMissions();
const m=GS.missions.find(function(m2){return m2.id===id;});
if(!m||m.active||m.done)return;
if(m.reqBuilding&&!(GS.village[m.reqBuilding]>0)){notify('üîí Need Building',m.reqBuilding+' required!','nk');return;}
m.active=true;
GS.missionProgress[id]=0;
notify('üó∫Ô∏è Mission Started!',m.n,'nvill');
addLog('üó∫Ô∏è Mission: '+m.n+' started','lq');
renderVillage();
}
function claimMission(id){
initMissions();
const m=GS.missions.find(function(m2){return m2.id===id;});
if(!m||!m.done)return;
// Apply reward
if(m.reward){GS.gold+=m.reward;GS.contribution+=m.reward;notify('üí∞ Mission Complete!',m.n+' +'+fmt(m.reward),'nf');}
if(m.rewardMat)for(const mat in m.rewardMat){GS.smithMats[mat]=(GS.smithMats[mat]||0)+m.rewardMat[mat];}
if(m.rewardDef){GS.villageMaxHp+=m.rewardDef;GS.villageHp+=m.rewardDef;notify('üõ°Ô∏è Defense Up!','+'+m.rewardDef+' HP','nf');}
if(m.rewardItem){const item=genItem();GS.itemBag.push(item);showItemPopup(item);notify('üéÅ Found Item!',item.n,'nf');}
if(m.rewardQi){GS.qiMax+=m.rewardQi;notify('‚ö° Qi Expanded!','+'+m.rewardQi+' Max Qi','nski');}
if(m.rewardGold){GS.gold+=m.rewardGold;GS.contribution+=m.rewardGold;notify('üí∞ Raid Repelled!','+'+fmt(m.rewardGold),'nf');}
addLog('‚úÖ Mission Complete: '+m.n,'lc');
// Reset for repeat
m.done=false;m.active=false;GS.missionProgress[id]=0;
m.cooldown=m.duration;
renderVillage();
}
function tickMissions(dt2){
initMissions();
GS.missions.forEach(function(m){
if(m.cooldown>0){m.cooldown=Math.max(0,m.cooldown-dt2);return;}
if(!m.active||m.done)return;
GS.missionProgress[m.id]=(GS.missionProgress[m.id]||0)+dt2*m.spd;
if(GS.missionProgress[m.id]>=m.goal){
GS.missionProgress[m.id]=1;
m.done=true;m.active=false;
notify('‚úÖ Mission Done!',m.n+' ‚Äî Collect reward!','nvill');
addLog('‚úÖ Mission ready: '+m.n,'lc');
}
});
}

// ================================================================
// VILLAGE RANDOM EVENTS SYSTEM
// ================================================================
const VILLAGE_EVENTS=[
{id:'merchant_visit',n:'Travelling Merchant',e:'üê™',desc:'A merchant offers rare goods at discount!',type:'shop',chance:0.001,minFloor:5},
{id:'monster_raid',n:'Monster Raid!',e:'üëπ',desc:'Monsters are raiding the village!',type:'raid',chance:0.0008,minFloor:10},
{id:'wandering_hero',n:'Wandering Hero',e:'‚öîÔ∏è',desc:'A hero seeks a home in your village',type:'hero',chance:0.0005,minFloor:20},
{id:'ancient_scroll',n:'Ancient Scroll Found',e:'üìú',desc:'A scholar found a cultivation scroll!',type:'reward',chance:0.0003,minFloor:30,rewardQi:25},
{id:'spirit_rain',n:'Spirit Rain',e:'‚ú®',desc:'Spirit energy rains down blessing everyone!',type:'buff',chance:0.0004,minFloor:15},
{id:'earthquake',n:'Tremors',e:'üåã',desc:'An earthquake damages the village walls',type:'damage',chance:0.0003,minFloor:25},
{id:'harvest_festival',n:'Harvest Festival',e:'üéâ',desc:'Villagers celebrate bumper harvest!',type:'gold',chance:0.0006,minFloor:10}
];

let _lastEventCheck=0;
function tickVillageEvents(dt2){
if(!GS.village||Object.values(GS.village).every(function(v){return v===0;}))return;
_lastEventCheck+=dt2;
if(_lastEventCheck<10)return;
_lastEventCheck=0;
VILLAGE_EVENTS.forEach(function(ev){
if(GS.cf<ev.minFloor)return;
if(Math.random()<ev.chance*10){
triggerVillageEvent(ev);
}
});
}
function triggerVillageEvent(ev){
GS.vevents=GS.vevents||[];
const event={id:ev.id,n:ev.n,e:ev.e,desc:ev.desc,type:ev.type,ts:Date.now(),choices:getEventChoices(ev)};
GS.vevents.unshift(event);
if(GS.vevents.length>5)GS.vevents.pop();
notify('üèòÔ∏è Village Event!',ev.n,'nvill');
addLog('üèòÔ∏è Event: '+ev.n,'lq');
// Apply passive effects
if(ev.type==='raid'){
const dmg=Math.max(1,10-Math.floor(vDef()/100));
GS.villageHp=Math.max(0,GS.villageHp-dmg);
addVillageLog('‚öîÔ∏è Raid! Took '+dmg+' damage');
}
if(ev.type==='buff'){
GS.sbuff=1.5;GS.sbuffT=30;
addVillageLog('‚ú® Spirit Rain! 1.5x buff for 30s');
}
if(ev.type==='gold'){
const bonus=Math.floor(GS.gold*0.1+1000);
GS.gold+=bonus;GS.contribution+=bonus;
addVillageLog('üéâ Festival! +'+fmt(bonus)+' gold');
}
if(ev.type==='damage'){
const dmg=Math.floor(GS.villageMaxHp*0.1);
GS.villageHp=Math.max(1,GS.villageHp-dmg);
addVillageLog('üåã Earthquake! -'+dmg+' HP');
}
if(ev.rewardQi){GS.qiMax+=ev.rewardQi;}
}
function getEventChoices(ev){
if(ev.type==='shop')return [{text:'Buy Rare Item (500g)',cb:'buyMerchantItem'}];
if(ev.type==='hero')return [{text:'Recruit Hero (2000g)',cb:'recruitVHero'},{text:'Decline',cb:''}];
return [];
}
function resolveEventChoice(idx,cbName){
GS.vevents=GS.vevents||[];
if(cbName==='buyMerchantItem'){
if(GS.gold>=500){GS.gold-=500;const item=genItem();item.rarIdx=Math.min(4,item.rarIdx+1);item.val*=1.5;item.color=RARITY_COLORS[item.rarIdx];GS.itemBag.push(item);showItemPopup(item);notify('üõí Bought!',item.n,'nf');}
else notify('‚ùå No Gold','Need 500 gold','nk');
}
if(cbName==='recruitVHero'){
if(GS.gold>=2000){
GS.gold-=2000;GS.vheroes=GS.vheroes||[];
const names=['Wei Chen','Liu Fang','Zhao Ming','Sun Li','Tang Xiu'];
const n=names[Math.floor(Math.random()*names.length)];
GS.vheroes.push({name:n,e:'‚öîÔ∏è',power:10+Math.floor(GS.cf*0.5),deployed:false});
notify('‚öîÔ∏è Hero Recruited!',n,'nf');
}else notify('‚ùå No Gold','Need 2000 gold','nk');
}
if(idx>=0&&GS.vevents[idx])GS.vevents.splice(idx,1);
renderVillage();
}

// ================================================================
// VILLAGE HEROES (defenders)
// ================================================================
function deployVHero(idx){
GS.vheroes=GS.vheroes||[];
const h=GS.vheroes[idx];
if(!h)return;
h.deployed=!h.deployed;
notify('‚öîÔ∏è Village Hero',h.name+(h.deployed?' deployed!':' recalled'),'nvill');
renderVillage();
}
function getVHeroPower(){
return(GS.vheroes||[]).filter(function(h){return h.deployed;}).reduce(function(s,h){return s+h.power;},0);
}

// ================================================================
// PATCH: loop ‚Äî add citizen/mission/event ticks + village gold bonus
// ================================================================
// Village gold bonus applied in killM (already has totalMult which has itemMult)
// We add citizen passive gold directly in loop via tickCitizens

// ================================================================
// VILLAGE RENDER ‚Äî FULL REWRITE with new systems
// ================================================================
function renderVillage(){
initMissions();
const hp=Math.max(0,((GS.villageHp||100)/(GS.villageMaxHp||100))*100);
const def=vDef()+(getVHeroPower()||0);
const citizens=GS.citizens||[];
const vheroes=GS.vheroes||[];
const events=GS.vevents||[];
let h='';

// === HEADER ===
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">';
h+='<div><div style="font-size:22px;font-weight:900;color:#38ef7d;margin-bottom:4px">üèòÔ∏è YOUR VILLAGE</div>';
h+='<div style="font-size:12px;color:#8a7a6a">'+(GS.cworld===2?'üåå Spirit':'üåç Mortal')+' | Floor '+GS.cf+'</div></div>';
h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
h+='<div class="pop-b"><span>üë•</span><div><div style="font-size:10px;color:#8a7a6a">POP</div><div class="pop-v">'+citizens.length+'/'+(GS.villageMaxPop||20)+'</div></div></div>';
h+='<div class="pop-b" style="border-color:rgba(255,140,0,0.3)"><span>üõ°Ô∏è</span><div><div style="font-size:10px;color:#8a7a6a">DEF</div><div class="pop-v" style="color:#ff8c00">'+fmt(def)+'</div></div></div>';
h+='<div class="pop-b" style="border-color:rgba(255,215,0,0.3)"><span>‚è∞</span><div><div style="font-size:10px;color:#8a7a6a">AFK TIME</div><div class="pop-v" style="color:#ffd700">'+Math.floor((GS.totalAFKTime||0)/3600)+'h</div></div></div>';
h+='</div></div>';

// === HP BAR ===
h+='<div style="background:rgba(0,0,0,0.4);border:1px solid rgba(100,200,100,0.2);border-radius:12px;padding:14px;margin-bottom:12px">';
h+='<div style="display:flex;justify-content:space-between;margin-bottom:8px"><div style="font-size:13px;font-weight:700">üèòÔ∏è Village HP</div><div style="font-size:13px;color:'+(hp<30?'#ff4444':'#38ef7d')+';font-weight:700">'+(GS.villageHp||100)+'/'+(GS.villageMaxHp||100)+'</div></div>';
h+='<div class="vhp-bar"><div class="vhp-fill" style="width:'+hp+'%;background:linear-gradient(90deg,'+(hp<30?'#8b0000,#ff4444':'#1a6b3c,#38ef7d')+')">'+Math.floor(hp)+'%</div></div>';
h+='<div style="display:flex;gap:12px;margin-top:8px;font-size:12px;color:#8a7a6a;flex-wrap:wrap">';
h+='<span>‚ö° <b style="color:#00d4ff">+'+vQiB().toFixed(1)+'/s</b></span>';
h+='<span>üí∞ <b style="color:#ffd700">+'+Math.floor(vGoldB()*100)+'%</b></span>';
h+='<span>üõ°Ô∏è <b style="color:#38ef7d">'+fmt(def)+'</b></span>';
if(citizens.length){const gps=citizens.reduce(function(s,c){const r=CITIZEN_ROLES.find(function(r2){return r2.id===c.roleId;});return s+(r&&r.goldPerSec?r.goldPerSec:0);},0);if(gps>0)h+='<span>üë• <b style="color:#f9ca24">+'+gps.toFixed(1)+'/s</b></span>';}
h+='</div>';
if(hp<100){const rc=Math.ceil(((GS.villageMaxHp||100)-(GS.villageHp||100))*100);h+='<button class="ub" style="margin-top:10px;background:linear-gradient(135deg,#7b1a1a,#c0392b)" onclick="repairVillage()">üî® Repair ‚Äî üí∞ '+fmt(rc)+'</button>';}
h+='</div>';

// === VILLAGE EVENTS ===
if(events.length){
h+='<h3 style="color:#ffd700;margin-bottom:8px;font-size:15px">‚ö° ACTIVE EVENTS</h3>';
h+='<div class="vev-container">';
events.forEach(function(ev,i){
h+='<div class="vev-row"><span style="font-size:24px">'+ev.e+'</span>';
h+='<div style="flex:1"><div style="font-size:13px;font-weight:700">'+ev.n+'</div><div style="font-size:11px;color:#8a7a6a">'+ev.desc+'</div></div>';
if(ev.choices&&ev.choices.length){
ev.choices.forEach(function(ch){
if(ch.cb)h+='<button class="qol-btn" onclick="resolveEventChoice('+i+',\''+ch.cb+'\')" style="font-size:10px;padding:4px 8px">'+ch.text+'</button>';
});
}
h+='<button class="qol-btn" onclick="resolveEventChoice('+i+',\'\')" style="font-size:10px;padding:4px 8px">‚úï</button>';
h+='</div>';
});
h+='</div>';
}

// === TABS (structures / citizens / missions / heroes) ===
h+='<div style="display:flex;gap:5px;margin-bottom:12px;background:rgba(0,0,0,0.3);padding:6px;border-radius:10px;border:1px solid rgba(255,215,0,0.1)" id="villTabBar">';
['structures','citizens','missions','heroes','log'].forEach(function(tab){
const icons={structures:'üèóÔ∏è',citizens:'üë•',missions:'üó∫Ô∏è',heroes:'‚öîÔ∏è',log:'üìú'};
h+='<button class="qol-btn" id="vtab-'+tab+'" onclick="showVillTab(\''+tab+'\')" style="flex:1;text-align:center">'+icons[tab]+' '+tab.charAt(0).toUpperCase()+tab.slice(1)+'</button>';
});
h+='</div>';

// === STRUCTURES ===
h+='<div id="villTab-structures">';
h+='<div class="vill-grid">';
Object.keys(VSTRUCTS).forEach(function(k){
const s=VSTRUCTS[k];const lv=GS.village[k]||0;
const cost=Math.floor(s.baseCost*Math.pow(s.costMult,lv));
const isMax=lv>=s.maxLv;const canBuy=GS.gold>=cost&&!isMax;
h+='<div class="vill-card'+(hp<50&&lv>0?' dmg':'')+'">';
h+='<div style="text-align:center;font-size:32px;margin-bottom:6px">'+s.e+'</div>';
h+='<div style="font-size:13px;font-weight:700;text-align:center;margin-bottom:4px">'+s.n+'</div>';
h+='<div style="font-size:10px;color:#8a7a6a;text-align:center;margin-bottom:6px">'+s.desc+'</div>';
h+='<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px"><span style="color:#8a7a6a">Lv</span><span style="color:#ffd700;font-weight:700">'+lv+'/'+s.maxLv+'</span></div>';
if(lv>0){
h+='<div style="height:4px;background:rgba(255,215,0,0.1);border-radius:2px;margin-bottom:6px"><div style="width:'+(lv/s.maxLv*100)+'%;height:100%;background:linear-gradient(90deg,#1a6b3c,#38ef7d);border-radius:2px"></div></div>';
}
if(s.defense>0)h+='<div style="font-size:10px;color:#38ef7d;margin-bottom:2px">üõ°Ô∏è +'+s.defense*lv+'</div>';
if(s.qiB>0)h+='<div style="font-size:10px;color:#00d4ff;margin-bottom:2px">‚ö° +'+s.qiB*lv+'/s</div>';
if(s.goldB>0)h+='<div style="font-size:10px;color:#ffd700;margin-bottom:2px">üí∞ +'+Math.floor(s.goldB*lv*100)+'%</div>';
h+='<button class="ub" onclick="buildStructure(\''+k+'\')" '+(canBuy?'':'disabled')+'>';
h+=isMax?'‚úÖ MAX':(lv===0?'üèóÔ∏è Build':'‚¨ÜÔ∏è Upgrade')+' ‚Äî üí∞ '+fmt(cost);
h+='</button></div>';
});
h+='</div></div>';

// === CITIZENS ===
h+='<div id="villTab-citizens" style="display:none">';
h+='<h3 style="color:#38ef7d;margin-bottom:10px;font-size:15px">üë• HIRE CITIZENS</h3>';
h+='<div class="citizen-grid">';
CITIZEN_ROLES.forEach(function(role){
const lv=GS.village[role.reqBuilding]||0;
const locked=lv===0;
const cost=getCitizenCost(role.id);
const cnt=(GS.citizens||[]).filter(function(c){return c.roleId===role.id;}).length;
h+='<div class="citizen-card'+(locked?' lk':'')+'" style="'+(locked?'opacity:0.4':'')+'">';
h+='<div style="font-size:28px;margin-bottom:6px">'+role.e+'</div>';
h+='<div style="font-size:12px;font-weight:700;margin-bottom:4px">'+role.n+'</div>';
h+='<div style="font-size:10px;color:#8a7a6a;margin-bottom:6px">'+role.desc+'</div>';
h+='<div style="font-size:10px;color:#a29bfe;margin-bottom:4px">Hired: '+cnt+'</div>';
if(locked)h+='<div style="font-size:10px;color:#555">Need: '+role.reqBuilding+'</div>';
else h+='<button class="ub" style="font-size:11px;padding:6px" onclick="hireCitizen(\''+role.id+'\')" '+(GS.gold<cost?'disabled':'')+'>Hire ‚Äî üí∞ '+fmt(cost)+'</button>';
h+='</div>';
});
h+='</div>';
if(citizens.length){
h+='<h3 style="color:#38ef7d;margin:12px 0 8px;font-size:14px">üë• YOUR CITIZENS ('+citizens.length+')</h3>';
h+='<div class="citizen-grid">';
citizens.forEach(function(c,i){
const role=CITIZEN_ROLES.find(function(r){return r.id===c.roleId;});
const lvl=Math.floor((c.exp||0)/100)+1;
h+='<div class="citizen-card">';
h+='<div style="font-size:24px;margin-bottom:4px">'+c.e+'</div>';
h+='<div style="font-size:11px;font-weight:700">'+c.name+' Lv'+lvl+'</div>';
h+='<div style="font-size:10px;color:#8a7a6a;margin:3px 0">'+(role?role.desc:'')+'</div>';
h+='<div style="font-size:10px;color:#a29bfe;margin-bottom:4px">EXP: '+Math.floor(c.exp||0)+'</div>';
h+='<button class="ub" style="font-size:10px;padding:4px;background:linear-gradient(135deg,#5c1010,#c0392b)" onclick="fireCitizen('+i+')">Dismiss</button>';
h+='</div>';
});
h+='</div>';
}
h+='</div>';

// === MISSIONS ===
h+='<div id="villTab-missions" style="display:none">';
h+='<h3 style="color:#a29bfe;margin-bottom:10px;font-size:15px">üó∫Ô∏è VILLAGE MISSIONS</h3>';
GS.missions.forEach(function(m){
const prog=(GS.missionProgress[m.id]||0);
const pct=Math.floor(prog*100);
const locked=m.reqBuilding&&!(GS.village[m.reqBuilding]>0);
const onCooldown=m.cooldown>0;
h+='<div class="mission-card'+(m.active?' active':'')+'" style="'+(locked?'opacity:0.4':'')+'">';
h+='<div style="display:flex;align-items:center;gap:10px">';
h+='<span style="font-size:28px">'+m.e+'</span>';
h+='<div style="flex:1">';
h+='<div style="font-size:13px;font-weight:700;margin-bottom:2px">'+m.n+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a;margin-bottom:4px">'+m.desc+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a">‚è±Ô∏è '+Math.floor(m.duration/60)+'min';
if(m.reward)h+=' | üí∞ '+fmt(m.reward);
if(m.rewardMat)h+=' | ü™® Materials';
if(m.rewardItem)h+=' | üéÅ Item';
h+='</div>';
h+='</div>';
if(locked)h+='<div style="font-size:10px;color:#555;text-align:right">Need:<br>'+m.reqBuilding+'</div>';
else if(m.done)h+='<button class="ub" style="width:auto;padding:8px 16px;background:linear-gradient(135deg,#1a6b3c,#27ae60)" onclick="claimMission(\''+m.id+'\')">‚úÖ Claim!</button>';
else if(m.active)h+='<div style="font-size:12px;color:#a29bfe;text-align:center">'+pct+'%<br>active</div>';
else if(onCooldown)h+='<div style="font-size:11px;color:#555;text-align:center">‚è≥<br>'+Math.ceil(m.cooldown)+'s</div>';
else h+='<button class="ub" style="width:auto;padding:8px 16px" onclick="startMission(\''+m.id+'\')">‚ñ∂ Start</button>';
h+='</div>';
if(m.active||m.done){
h+='<div class="mission-prog"><div class="mission-prog-fill" style="width:'+pct+'%"></div></div>';
}
h+='</div>';
});
h+='</div>';

// === HEROES ===
h+='<div id="villTab-heroes" style="display:none">';
h+='<h3 style="color:#ffd700;margin-bottom:10px;font-size:15px">‚öîÔ∏è VILLAGE DEFENDERS</h3>';
if(vheroes.length===0){
h+='<div style="text-align:center;color:#8a7a6a;padding:30px">No village heroes yet.<br>Hire from wandering hero events!</div>';
}else{
vheroes.forEach(function(hero,i){
h+='<div class="vhero-card'+(hero.deployed?' deployed':'')+'">';
h+='<span style="font-size:32px">'+hero.e+'</span>';
h+='<div style="flex:1"><div style="font-size:14px;font-weight:700">'+hero.name+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a">Power: <b style="color:#38ef7d">'+hero.power+'</b></div>';
h+='<div style="font-size:11px;color:#8a7a6a">Status: <b style="color:'+(hero.deployed?'#ffd700':'#555')+'">'+(hero.deployed?'Deployed':'Idle')+'</b></div></div>';
h+='<button class="ub" style="width:auto;padding:8px 14px;'+(hero.deployed?'background:linear-gradient(135deg,#7b1a1a,#c0392b)':'')+'" onclick="deployVHero('+i+')">'+(hero.deployed?'Recall':'Deploy')+'</button>';
h+='</div>';
});
}
h+='</div>';

// === LOG ===
h+='<div id="villTab-log" style="display:none">';
h+='<h3 style="color:#38ef7d;margin-bottom:8px;font-size:14px">üìú VILLAGE LOG</h3>';
h+='<div class="vlog" id="villLogEl">'+(GS.villageLog||[]).slice().reverse().map(function(l){return'<div>'+l+'</div>';}).join('')||'<div style="color:#8a7a6a">No events yet</div>'+'</div>';
h+='</div>';

document.getElementById('villageContent').innerHTML=h;
// Default to structures tab
showVillTab('structures');
}

function showVillTab(tab){
['structures','citizens','missions','heroes','log'].forEach(function(t){
const el=document.getElementById('villTab-'+t);
const btn=document.getElementById('vtab-'+t);
if(el)el.style.display=t===tab?'':'none';
if(btn){btn.classList.toggle('spd-active',t===tab);}
});
}

// ================================================================
// PATCH: loop ticks ‚Äî add citizen, mission, event ticks
// Injected by modifying the loop's checkAchievements section
// ================================================================
// We hook into saveGame interval instead to avoid touching loop
// This runs every 5 seconds alongside save
let _tickTimer=0;
// Village ticks run via setInterval in startLoop below

// ================================================================
// ADDITIONAL QOL FUNCTIONS
// ================================================================
function autoEquipBest(){
// Auto-equip highest stat items from bag
const slots=['weapon','armor','ring','amulet','boots','helm'];
let equipped2=0;
slots.forEach(function(slot){
const candidates=GS.itemBag.filter(function(item){return item.slot===slot;});
if(!candidates.length)return;
candidates.sort(function(a,b){return b.val-a.val;});
const best=candidates[0];
const cur=GS.equipped[slot];
if(!cur||best.val>cur.val){
const idx=GS.itemBag.indexOf(best);
equipItem(idx);
equipped2++;
}
});
if(equipped2>0)notify('‚öîÔ∏è Auto-Equipped',equipped2+' items upgraded!','nf');
else notify('‚öîÔ∏è Auto-Equip','Already wearing best gear!','nf');
}

function disenchantAll(){
// Disenchant all items below Rare into essence
let count=0,total=0;
GS.itemBag=GS.itemBag.filter(function(item){
// Keep Rare+ or equipped slots
const isEquipped=Object.values(GS.equipped).some(function(e){return e&&e.id===item.id;});
if(isEquipped)return true;
if(item.rarIdx<2){
GS.smithMats.essence=(GS.smithMats.essence||0)+item.rarIdx+1;
total+=item.rarIdx+1;count++;
return false;
}
return true;
});
if(count>0)notify('‚ö´ Disenchanted',count+' items ‚Üí +'+total+' Essence','nf');
else notify('‚ö´ Nothing','No Common/Uncommon to disenchant','');
renderBlacksmith();
}

function upgradeItem(idx){
const item=GS.itemBag[idx];
if(!item||item.rarIdx>=4){notify('‚úÖ Already Legendary','Cannot upgrade further','');return;}
const costs=[0,3,8,20,50];
const cost=costs[item.rarIdx];
if((GS.smithMats.crystal||0)<cost){notify('‚ùå Need Crystal','Need '+cost+' Crystal','nk');return;}
GS.smithMats.crystal-=cost;
item.rarIdx++;
item.val=parseFloat((item.val*1.4).toFixed(2));
item.rarity=['Common','Uncommon','Rare','Epic','Legendary'][item.rarIdx];
item.color=RARITY_COLORS[item.rarIdx];
notify('‚¨ÜÔ∏è Upgraded!',item.n+' ‚Üí '+item.rarity,'nf');
renderBlacksmith();
}

// ================================================================
// EXPOSE NEW FUNCTIONS TO WINDOW
// ================================================================
window.claimAFK=claimAFK;
window.claimPendingAFK=claimPendingAFK;
window.showVillTab=showVillTab;
window.hireCitizen=hireCitizen;
window.fireCitizen=fireCitizen;
window.startMission=startMission;
window.claimMission=claimMission;
window.resolveEventChoice=resolveEventChoice;
window.deployVHero=deployVHero;
window.autoEquipBest=autoEquipBest;
window.disenchantAll=disenchantAll;
window.upgradeItem=upgradeItem;
window.repairVillage=repairVillage;
window.buildStructure=buildStructure;

// ================================================================
// VILLAGE MAP LAYOUT DATA
// ================================================================
const VILLAGE_GRID_LAYOUT=[
{cell:0,key:'wall',name:'Wall',icon:'üß±',prod:null},
{cell:1,key:'barracks',name:'Barracks',icon:'üèõÔ∏è',prod:function(lv){return '+'+lv*30+'def'}},
{cell:2,key:'barracks',name:'Barracks',icon:'üèõÔ∏è',prod:null},
{cell:3,key:'watchtower',name:'Watchtower',icon:'üóº',prod:null},
{cell:4,key:'watchtower',name:'Watchtower',icon:'üóº',prod:null},
{cell:5,key:'wall',name:'Wall',icon:'üß±',prod:null},
{cell:6,key:'farm',name:'Farm',icon:'üåæ',prod:function(lv){return lv+'üçé/s'}},
{cell:7,key:'farm',name:'Farm',icon:'üåæ',prod:function(lv){return lv+'üçé/s'}},
{cell:8,key:'market',name:'Market',icon:'üè™',prod:function(lv){return '+'+lv*2+'%üí∞'}},
{cell:9,key:'hospital',name:'Hospital',icon:'üè•',prod:null},
{cell:10,key:'shrine',name:'Shrine',icon:'‚õ©Ô∏è',prod:function(lv){return '+'+lv*0.5+'‚ö°'}},
{cell:11,key:'farm',name:'Farm',icon:'üåæ',prod:function(lv){return lv+'üçé/s'}},
{cell:12,key:'forge',name:'Forge',icon:'‚öíÔ∏è',prod:function(lv){return lv+'ü™®/m'}},
{cell:13,key:'forge',name:'Forge',icon:'‚öíÔ∏è',prod:null},
{cell:14,key:'market',name:'Market',icon:'üè™',prod:null},
{cell:15,key:'shrine',name:'Shrine',icon:'‚õ©Ô∏è',prod:null},
{cell:16,key:'hospital',name:'Hospital',icon:'üè•',prod:null},
{cell:17,key:'farm',name:'Farm',icon:'üåæ',prod:null},
{cell:18,key:'wall',name:'Wall',icon:'üß±',prod:null},
{cell:19,key:'barracks',name:'Barracks',icon:'üèõÔ∏è',prod:null},
{cell:20,key:'market',name:'Market',icon:'üè™',prod:null},
{cell:21,key:'forge',name:'Forge',icon:'‚öíÔ∏è',prod:null},
{cell:22,key:'barracks',name:'Barracks',icon:'üèõÔ∏è',prod:null},
{cell:23,key:'wall',name:'Wall',icon:'üß±',prod:null}
];

function getGridBuildings(){
const grid={};
VILLAGE_GRID_LAYOUT.forEach(function(b){
grid[b.cell]={key:b.key,name:b.name,icon:b.icon,prod:b.prod};
});
return grid;
}

// Currently selected cell
let _selCell=-1;
function selectVCell(cell){
_selCell=cell;
const GRID=getGridBuildings();
const panel=document.getElementById('vCellPanel');
if(!panel)return;
const bd=GRID[cell];
if(!bd){panel.innerHTML='<div class="vbuild-panel"><h4>Empty Plot</h4><div style="font-size:12px;color:#8a7a6a">No building available for this plot</div></div>';return;}
const s=VSTRUCTS[bd.key];
const lv=GS.village[bd.key]||0;
const cost=Math.floor(s.baseCost*Math.pow(s.costMult,lv));
const isMax=lv>=s.maxLv;
const canBuy=GS.gold>=cost&&!isMax;
let h='<div class="vbuild-panel">';
h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">';
h+='<span style="font-size:32px">'+bd.icon+'</span>';
h+='<div><h4 style="margin-bottom:2px">'+bd.name+' (Lv '+lv+')</h4>';
h+='<div style="font-size:11px;color:#8a7a6a">'+s.desc+'</div></div>';
h+='</div>';
h+='<div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:8px">';
if(s.defense)h+='<span style="color:#38ef7d">üõ°Ô∏è Defense: +'+s.defense*lv+'</span>';
if(s.qiB)h+='<span style="color:#00d4ff">‚ö° Qi: +'+s.qiB*lv+'/s</span>';
if(s.goldB)h+='<span style="color:#ffd700">üí∞ Gold: +'+Math.floor(s.goldB*lv*100)+'%</span>';
if(s.pop)h+='<span style="color:#a29bfe">üë• Pop: +'+s.pop*lv+'</span>';
h+='</div>';
h+='<button class="ub" onclick="buildStructure(\''+bd.key+'\')" '+(canBuy?'':'disabled')+'>';
h+=isMax?'‚úÖ MAX LEVEL':(lv===0?'üèóÔ∏è Build ‚Äî ':'‚¨ÜÔ∏è Upgrade ‚Äî ')+'üí∞ '+fmt(cost);
h+='</button>';
h+='</div>';
panel.innerHTML=h;
}

// ================================================================
// DAY/NIGHT CYCLE + VILLAGE RESOURCES
// ================================================================
if(GS.isDay===undefined)GS.isDay=true;
if(!GS.dayTimer)GS.dayTimer=120;
if(!GS.vResources)GS.vResources={food:0,wood:0,stone:0};

function tickDayNight(dt2){
GS.dayTimer=Math.max(0,GS.dayTimer-dt2);
if(GS.dayTimer<=0){
GS.isDay=!GS.isDay;
GS.dayTimer=GS.isDay?120:60;
if(!GS.isDay){
// Night: random raid chance
if(Math.random()<0.15&&(GS.village.barracks||0)===0){
const dmg=Math.max(1,5-Math.floor(vDef()/200));
GS.villageHp=Math.max(1,GS.villageHp-dmg);
addVillageLog('üåô Night raid! -'+dmg+' HP');
notify('üåô Night Raid!','Village took '+dmg+' damage','nb');
}
}else{
// Dawn bonus
const foodFarms=(GS.village.farm||0);
if(foodFarms>0){
GS.vResources.food=Math.min(500,(GS.vResources.food||0)+foodFarms*2);
}
addVillageLog((GS.isDay?'‚òÄÔ∏è Dawn':'üåô Dusk')+' ‚Äî day changes');
}
// Update day/night visuals
const badge=document.getElementById('dayNightOv');
if(badge)badge.style.background='rgba(0,0,'+(GS.isDay?'0,0':'60,0.25')+')';
}
// Update timer display
const timerEl=document.getElementById('dayTimer');
if(timerEl)timerEl.textContent=Math.ceil(GS.dayTimer)+'s';

// Resource production
const farms=GS.village.farm||0;
const forges=GS.village.forge||0;
if(farms>0)GS.vResources.food=Math.min(9999,(GS.vResources.food||0)+farms*0.1*dt2);
if(forges>0)GS.vResources.stone=Math.min(9999,(GS.vResources.stone||0)+forges*0.05*dt2);
// Wood from watchtower scouts
if(GS.village.watchtower>0)GS.vResources.wood=Math.min(9999,(GS.vResources.wood||0)+0.05*dt2);
// Food consumed by citizens
const foodRate=(GS.citizens||[]).length*0.01;
GS.vResources.food=Math.max(0,(GS.vResources.food||0)-foodRate*dt2);
// If no food, citizens get unhappy (slower production)
}

// ================================================================
// ADDITIONAL EXPORTS TO WINDOW
// ================================================================
window.selectVCell=selectVCell;
window.tickDayNight=tickDayNight;

// ================================================================
// SECT SYSTEM ‚Äî Replaces Prestige
// Contribution (was tge) earns sect ranks ‚Üí unlock bonuses
// ================================================================
const SECT_RANKS=[
{id:'outer',n:'Outer Disciple',e:'üìø',minContrib:0,bonus:{gold:0,qi:0,dmg:0},color:'#aaa'},
{id:'inner',n:'Inner Disciple',e:'üèÆ',minContrib:50000,bonus:{gold:0.1,qi:0.2,dmg:0},color:'#74b9ff'},
{id:'core',n:'Core Disciple',e:'üîÆ',minContrib:500000,bonus:{gold:0.25,qi:0.5,dmg:0.1},color:'#38ef7d'},
{id:'elder',n:'Sect Elder',e:'‚öúÔ∏è',minContrib:5000000,bonus:{gold:0.5,qi:1,dmg:0.2},color:'#ffd700'},
{id:'grand-elder',n:'Grand Elder',e:'üåü',minContrib:50000000,bonus:{gold:1,qi:2,dmg:0.35},color:'#ff6b9d'},
{id:'sovereign',n:'Sect Sovereign',e:'üëë',minContrib:500000000,bonus:{gold:2,qi:5,dmg:0.5},color:'#ffd700'}
];

const SECT_SKILLS=[
{id:'qi_condensation',n:'Qi Condensation',e:'üíß',desc:'Cultivate 20% faster',cost:1,effect:'qi',val:0.2,maxLv:5,tier:0},
{id:'iron_body',n:'Iron Body',e:'ü™®',desc:'Heroes deal +15% damage',cost:1,effect:'dmg',val:0.15,maxLv:5,tier:0},
{id:'spirit_sense',n:'Spirit Sense',e:'üëÅÔ∏è',desc:'Gold income +20%',cost:1,effect:'gold',val:0.2,maxLv:5,tier:0},
{id:'void_step',n:'Void Step',e:'üå´Ô∏è',desc:'Pet power +25%',cost:2,effect:'pet',val:0.25,maxLv:3,tier:1,req:'qi_condensation'},
{id:'blood_sacrifice',n:'Blood Sacrifice',e:'ü©∏',desc:'Crit chance +10%',cost:2,effect:'crit',val:0.1,maxLv:3,tier:1,req:'iron_body'},
{id:'merchant_path',n:'Merchant Path',e:'üí±',desc:'Gold √ó 1.5 from kills',cost:2,effect:'gold_kill',val:0.5,maxLv:3,tier:1,req:'spirit_sense'},
{id:'celestial_sight',n:'Celestial Sight',e:'üåå',desc:'All multipliers +30%',cost:3,effect:'all',val:0.3,maxLv:2,tier:2,req:'void_step'},
{id:'eternal_flame',n:'Eternal Flame',e:'üî•',desc:'DPS never decays',cost:3,effect:'dps',val:1,maxLv:1,tier:2,req:'blood_sacrifice'},
{id:'dao_heart',n:'Dao Heart',e:'‚òØÔ∏è',desc:'Breakthrough costs -50%',cost:4,effect:'bt_cost',val:0.5,maxLv:1,tier:2,req:'merchant_path'}
];

if(!GS.sectSkills)GS.sectSkills={};
if(!GS.sectPoints)GS.sectPoints=0;
if(!GS.sectPointsSpent)GS.sectPointsSpent=0;

function getSectRank(){
const contrib=GS.contribution||0;
let rank=SECT_RANKS[0];
for(const r of SECT_RANKS){if(contrib>=r.minContrib)rank=r;}
return rank;
}
function getSectRankName(){return getSectRank().n;}
function getSectBonus(){
const rank=getSectRank();
const skills=GS.sectSkills||{};
const b={gold:rank.bonus.gold,qi:rank.bonus.qi,dmg:rank.bonus.dmg,pet:0,crit:0,gold_kill:0,all:0,bt_cost:0};
SECT_SKILLS.forEach(function(sk){
const lv=skills[sk.id]||0;
if(lv>0){
const eff=sk.val*lv;
if(sk.effect==='qi')b.qi=(b.qi||0)+eff;
else if(sk.effect==='dmg')b.dmg=(b.dmg||0)+eff;
else if(sk.effect==='gold')b.gold=(b.gold||0)+eff;
else if(sk.effect==='pet')b.pet=(b.pet||0)+eff;
else if(sk.effect==='crit')b.crit=(b.crit||0)+eff;
else if(sk.effect==='gold_kill')b.gold_kill=(b.gold_kill||0)+eff;
else if(sk.effect==='all')b.all=(b.all||0)+eff;
else if(sk.effect==='bt_cost')b.bt_cost=(b.bt_cost||0)+eff;
}
});
return b;
}
function sectBonusMult(){const b=getSectBonus();return(1+b.dmg)*(1+(b.all||0));}
function buySectSkill(id){
const sk=SECT_SKILLS.find(function(s){return s.id===id;});
if(!sk)return;
const lv=GS.sectSkills[id]||0;
if(lv>=sk.maxLv){notify('‚úÖ Maxed','Already at max level','');return;}
if(sk.req&&!(GS.sectSkills[sk.req]>0)){notify('üîí Locked','Need: '+sk.req.replace(/_/g,' '),'nk');return;}
const cost=sk.cost*(lv+1);
if((GS.sectPoints||0)<cost){notify('‚ùå Need Points',cost+' sect points needed','nk');return;}
GS.sectPoints-=cost;GS.sectPointsSpent=(GS.sectPointsSpent||0)+cost;
GS.sectSkills[id]=(GS.sectSkills[id]||0)+1;
notify('‚ö° Sect Skill',''+sk.n+' Lv'+(lv+1),'nvill');
addLog('‚ö° Sect skill: '+sk.n+' Lv'+(lv+1),'lq');
renderSect();
}
// Earn sect points from contribution milestones
let _lastContribCheck=0;
function checkSectPoints(){
const contrib=GS.contribution||0;
const milestone=Math.floor(Math.log10(Math.max(1,contrib)));
if(milestone>(_lastContribCheck||0)){
const gained=milestone-(_lastContribCheck||0);
GS.sectPoints=(GS.sectPoints||0)+gained;
_lastContribCheck=milestone;
notify('üèØ Sect Point!','+'+gained+' point(s)','nvill');
}
}

function renderSect(){
const rank=getSectRank();
const nextRank=SECT_RANKS[SECT_RANKS.indexOf(rank)+1];
const contrib=GS.contribution||0;
const pct=nextRank?Math.min(100,(contrib-rank.minContrib)/(nextRank.minContrib-rank.minContrib)*100):100;
const b=getSectBonus();
let h='';

// Header
h+='<div class="sect-wrap">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px">';
h+='<div>';
h+='<div class="sect-rank-badge '+rank.id+'">'+rank.e+' '+rank.n+'</div>';
h+='<div style="font-size:12px;color:#8a7a6a;margin-top:6px">Sect Points: <b style="color:#a78bfa">'+(GS.sectPoints||0)+'</b> available</div>';
h+='</div>';
h+='<div style="text-align:right;font-size:12px;color:#8a7a6a">';
h+='Contribution: <b style="color:#ffd700">'+fmt(contrib)+'</b>';
if(nextRank)h+='<br>Next rank: <b style="color:'+nextRank.color+'">'+fmt(nextRank.minContrib)+'</b>';
h+='</div></div>';

// Progress bar
if(nextRank){
h+='<div class="sect-contrib-bar"><div class="sect-contrib-fill" style="width:'+pct.toFixed(1)+'%">'+pct.toFixed(0)+'%</div></div>';
h+='<div style="font-size:10px;color:#8a7a6a;margin-top:4px;text-align:right">‚Üí '+nextRank.e+' '+nextRank.n+'</div>';
}else{
h+='<div style="text-align:center;font-size:13px;color:#ffd700;margin-top:8px">üëë MAX RANK ACHIEVED</div>';
}
h+='</div>';

// Rank bonuses
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:14px">';
SECT_RANKS.forEach(function(r){
const reached=contrib>=r.minContrib;
h+='<div style="background:rgba(0,0,0,0.4);border:1px solid '+(reached?r.color+'50':'rgba(255,255,255,0.05)')+';border-radius:10px;padding:10px;text-align:center;'+(reached?'':'opacity:0.4')+'">';
h+='<div style="font-size:20px;margin-bottom:4px">'+r.e+'</div>';
h+='<div style="font-size:11px;font-weight:700;color:'+r.color+'">'+r.n+'</div>';
h+='<div style="font-size:10px;color:#8a7a6a;margin-top:4px">';
if(r.bonus.gold>0)h+='+'+Math.floor(r.bonus.gold*100)+'% Gold<br>';
if(r.bonus.qi>0)h+='+'+r.bonus.qi+' Qi/s<br>';
if(r.bonus.dmg>0)h+='+'+Math.floor(r.bonus.dmg*100)+'% DMG';
h+='</div></div>';
});
h+='</div>';

// Active bonuses
if(b.gold>0||b.qi>0||b.dmg>0||b.crit>0){
h+='<div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:10px;padding:10px;margin-bottom:14px;display:flex;gap:12px;flex-wrap:wrap;font-size:12px">';
h+='<span style="color:#a78bfa">‚ö° ACTIVE BONUSES:</span>';
if(b.gold>0)h+='<span style="color:#ffd700">üí∞ +'+Math.floor(b.gold*100)+'%</span>';
if(b.qi>0)h+='<span style="color:#00d4ff">‚ö° +'+b.qi+'/s</span>';
if(b.dmg>0)h+='<span style="color:#ff8c00">‚öîÔ∏è +'+Math.floor(b.dmg*100)+'%</span>';
if(b.crit>0)h+='<span style="color:#ff6b6b">üí• +'+Math.floor(b.crit*100)+'% crit</span>';
h+='</div>';
}

// Skill tree
h+='<h3 style="color:#a78bfa;margin-bottom:12px;font-size:15px">‚ö° SECT SKILL TREE</h3>';
const tiers={0:'Foundation Skills',1:'Advanced Skills',2:'Master Skills'};
for(const tier in tiers){
const tierSkills=SECT_SKILLS.filter(function(s){return s.tier==tier;});
h+='<div style="margin-bottom:12px"><div style="font-size:11px;color:#8a7a6a;letter-spacing:1px;margin-bottom:6px">'+tiers[tier].toUpperCase()+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px">';
tierSkills.forEach(function(sk){
const lv=GS.sectSkills[sk.id]||0;
const unlocked=!sk.req||(GS.sectSkills[sk.req]>0);
const maxed=lv>=sk.maxLv;
const cost=sk.cost*(lv+1);
const canBuy=(GS.sectPoints||0)>=cost&&unlocked&&!maxed;
h+='<div class="sect-skill-card'+(lv>0?' unlocked':'')+'" style="'+(unlocked?'':'opacity:0.4')+'">';
h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
h+='<span style="font-size:24px">'+sk.e+'</span>';
h+='<div><div style="font-size:12px;font-weight:700">'+sk.n+'</div>';
h+='<div style="font-size:10px;color:#8a7a6a">'+sk.desc+'</div></div></div>';
h+='<div style="display:flex;justify-content:space-between;align-items:center;font-size:10px">';
h+='<span style="color:'+(lv>0?'#38ef7d':'#555')+'">Lv '+lv+'/'+sk.maxLv+'</span>';
if(sk.req)h+='<span style="color:#8a7a6a">Req: '+sk.req.split('_')[0]+'</span>';
h+='</div>';
h+='<button class="sect-btn" style="width:100%;margin-top:6px;font-size:11px;padding:6px" onclick="buySectSkill(\''+sk.id+'\')" '+(canBuy?'':'disabled')+'>';
h+=maxed?'‚úÖ MAX':(!unlocked?'üîí Locked':'Learn ‚Äî ‚ö°'+cost+'pts');
h+='</button></div>';
});
h+='</div></div>';
}
const _el_sectContent=document.getElementById('sectContent');if(_el_sectContent)_el_sectContent.innerHTML=h;
}

// ================================================================
// DAO LAWS SYSTEM ‚Äî Passive permanent upgrades with kill points
// ================================================================
const DAO_LAWS=[
{id:'sword',n:'Sword Dao',e:'‚öîÔ∏è',desc:'Pure cutting power',color:'#ff6b6b',
 nodes:[
  {id:'s1',n:'Sharp Edge',e:'‚öîÔ∏è',desc:'DMG +10%',cost:1,max:5,effect:'dmg',val:0.1},
  {id:'s2',n:'Blade Aura',e:'üåä',desc:'AOE +20%',cost:2,max:3,effect:'aoe',val:0.2,req:'s1'},
  {id:'s3',n:'Sword God',e:'‚≠ê',desc:'DMG √ó2 permanently',cost:5,max:1,effect:'dmg_big',val:1.0,req:'s2'}
 ]},
{id:'thunder',n:'Thunder Dao',e:'‚ö°',desc:'Speed and lightning',color:'#74b9ff',
 nodes:[
  {id:'t1',n:'Swift Strike',e:'‚ö°',desc:'Attack speed +15%',cost:1,max:5,effect:'spd',val:0.15},
  {id:'t2',n:'Chain Lightning',e:'üå©Ô∏è',desc:'Skills CD -20%',cost:2,max:3,effect:'cd',val:0.2,req:'t1'},
  {id:'t3',n:'Thunder God',e:'üåå',desc:'All speed √ó2',cost:5,max:1,effect:'spd_big',val:1.0,req:'t2'}
 ]},
{id:'wealth',n:'Wealth Dao',e:'üí∞',desc:'Riches flow eternal',color:'#ffd700',
 nodes:[
  {id:'w1',n:'Gold Sense',e:'üí∞',desc:'Gold +15%',cost:1,max:5,effect:'gold',val:0.15},
  {id:'w2',n:'Fortune Sight',e:'üéØ',desc:'Item drop +25%',cost:2,max:3,effect:'drop',val:0.25,req:'w1'},
  {id:'w3',n:'Wealth God',e:'‚ôæÔ∏è',desc:'Gold √ó3 forever',cost:5,max:1,effect:'gold_big',val:2.0,req:'w2'}
 ]},
{id:'life',n:'Life Dao',e:'üíö',desc:'Vitality and endurance',color:'#38ef7d',
 nodes:[
  {id:'l1',n:'Vital Qi',e:'üíö',desc:'Qi regen +20%',cost:1,max:5,effect:'qi_regen',val:0.2},
  {id:'l2',n:'Iron Will',e:'üõ°Ô∏è',desc:'Village HP +50',cost:2,max:3,effect:'vhp',val:50,req:'l1'},
  {id:'l3',n:'Life God',e:'üåø',desc:'Qi max √ó2',cost:5,max:1,effect:'qi_big',val:1.0,req:'l2'}
 ]}
];

if(!GS.daoNodes)GS.daoNodes={};
if(!GS.daoPoints)GS.daoPoints=0;
if(!GS.killPoints)GS.killPoints=0;

// Earn Dao Points from kills
let _lastKillPointCheck=0;
function checkDaoPoints(){
const kills=GS.mk||0;
const milestones=[100,500,1000,5000,10000,50000,100000,500000,1000000];
milestones.forEach(function(m){
if(kills>=m&&(_lastKillPointCheck||0)<m){
GS.daoPoints=(GS.daoPoints||0)+1;
_lastKillPointCheck=m;
notify('‚òØÔ∏è Dao Point!','+1 Dao Point ('+fmt(kills)+' kills)','nski');
}
});
if(kills>(_lastKillPointCheck||0)&&kills>=1000000){
const extra=Math.floor((kills-1000000)/500000);
const expected=milestones.length+extra;
const current=Object.values(GS.daoNodes).reduce(function(s,v){return s+v;},0)+(GS.daoPoints||0);
}
}

function getDaoBonus(){
const b={dmg:0,spd:0,gold:0,drop:0,qi_regen:0,vhp:0,qi_big:0,gold_big:0,dmg_big:0,spd_big:0,cd:0,aoe:0};
DAO_LAWS.forEach(function(path){
path.nodes.forEach(function(node){
const lv=GS.daoNodes[node.id]||0;
if(lv>0){
const key=node.effect;
if(b[key]!==undefined)b[key]+=node.val*lv;
}
});
});
return b;
}

function buyDaoNode(pathId,nodeId){
const path=DAO_LAWS.find(function(p){return p.id===pathId;});
if(!path)return;
const node=path.nodes.find(function(n){return n.id===nodeId;});
if(!node)return;
const lv=GS.daoNodes[nodeId]||0;
if(lv>=node.max){notify('‚úÖ Maxed','','');return;}
if(node.req&&!(GS.daoNodes[node.req]>0)){notify('üîí Locked','Need '+node.req+' first','nk');return;}
const cost=node.cost*(lv+1);
if((GS.daoPoints||0)<cost){notify('‚ùå Need Points',cost+' Dao Points needed','nk');return;}
GS.daoPoints-=cost;
GS.daoNodes[nodeId]=(GS.daoNodes[nodeId]||0)+1;
notify('‚òØÔ∏è Dao Law!',node.n+' Lv'+(lv+1),'nski');
addLog('‚òØÔ∏è Dao: '+node.n+' Lv'+(lv+1),'lq');
// Life Dao vhp effect
if(node.effect==='vhp'){GS.villageMaxHp=(GS.villageMaxHp||100)+node.val;GS.villageHp=(GS.villageHp||100)+node.val;}
renderDaoLaws();
}

function renderDaoLaws(){
const db=getDaoBonus();
let h='';
h+='<div class="dao-wrap">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">';
h+='<div><div style="font-size:20px;font-weight:900;color:#00d4ff">‚òØÔ∏è DAO LAWS</div>';
h+='<div style="font-size:12px;color:#8a7a6a">Permanent power from the Dao</div></div>';
h+='<div style="display:flex;gap:10px">';
h+='<div class="dao-pts-bar" style="margin:0"><span style="font-size:16px">‚òØÔ∏è</span><div><div style="font-size:14px;font-weight:700;color:#00d4ff">'+(GS.daoPoints||0)+'</div><div style="font-size:10px;color:#8a7a6a">Dao Points</div></div></div>';
h+='<div class="dao-pts-bar" style="margin:0"><span style="font-size:16px">üíÄ</span><div><div style="font-size:14px;font-weight:700;color:#ffd700">'+fmt(GS.mk||0)+'</div><div style="font-size:10px;color:#8a7a6a">Total Kills</div></div></div>';
h+='</div></div>';

// Active bonuses summary
const anyBonus=Object.values(db).some(function(v){return v>0;});
if(anyBonus){
h+='<div style="background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.15);border-radius:10px;padding:10px;margin-bottom:14px;display:flex;gap:10px;flex-wrap:wrap;font-size:12px">';
h+='<span style="color:#00d4ff">‚òØÔ∏è ACTIVE:</span>';
if(db.dmg>0||db.dmg_big>0)h+='<span style="color:#ff6b6b">‚öîÔ∏è +'+Math.floor((db.dmg+db.dmg_big)*100)+'% DMG</span>';
if(db.spd>0||db.spd_big>0)h+='<span style="color:#74b9ff">‚ö° +'+Math.floor((db.spd+db.spd_big)*100)+'% SPD</span>';
if(db.gold>0||db.gold_big>0)h+='<span style="color:#ffd700">üí∞ +'+Math.floor((db.gold+db.gold_big)*100)+'% GOLD</span>';
if(db.qi_regen>0||db.qi_big>0)h+='<span style="color:#00d4ff">‚ö° +'+Math.floor((db.qi_regen+db.qi_big)*100)+'% QI</span>';
if(db.drop>0)h+='<span style="color:#a29bfe">üéÅ +'+Math.floor(db.drop*100)+'% DROP</span>';
h+='</div>';
}
h+='</div>';

// Dao paths
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">';
DAO_LAWS.forEach(function(path){
h+='<div style="background:rgba(0,0,0,0.4);border:2px solid '+path.color+'30;border-radius:14px;padding:14px">';
h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">';
h+='<span style="font-size:24px">'+path.nodes[0].e+'</span>';
h+='<div><div style="font-size:14px;font-weight:700;color:'+path.color+'">'+path.n+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a">'+path.desc+'</div></div></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
path.nodes.forEach(function(node,ni){
const lv=GS.daoNodes[node.id]||0;
const unlocked=!node.req||(GS.daoNodes[node.req]>0);
const maxed=lv>=node.max;
const cost=node.cost*(lv+1);
const canBuy=(GS.daoPoints||0)>=cost&&unlocked&&!maxed;
if(ni>0)h+='<div class="dao-connector'+(lv>0?' lit':'')+'"></div>';
h+='<div class="dao-node'+(maxed?' dao-maxed':lv>0?' dao-active':!unlocked?' dao-locked':'');
h+='" onclick="'+(unlocked&&!maxed?'buyDaoNode(\''+path.id+'\',\''+node.id+'\')':'')+'"';
h+=' title="'+node.n+': '+node.desc+(unlocked?' ‚Äî Cost: '+cost+' pts':'')+(node.req?' (Need: '+node.req+')':'')+'">';
h+='<div style="font-size:16px">'+node.e+'</div>';
h+='<div style="font-size:9px;color:#8a7a6a;text-align:center;line-height:1.2">'+node.n.split(' ')[0]+'</div>';
h+='<div style="font-size:9px;font-weight:700;color:'+(maxed?'#38ef7d':lv>0?path.color:'#555')+'">Lv'+lv+'/'+node.max+'</div>';
if(!maxed&&unlocked)h+='<div style="font-size:8px;color:#a29bfe;position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);white-space:nowrap">'+cost+'pts</div>';
h+='</div>';
});
h+='</div></div>';
});
h+='</div>';
const _el_daoContent=document.getElementById('daoContent');if(_el_daoContent)_el_daoContent.innerHTML=h;
}

// ================================================================
// TRIBULATION SYSTEM ‚Äî Breakthrough enhancement (replaces dull popup)
// At certain realm milestones, face a tribulation
// ================================================================
const TRIBULATIONS=[
{realm:2,n:'Foundation Tribulation',waves:3,hpMult:1,reward:{qiMax:20,sectPts:1}},
{realm:3,n:'Core Tribulation',waves:5,hpMult:2,reward:{qiMax:50,sectPts:2}},
{realm:4,n:'Soul Tribulation',waves:7,hpMult:4,reward:{qiMax:100,sectPts:3,daopts:1}},
{realm:6,n:'Void Tribulation',waves:10,hpMult:8,reward:{qiMax:200,sectPts:5,daopts:2}},
{realm:8,n:'Immortal Tribulation',waves:15,hpMult:16,reward:{qiMax:500,sectPts:10,daopts:5}}
];

let _tribActive=false;
let _tribData=null;
let _tribWave=0;
let _tribHp=0;
let _tribTimer=0;

function checkTribulation(realmIdx){
const trib=TRIBULATIONS.find(function(t){return t.realm===realmIdx;});
if(!trib)return false;
if(GS.completedTribs&&GS.completedTribs.includes(realmIdx))return false;
startTribulation(trib,realmIdx);
return true;
}
function startTribulation(trib,realmIdx){
_tribActive=true;_tribData=trib;_tribWave=1;_tribHp=100*trib.hpMult;_tribTimer=60;
const box=document.createElement('div');
box.className='trib-wrap';box.id='tribBox';
box.innerHTML='<div class="trib-box" style="position:relative"><div class="trib-lightning"></div>'+
'<div class="trib-wave-badge">‚ö° WAVE '+_tribWave+'/'+trib.waves+'</div>'+
'<div style="font-size:28px;font-weight:900;color:#a78bfa;margin-bottom:8px">‚õàÔ∏è '+trib.n+'</div>'+
'<div style="font-size:13px;color:#8a7a6a;margin-bottom:14px">Endure the Heavenly Tribulation!</div>'+
'<div class="trib-hp-bar"><div class="trib-hp-fill" id="tribHpFill" style="width:100%">'+Math.floor(_tribHp)+'</div></div>'+
'<div style="font-size:12px;color:#8a7a6a;margin:8px 0">Time: <span id="tribTimer">'+Math.ceil(_tribTimer)+'</span>s</div>'+
'<div style="font-size:12px;color:#a29bfe;margin-bottom:14px" id="tribStatus">Your heroes fight the tribulation...</div>'+
'<div style="font-size:12px;color:#38ef7d">Rewards: +'+trib.reward.qiMax+' Qi | +'+trib.reward.sectPts+' Sect Pts'+(trib.reward.daopts?' | +'+trib.reward.daopts+' Dao Pts':'')+'</div>'+
'</div>';
document.body.appendChild(box);
screenFlash('rgba(124,58,237,0.6)');
addLog('‚õàÔ∏è '+trib.n+' begins!','lski');
notify('‚õàÔ∏è TRIBULATION!',trib.n,'nski');
// Store realm for completion
GS._pendingTribRealm=realmIdx;
}
function tickTribulation(dt2){
if(!_tribActive||!_tribData)return;
_tribTimer=Math.max(0,_tribTimer-dt2);
// Heroes deal damage to tribulation
let dmg=0;
GS.ah.forEach(function(h){dmg+=h.pw*h.ar*dt2;});
dmg*=(1+getSectBonus().dmg)*(1+getDaoBonus().dmg);
_tribHp=Math.max(0,_tribHp-dmg);
// Update UI
const hpEl=document.getElementById('tribHpFill');
const tmEl=document.getElementById('tribTimer');
const stEl=document.getElementById('tribStatus');
if(hpEl){const pct=(_tribHp/(100*_tribData.hpMult*_tribWave))*100;hpEl.style.width=pct+'%';hpEl.textContent=Math.floor(_tribHp);}
if(tmEl)tmEl.textContent=Math.ceil(_tribTimer);
if(_tribHp<=0){
_tribWave++;
if(_tribWave>_tribData.waves){
// Victory!
completeTribulation(true);
}else{
_tribHp=100*_tribData.hpMult*_tribWave;
if(stEl)stEl.textContent='Wave '+_tribWave+'/'+_tribData.waves+' ‚Äî Growing stronger!';
const wb=document.querySelector('.trib-wave-badge');
if(wb)wb.textContent='‚ö° WAVE '+_tribWave+'/'+_tribData.waves;
screenFlash('rgba(124,58,237,0.3)');
}
}
if(_tribTimer<=0&&_tribHp>0){
completeTribulation(false);
}
}
function completeTribulation(success){
_tribActive=false;
const box=document.getElementById('tribBox');
if(box)box.remove();
if(success){
const r=_tribData.reward;
GS.qiMax+=r.qiMax;GS.sectPoints=(GS.sectPoints||0)+r.sectPts;
if(r.daopts)GS.daoPoints=(GS.daoPoints||0)+r.daopts;
if(!GS.completedTribs)GS.completedTribs=[];
GS.completedTribs.push(GS._pendingTribRealm||0);
showBanner('‚õàÔ∏è TRIBULATION CLEARED!','+'+r.qiMax+' Qi | +'+r.sectPts+' Sect Pts');
screenFlash('rgba(255,215,0,0.7)');
notify('‚úÖ Tribulation!','CLEARED! Rewards claimed!','nski');
addLog('‚úÖ Tribulation cleared! +'+r.qiMax+' Qi','lc');
}else{
// Failed ‚Äî partial reward
GS.sectPoints=(GS.sectPoints||0)+1;
notify('üíÄ Tribulation Failed','You survived but were weakened. +1 Sect Pt','nk');
addLog('üíÄ Tribulation failed, +1 Sect Point','lk');
}
_tribData=null;_tribWave=0;_tribTimer=0;
}

// ================================================================
// PATCH breakthrough() to check for tribulation
// ================================================================

window.breakthrough=breakthrough;

// ================================================================
// INTEGRATE: sect/dao bonuses into totalMult and qi regen
// ================================================================
// Patch totalMult to include sect+dao bonuses
// We can't reassign const, so we integrate via itemMult which is already in totalMult
// Instead patch sectBonusMult and daoBonusMult into itemMult

window.itemMult=itemMult;

// Gold bonus from dao/sect applied in killM

window.killM=killM;

// Dao/sect qi regen bonus
// Already handled by vQiB + sect bonus in qi regen line
// Patch loop qi regen: GS.qi = Math.min(qi + dt2*(5+vQiB()+sectQiBonus), qiMax)
// We add a helper:
function getTotalQiRegen(){
const sb=getSectBonus();
const db=getDaoBonus();
return 5+vQiB()+(sb.qi||0)+(db.qi_regen||0)*5;
}

// ================================================================
// PATCH loop qi regen to use getTotalQiRegen
// ================================================================
// This is patched inline below via string replacement

// ================================================================
// SAVE/LOAD new fields
// ================================================================
// Already handled by ks array update below

// ================================================================
// TICK tribulation in game loop (via interval)
// ================================================================
// Will be added to village interval

// ================================================================
// WINDOW EXPORTS
// ================================================================
window.renderSect=renderSect;
window.renderDaoLaws=renderDaoLaws;
window.buySectSkill=buySectSkill;
window.buyDaoNode=buyDaoNode;
window.checkTribulation=checkTribulation;
window.completeTribulation=completeTribulation;
window.getTotalQiRegen=getTotalQiRegen;

// ================================================================
// ELEMENTAL AFFINITY SYSTEM
// ================================================================
const ELEMENTS={
Fire:{e:'üî•',name:'Fire',color:'#ff5000',bonusDmg:0.25,bonusSpd:0,bonusCrit:0.05,weakness:'Water',desc:'High damage & crit. Weak to Water.'},
Water:{e:'üíß',name:'Water',color:'#0064ff',bonusDmg:0.1,bonusSpd:0,bonusCrit:0,healBonus:0.3,weakness:'Thunder',desc:'+30% heal, tanky. Weak to Thunder.'},
Thunder:{e:'‚ö°',name:'Thunder',color:'#ffc800',bonusDmg:0.15,bonusSpd:0.2,bonusCrit:0.1,weakness:'Earth',desc:'Fast attacks, high crit. Weak to Earth.'},
Wind:{e:'üå™Ô∏è',name:'Wind',color:'#64ff64',bonusDmg:0.05,bonusSpd:0.3,bonusCrit:0.05,aoeBonus:0.5,weakness:'Fire',desc:'+50% AOE, fast. Weak to Fire.'},
Earth:{e:'ü™®',name:'Earth',color:'#966432',bonusDmg:0.2,bonusSpd:0,bonusCrit:0,defBonus:50,weakness:'Wind',desc:'Highest damage, tanky. Weak to Wind.'}
};

function getElementMult(){
if(!GS.element||!ELEMENTS[GS.element])return 1;
const el=ELEMENTS[GS.element];
return 1+(el.bonusDmg||0)+(el.bonusCrit||0)*0.5+(el.bonusSpd||0)*0.2;
}

function chooseElement(el){
if(GS.elementChosen){notify('‚ùå Already chosen','Element is permanent!','nk');return;}
GS.element=el;
GS.elementChosen=true;
const e=ELEMENTS[el];
notify(e.e+' '+e.name,'Element locked in!','nski');
addLog(e.e+' Elemental Affinity: '+e.name+' chosen!','lski');
screenFlash('rgba(255,215,0,0.5)');
renderCult();
}

// Integrate element into totalMult ‚Äî override in itemMult which is already in chain
// Actually patch totalMult's effective output via elemental bonus in heroAtk
// We add to skillDmg calculation instead ‚Äî clean and isolated

// ================================================================
// SKILL UPGRADE TREE
// ================================================================
const SKILL_UPGRADES={
blast:{
tiers:[
{n:'Qi Blast I',e:'üî•',desc:'Base damage +50%',bonus:{dmg:0.5},cost:1},
{n:'Qi Blast II',e:'üî•',desc:'Cooldown -1s, AOE range +1',bonus:{dmg:0.5,cd:-1},cost:2},
{n:'Inferno Blast',e:'üåã',desc:'Damage √ó2, ignite stacks',bonus:{dmg:1,ignite:true},cost:3},
{n:'Void Cannon',e:'üí•',desc:'Damage √ó3, penetrates shields',bonus:{dmg:2},cost:5},
{n:'Singularity',e:'‚ö´',desc:'ULTIMATE: Damage √ó10, clears all enemies',bonus:{dmg:8,clear:true},cost:10}
]},
lightning:{
tiers:[
{n:'Lightning I',e:'‚ö°',desc:'Damage +80%',bonus:{dmg:0.8},cost:1},
{n:'Chain Lightning',e:'‚ö°',desc:'Hits 3 targets',bonus:{dmg:0.5,chain:3},cost:2},
{n:'Ball Lightning',e:'üå©Ô∏è',desc:'Lingers, deals DoT',bonus:{dmg:1,dot:true},cost:3},
{n:'Thunder God',e:'üå©Ô∏è',desc:'Damage √ó4, stuns',bonus:{dmg:3,stun:true},cost:5},
{n:'Heaven\'s Wrath',e:'‚òà',desc:'ULTIMATE: All enemies struck',bonus:{dmg:8,aoe:true},cost:10}
]},
heal:{
tiers:[
{n:'Heal I',e:'üíö',desc:'Heal +50%',bonus:{heal:0.5},cost:1},
{n:'Regeneration',e:'üíö',desc:'Regen 20 Qi/s for 5s',bonus:{heal:0.5,regen:true},cost:2},
{n:'Mass Heal',e:'üíó',desc:'Heals all allies',bonus:{heal:1},cost:3},
{n:'Divine Light',e:'‚ú®',desc:'Full heal + shield',bonus:{heal:3,shield:true},cost:5},
{n:'Celestial Grace',e:'üåü',desc:'ULTIMATE: Immortal for 5s',bonus:{heal:5,immortal:true},cost:10}
]},
tempest:{
tiers:[
{n:'Tempest I',e:'üå™Ô∏è',desc:'Hits +50 dmg per hit',bonus:{dmg:0.5},cost:1},
{n:'Void Tempest',e:'üåÄ',desc:'+1 hit, pull enemies',bonus:{dmg:0.5,hits:1},cost:2},
{n:'Storm Eye',e:'üåÄ',desc:'+2 hits, slows enemies',bonus:{dmg:1,hits:2},cost:3},
{n:'Cataclysm',e:'üí®',desc:'Hits √ó3, knockback',bonus:{dmg:2,hits:3},cost:5},
{n:'World Shatter',e:'üåç',desc:'ULTIMATE: 20 hits, destroys floor',bonus:{dmg:5,hits:10},cost:10}
]},
ascend:{
tiers:[
{n:'Buff I',e:'‚ú®',desc:'Buff to 2.5x, +5s duration',bonus:{buff:0.5,dur:5},cost:1},
{n:'Qi Surge',e:'‚ú®',desc:'Buff 3x, +10s',bonus:{buff:1,dur:10},cost:2},
{n:'Heaven Step',e:'üåü',desc:'Buff 4x, +15s, regen Qi',bonus:{buff:1,dur:15},cost:3},
{n:'Immortal Body',e:'üí´',desc:'Buff 5x, +20s, immune',bonus:{buff:2,dur:20},cost:5},
{n:'Dao Manifestation',e:'üåå',desc:'ULTIMATE: 10x buff for 60s',bonus:{buff:8,dur:60},cost:10}
]}
};

function upgradeSkillNode(skillId){
const tree=SKILL_UPGRADES[skillId];if(!tree)return;
const lv=GS.skills_lv[skillId]||0;
if(lv>=tree.tiers.length){notify('‚úÖ Max Tier','Skill fully upgraded!','');return;}
const tier=tree.tiers[lv];
if((GS.skillPoints||0)<tier.cost){notify('‚ùå Need '+tier.cost+' SP','Breakthrough to earn Skill Points!','nk');return;}
GS.skillPoints-=tier.cost;
GS.skills_lv[skillId]=lv+1;
// Apply bonus to skill data
const sk=GD.skills[skillId];
if(tier.bonus.dmg)sk.dmg=Math.floor(sk.dmg*(1+tier.bonus.dmg));
if(tier.bonus.heal)sk.heal=Math.floor((sk.heal||200)*(1+tier.bonus.heal));
if(tier.bonus.buff)sk.buff=(sk.buff||2)+tier.bonus.buff;
if(tier.bonus.hits)sk.hits=(sk.hits||1)+tier.bonus.hits;
if(tier.bonus.cd)sk.cd=Math.max(1,sk.cd+tier.bonus.cd);
notify('üîÆ Skill Upgraded!',tier.n,'nski');
addLog('üîÆ '+skillId+' ‚Üí '+tier.n,'lski');
screenFlash('rgba(0,212,255,0.4)');
renderSkillTree();
}

function renderSkillTree(){
const el=GS.element?ELEMENTS[GS.element]:null;
let h='<div style="background:linear-gradient(135deg,rgba(0,20,40,0.9),rgba(0,10,20,0.9));border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:16px;margin-bottom:14px">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px">';
h+='<div><div style="font-size:18px;font-weight:900;color:#00d4ff">üîÆ SKILL UPGRADE TREE</div>';
h+='<div style="font-size:12px;color:#8a7a6a">Skill Points from Breakthrough</div></div>';
h+='<div style="display:flex;gap:8px;align-items:center">';
h+='<div style="background:rgba(0,0,0,0.5);border:1px solid rgba(0,212,255,0.3);border-radius:20px;padding:6px 14px;font-size:14px;font-weight:700;color:#00d4ff">‚ö° SP: '+(GS.skillPoints||0)+'</div>';
if(el)h+='<div class="el-badge el-'+el.name+'">'+el.e+' '+el.name+'</div>';
h+='</div></div>';

// Element choice if not chosen
if(!GS.elementChosen){
h+='<div style="background:rgba(255,100,0,0.1);border:1px solid rgba(255,100,0,0.3);border-radius:10px;padding:14px;margin-bottom:14px">';
h+='<div style="text-align:center;font-size:14px;font-weight:700;color:#ff8c00;margin-bottom:12px">‚ö†Ô∏è Choose Your Elemental Affinity (Permanent!)</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px">';
Object.keys(ELEMENTS).forEach(function(k){
const e=ELEMENTS[k];
h+='<div class="el-choice" style="border-color:'+e.color+'50" onclick="chooseElement(\''+k+'\')">';
h+='<div style="font-size:28px;margin-bottom:6px">'+e.e+'</div>';
h+='<div style="font-size:12px;font-weight:700;color:'+e.color+'">'+e.name+'</div>';
h+='<div style="font-size:10px;color:#8a7a6a;margin-top:4px">'+e.desc+'</div>';
h+='</div>';
});
h+='</div></div>';
}
h+='</div>';

// Skill trees
Object.keys(SKILL_UPGRADES).forEach(function(sid){
const tree=SKILL_UPGRADES[sid];
const lv=GS.skills_lv[sid]||0;
const sk=GD.skills[sid];
h+='<div style="background:rgba(0,0,0,0.4);border:1px solid rgba(0,212,255,0.15);border-radius:12px;padding:14px;margin-bottom:10px">';
h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">';
h+='<span style="font-size:28px">'+sk.e+'</span>';
h+='<div style="flex:1"><div style="font-size:14px;font-weight:700;color:#00d4ff">'+sk.n+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a">DMG: '+sk.dmg+' | CD: '+sk.cd+'s | Lv '+lv+'/5</div></div>';
h+='</div>';
h+='<div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:4px">';
tree.tiers.forEach(function(tier,i){
const isCur=i===lv;
const isDone=i<lv;
const isNext=i===lv;
const canBuy=isNext&&(GS.skillPoints||0)>=tier.cost;
h+='<div class="sk-tree-node '+(isDone?'maxed':isCur&&!isDone?'unlocked':'locked')+'" style="min-width:120px;'+(isDone?'background:rgba(30,25,0,0.6);border-color:#ffd700':isCur?'border-color:#00d4ff':'')+'">'+
'<div class="sk-node-tier">Tier '+(i+1)+'</div>'+
'<div style="font-size:18px;margin-bottom:4px">'+tier.e+'</div>'+
'<div style="font-size:10px;font-weight:700;margin-bottom:3px">'+(isDone?'<span style="color:#ffd700">‚úÖ </span>':'')+tier.n+'</div>'+
'<div style="font-size:9px;color:#8a7a6a;margin-bottom:6px">'+tier.desc+'</div>'+
(isDone?'<div style="font-size:10px;color:#38ef7d">Unlocked</div>':
isNext?'<button class="ub" style="font-size:10px;padding:4px;width:100%" onclick="upgradeSkillNode(\''+sid+'\')" '+(canBuy?'':'disabled')+'>üîÆ '+tier.cost+' SP</button>':
'<div style="font-size:10px;color:#555">üîí Locked</div>')+
'</div>';
});
h+='</div></div>';
});
const el2=document.getElementById('skillTreeContent');
if(el2)el2.innerHTML=h;
}

// ================================================================
// DAILY QUESTS SYSTEM
// ================================================================
const QUEST_POOL=[
{id:'q_kill',n:'Monster Slayer',e:'üíÄ',type:'kill',target:50,reward:1000,rewardType:'gold'},
{id:'q_kill2',n:'Mass Slaughter',e:'‚öîÔ∏è',type:'kill',target:200,reward:5000,rewardType:'gold'},
{id:'q_floor',n:'Floor Diver',e:'üè∞',type:'floor',target:5,reward:2000,rewardType:'gold'},
{id:'q_bt',n:'Breakthrough',e:'‚ö°',type:'breakthrough',target:1,reward:3,rewardType:'sp'},
{id:'q_item',n:'Collector',e:'üéí',type:'item',target:3,reward:50,rewardType:'crystal'},
{id:'q_gold',n:'Earn Gold',e:'üí∞',type:'earn_gold',target:10000,reward:2,rewardType:'sp'},
{id:'q_skill',n:'Skill Master',e:'üî•',type:'use_skill',target:10,reward:1500,rewardType:'gold'},
{id:'q_boss',n:'Boss Hunter',e:'üëπ',type:'boss',target:1,reward:10000,rewardType:'gold'},
{id:'q_combo',n:'Combo King',e:'üî•',type:'combo',target:50,reward:3000,rewardType:'gold'},
{id:'q_craft',n:'Blacksmith',e:'‚öíÔ∏è',type:'forge',target:1,reward:5,rewardType:'essence'},
];

function resetDailyQuests(){
GS.dailyReset=Date.now();
const shuffled=QUEST_POOL.slice().sort(function(){return Math.random()-0.5;});
GS.dailyQuests=shuffled.slice(0,4).map(function(q){
return Object.assign({},q,{progress:0,claimed:false});
});
GS.dailyDone=0;
addLog('üìã Daily Quests refreshed!','lq');
}

function updateDailyQuestProgress(type,amount){
if(!GS.dailyQuests||!GS.dailyQuests.length)return;
GS.dailyQuests.forEach(function(q){
if(q.claimed||q.progress>=q.target)return;
if(q.type===type){
q.progress=Math.min(q.target,q.progress+amount);
if(q.progress>=q.target&&!q.claimed){
notify('üìã Quest Done!',q.n,'nf');
addLog('üìã Quest complete: '+q.n,'lc');
}
}
});
}

function claimDailyQuest(idx){
const q=GS.dailyQuests[idx];
if(!q||q.claimed||q.progress<q.target)return;
q.claimed=true;
GS.dailyDone=(GS.dailyDone||0)+1;
if(q.rewardType==='gold'){GS.gold+=q.reward;GS.tge+=q.reward;notify('üí∞ Claimed!','+'+fmt(q.reward)+' gold','nf');}
else if(q.rewardType==='sp'){GS.skillPoints=(GS.skillPoints||0)+q.reward;notify('üîÆ Skill Points!','+'+q.reward+' SP','nski');}
else if(q.rewardType==='crystal'){GS.smithMats.crystal=(GS.smithMats.crystal||0)+q.reward;notify('üíé Crystal!','+'+q.reward,'nf');}
else if(q.rewardType==='essence'){GS.smithMats.essence=(GS.smithMats.essence||0)+q.reward;notify('‚ö´ Essence!','+'+q.reward,'nf');}
addLog('‚úÖ Quest reward: '+q.n,'lc');
renderQuests();
}

function renderQuests(){
if(!GS.dailyQuests||!GS.dailyQuests.length)resetDailyQuests();
const msLeft=Math.max(0,86400000-(Date.now()-(GS.dailyReset||0)));
const hLeft=Math.floor(msLeft/3600000);
const mLeft=Math.floor((msLeft%3600000)/60000);
let h='<div style="background:rgba(0,0,0,0.4);border:1px solid rgba(162,155,254,0.2);border-radius:12px;padding:16px;margin-bottom:14px">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">';
h+='<div><div style="font-size:18px;font-weight:900;color:#a29bfe">üìã DAILY QUESTS</div>';
h+='<div style="font-size:12px;color:#8a7a6a">'+GS.dailyDone+'/4 completed today</div></div>';
h+='<div class="dq-timer">‚è∞ Resets in '+hLeft+'h '+mLeft+'m</div>';
h+='</div>';

(GS.dailyQuests||[]).forEach(function(q,i){
const pct=Math.floor((q.progress/q.target)*100);
h+='<div class="dq-card'+(q.claimed?' done':'')+'">';
h+='<div style="display:flex;align-items:center;gap:10px">';
h+='<span style="font-size:26px">'+q.e+'</span>';
h+='<div style="flex:1">';
h+='<div style="font-size:13px;font-weight:700'+(q.claimed?';color:#38ef7d':'')+'">'+q.n+(q.claimed?' ‚úÖ':'')+'</div>';
h+='<div style="font-size:11px;color:#8a7a6a">Progress: '+q.progress+'/'+q.target+'</div>';
h+='<div style="font-size:11px;color:#ffd700">Reward: ';
if(q.rewardType==='gold')h+='üí∞ '+fmt(q.reward);
else if(q.rewardType==='sp')h+='üîÆ '+q.reward+' SP';
else if(q.rewardType==='crystal')h+='üíé '+q.reward+' Crystal';
else if(q.rewardType==='essence')h+='‚ö´ '+q.reward+' Essence';
h+='</div></div>';
if(!q.claimed&&q.progress>=q.target){
h+='<button class="ub" style="width:auto;padding:8px 14px;font-size:12px;white-space:nowrap" onclick="claimDailyQuest('+i+')">‚úÖ Claim</button>';
}else if(q.claimed){
h+='<div style="font-size:20px">‚úÖ</div>';
}else{
h+='<div style="font-size:13px;color:#a29bfe;text-align:center;min-width:40px">'+pct+'%</div>';
}
h+='</div>';
if(!q.claimed){
h+='<div class="dq-prog-bar"><div class="dq-prog-fill" style="width:'+pct+'%"></div></div>';
}
h+='</div>';
});
h+='</div>';

// Weekly bonus tracker
h+='<div style="background:rgba(255,140,0,0.1);border:1px solid rgba(255,140,0,0.25);border-radius:12px;padding:14px">';
h+='<div style="font-size:14px;font-weight:700;color:#ff8c00;margin-bottom:10px">üåü WEEKLY CHALLENGES</div>';
const weekly=[
{n:'Kill 1000 monsters',e:'üíÄ',target:1000,cur:Math.min(GS.mk||0,1000),reward:'üîÆ 5 SP'},
{n:'Reach next Realm',e:'‚ö°',target:1,cur:GS.stage>0||GS.realm>0?1:0,reward:'üí∞ 100K Gold'},
{n:'Build 3 Village structures',e:'üèòÔ∏è',target:3,cur:Math.min(GS.villBuilt||0,3),reward:'ü™® 50 Materials'},
];
weekly.forEach(function(w){
const pct=Math.min(100,Math.floor((w.cur/w.target)*100));
h+='<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span>'+w.e+' '+w.n+'</span><span style="color:#ff8c00">'+w.reward+'</span></div>';
h+='<div class="dq-prog-bar" style="border-color:rgba(255,140,0,0.2)"><div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,#c0651a,#ff8c00);border-radius:4px;transition:width 0.4s"></div></div>';
h+='<div style="font-size:10px;color:#8a7a6a;margin-top:2px">'+w.cur+'/'+w.target+'</div></div>';
});
h+='</div>';

const el=document.getElementById('questsContent');
if(el)el.innerHTML=h;
}

// ================================================================
// DUNGEON SPECIAL ROOMS
// ================================================================
const ROOM_TYPES=[
{id:'treasure',n:'Treasure Room',e:'üíé',color:'#ffd700',desc:'Choose one treasure',
choices:function(){
const items=[genItem(),genItem(),genItem()];
items[Math.floor(Math.random()*3)].rarIdx=Math.min(4,2+Math.floor(GS.cf/100));
return items.map(function(it,i){return{text:it.e+' '+it.n+' ['+it.rarity+']',cb:function(){GS.itemBag.push(it);if(GS.itemBag.length>50)GS.itemBag.shift();notify('üéÅ Got!',it.n,'nf');closeDungeonRoom();GS.cf++;updateUI();}};});
}},
{id:'shrine',n:'Cultivation Shrine',e:'‚õ©Ô∏è',color:'#00d4ff',desc:'Restore Qi & fill breakthrough gauge',
choices:[
{text:'üßò Meditate (+100% Qi, +30% breakthrough)',cb:function(){GS.qi=GS.qiMax;GS.cp=Math.min(100,GS.cp+30);notify('‚õ©Ô∏è Shrine','Qi restored!','nski');closeDungeonRoom();GS.cf++;updateUI();}},
{text:'üí´ Insight (+1 Skill Point)',cb:function(){GS.skillPoints=(GS.skillPoints||0)+1;notify('üîÆ +1 SP','From shrine!','nski');closeDungeonRoom();GS.cf++;updateUI();}}
]},
{id:'gamble',n:'Gambling Den',e:'üé≤',color:'#a29bfe',desc:'Risk gold for big reward',
choices:function(){
const bet=Math.floor(GS.gold*0.2)||100;
return[
{text:'üé∞ Bet '+fmt(bet)+' gold (3√ó if win)',cb:function(){if(Math.random()<0.45){const win=bet*3;GS.gold+=win;GS.tge+=win;notify('üé≤ WIN!','+'+fmt(win)+' gold','nf');}else{GS.gold=Math.max(0,GS.gold-bet);notify('üé≤ Lose','-'+fmt(bet)+' gold','nk');}closeDungeonRoom();GS.cf++;updateUI();}},
{text:'üö™ Leave (safe)',cb:function(){closeDungeonRoom();GS.cf++;updateUI();}}
];
}},
{id:'elite',n:'Elite Chamber',e:'üíÄ',color:'#ff4444',desc:'Face a powerful enemy for big reward',
choices:[
{text:'‚öîÔ∏è Fight! (√ó10 reward)',cb:function(){const r=Math.floor(GS.cdps*50+GS.cf*1000);GS.gold+=r;GS.tge+=r;GS.mk+=10;notify('‚öîÔ∏è Elite Slain!','+'+fmt(r)+' gold','nf');closeDungeonRoom();GS.cf++;updateUI();}},
{text:'üèÉ Flee (skip floor)',cb:function(){closeDungeonRoom();GS.cf++;updateUI();}}
]},
{id:'mystery',n:'Mystery Portal',e:'üåÄ',color:'#9b59b6',desc:'Unknown rewards or dangers',
choices:[
{text:'üåÄ Enter (random)',cb:function(){
const rand=Math.random();
if(rand<0.3){const item=genItem();item.rarIdx=Math.min(4,item.rarIdx+2);item.color=RARITY_COLORS[item.rarIdx];GS.itemBag.push(item);showItemPopup(item);notify('üåÄ Lucky!',item.n,'nf');}
else if(rand<0.6){const g=Math.floor(GS.cf*5000);GS.gold+=g;GS.tge+=g;notify('üåÄ Gold!','+'+fmt(g),'nf');}
else if(rand<0.8){GS.qiMax+=10;notify('üåÄ Qi Expand!','+10 Max Qi','nski');}
else{GS.villageHp=Math.max(1,GS.villageHp-20);notify('üåÄ Cursed!','-20 Village HP','nk');}
closeDungeonRoom();GS.cf++;updateUI();
}},
{text:'üö™ Skip',cb:function(){closeDungeonRoom();GS.cf++;updateUI();}}
]}
];

let _roomCbs={};

function spawnDungeonRoom(){
const type=ROOM_TYPES[Math.floor(Math.random()*ROOM_TYPES.length)];
GS.dungeonRoom=type.id;
const choices=typeof type.choices==='function'?type.choices():type.choices;

// Store callbacks
_roomCbs={};
const cbKeys=choices.map(function(c,i){
const key='rcb_'+i;
_roomCbs[key]=c.cb;
return key;
});

const wrap=document.getElementById('dEntities');
if(!wrap)return;
const box=document.createElement('div');
box.className='room-banner';
box.id='dungeonRoomBox';
box.style.borderColor=type.color;
box.innerHTML='<div style="font-size:44px;margin-bottom:8px">'+type.e+'</div>'+
'<div style="font-size:18px;font-weight:900;color:'+type.color+';margin-bottom:6px;letter-spacing:2px">'+type.n+'</div>'+
'<div style="font-size:13px;color:#8a7a6a;margin-bottom:16px">'+type.desc+'</div>'+
'<div>'+choices.map(function(c,i){
return'<button class="room-choice-btn" onclick="roomChoiceCb(\''+cbKeys[i]+'\')">'+c.text+'</button>';
}).join('')+'</div>';
wrap.appendChild(box);
screenFlash('rgba(255,215,0,0.3)');
addLog(type.e+' Special Room: '+type.n,'lq');
}

function roomChoiceCb(key){
if(_roomCbs[key])_roomCbs[key]();
}

function closeDungeonRoom(){
GS.dungeonRoom=null;
_roomCbs={};
const box=document.getElementById('dungeonRoomBox');
if(box)box.remove();
const b=biome(GS.cf);
const cEl=document.getElementById('cBiome');
if(cEl)cEl.textContent=b.n;
// Save immediately after AFK rewards applied
saveGame();
}

// ================================================================
// COMBO MILESTONE SYSTEM
// ================================================================
const COMBO_MILESTONES={
100:{title:'Combo Centurion üî•',buff:1.5,duration:15,msg:'1.5√ó Power for 15s!'},
500:{title:'Combo God ‚ö°',buff:2,duration:30,msg:'2√ó Power for 30s + Skill Point!',sp:1},
1000:{title:'Combo Immortal üåü',buff:3,duration:60,msg:'3√ó Power for 60s + Rare Item!',item:true},
5000:{title:'Combo Deity üåå',buff:5,duration:120,msg:'5√ó Power for 2min + Legendary!',legendary:true}
};

function checkComboMilestone(){
const combo=GS.combo||0;
Object.keys(COMBO_MILESTONES).forEach(function(threshold){
const t=parseInt(threshold);
if(combo>=t&&!GS.comboMilestones[t]){
GS.comboMilestones[t]=true;
const ms=COMBO_MILESTONES[t];
GS.sbuff=(GS.sbuff||1)*ms.buff;
GS.sbuffT=ms.duration;
if(ms.sp){GS.skillPoints=(GS.skillPoints||0)+ms.sp;}
if(ms.item){const item=genItem();item.rarIdx=Math.min(4,item.rarIdx+1);GS.itemBag.push(item);showItemPopup(item);}
if(ms.legendary){const item=genItem();item.rarIdx=4;item.color=RARITY_COLORS[4];item.rarity='Legendary';GS.itemBag.push(item);showItemPopup(item);}
// Pop banner
const el=document.createElement('div');
el.className='combo-milestone-pop';
el.innerHTML='üî• '+ms.title+'<br><span style="font-size:13px;font-weight:400">'+ms.msg+'</span>';
document.body.appendChild(el);
setTimeout(function(){el.remove();},2500);
notify('üî• MILESTONE!',ms.title,'nski');
addLog('üî• Combo Milestone: '+ms.title,'lc');
screenFlash('rgba(255,100,0,0.5)');
}
// Reset milestone flags for new combos after combo resets
if(combo<t&&GS.comboMilestones[t])GS.comboMilestones[t]=false;
});
}

// ================================================================
// CULTIVATION INSIGHT SYSTEM
// ================================================================
const INSIGHT_POOL=[
{msg:'Heaven reveals: Qi flows faster',stat:'qiRegen',val:0.1},
{msg:'Sword intent sharpens the mind',stat:'dmg',val:0.02},
{msg:'The void whispers of gold',stat:'gold',val:0.02},
{msg:'One step closer to immortality',stat:'qi',val:5},
{msg:'Monsters fear your aura',stat:'dmg',val:0.03},
{msg:'The Dao smiles upon you',stat:'all',val:0.01},
{msg:'Ancient technique remembered',stat:'skillCd',val:-0.05},
{msg:'Blood boils with power',stat:'dmg',val:0.05},
{msg:'Stars align for your path',stat:'all',val:0.02},
{msg:'The mountain bows',stat:'dmg',val:0.04},
];

function triggerInsight(){
if((GS.insightTotal||0)>=100)return;
const pool=INSIGHT_POOL;
const ins=pool[Math.floor(Math.random()*pool.length)];
GS.insights=GS.insights||[];
GS.insights.push(ins);
GS.insightTotal=(GS.insightTotal||0)+1;
// Apply tiny bonus
if(ins.stat==='qiRegen'||ins.stat==='all')GS.qiMax+=1;
if(ins.stat==='qi')GS.qiMax=Math.min(GS.qiMax+ins.val,GS.qiMax+5);
GS.insightBonus=(GS.insightBonus||0)+0.005;
// Show flash notification
const el=document.createElement('div');
el.className='insight-flash';
el.innerHTML='<div class="insight-title">üí° CULTIVATION INSIGHT #'+GS.insightTotal+'</div>'+
'<div class="insight-body">'+ins.msg+'<br><span style="color:#4a148c;font-weight:700">+0.5% permanent power</span></div>';
document.body.appendChild(el);
setTimeout(function(){el.remove();},3200);
}

// ================================================================
// AUCTION HOUSE SYSTEM
// ================================================================
function spawnAuction(){
GS.auctionItems=[];
for(let i=0;i<3;i++){
const item=genItem();
item.rarIdx=Math.min(4,item.rarIdx+1);
item.color=RARITY_COLORS[item.rarIdx];
item.rarity=['Common','Uncommon','Rare','Epic','Legendary'][item.rarIdx];
const basePrice=Math.floor(Math.pow(10,item.rarIdx+2)*(1+GS.cf*0.5));
GS.auctionItems.push({item:item,minBid:basePrice,curBid:basePrice,myBid:0,winner:null});
}
GS.auctionTimer=30;
GS.auctionActive=true;
notify('üèõÔ∏è Auction!','New items available for 30s!','nc');
addLog('üèõÔ∏è Auction House opened!','lq');
}

function bidAuction(idx,amount){
const lot=GS.auctionItems[idx];
if(!lot||!GS.auctionActive)return;
const bid=lot.curBid+Math.floor(lot.curBid*0.1)+amount;
if(GS.gold<bid){notify('‚ùå Not enough gold','Need '+fmt(bid),'nk');return;}
GS.gold-=bid;
// Refund previous bid if any
if(lot.myBid>0){GS.gold+=lot.myBid;GS.tge-=lot.myBid;}
lot.myBid=bid;
lot.curBid=bid;
lot.winner='player';
notify('üí∞ Bid placed!',fmt(bid)+' for '+lot.item.n,'nf');
renderAuction();
}

function endAuction(){
GS.auctionActive=false;
let won=0;
(GS.auctionItems||[]).forEach(function(lot){
if(lot.winner==='player'){
GS.itemBag.push(lot.item);
if(GS.itemBag.length>50)GS.itemBag.shift();
showItemPopup(lot.item);
won++;
}
});
if(won>0)notify('üèõÔ∏è Auction Won!','Got '+won+' item(s)!','nf');
else notify('üèõÔ∏è Auction Over','No items won','');
GS.auctionItems=[];
}

function renderAuction(){
let h='<div style="background:rgba(20,10,0,0.6);border:1px solid rgba(255,140,0,0.25);border-radius:12px;padding:16px;margin-bottom:14px">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px">';
h+='<div><div style="font-size:18px;font-weight:900;color:#ff8c00">üèõÔ∏è AUCTION HOUSE</div>';
h+='<div style="font-size:12px;color:#8a7a6a">New auction every 5 minutes</div></div>';
if(GS.auctionActive){
h+='<div><div class="auction-timer'+(GS.auctionTimer<10?' urgent':'')+'">‚è∞ '+Math.ceil(GS.auctionTimer)+'s</div>';
h+='<div style="font-size:10px;color:#8a7a6a;text-align:center">remaining</div></div>';
}
h+='</div>';

if(!GS.auctionActive||!GS.auctionItems||GS.auctionItems.length===0){
h+='<div style="text-align:center;color:#8a7a6a;padding:30px;font-size:14px">No active auction.<br>Next auction starts automatically every 5 minutes.<br><button class="qol-btn" style="margin-top:10px" onclick="spawnAuction()">üèõÔ∏è Start Auction Now</button></div>';
}else{
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">';
(GS.auctionItems||[]).forEach(function(lot,i){
const isWinning=lot.winner==='player';
h+='<div class="auction-card" style="border-color:'+lot.item.color+'40'+(isWinning?';box-shadow:0 0 15px '+lot.item.color+'40':'')+'">'+
'<div style="text-align:center;font-size:32px;margin-bottom:6px">'+lot.item.e+'</div>'+
'<div style="text-align:center;font-size:13px;font-weight:700;color:'+lot.item.color+'">'+lot.item.n+'</div>'+
'<div style="text-align:center;font-size:11px;color:'+lot.item.color+';margin-bottom:8px">'+lot.item.rarity+'</div>'+
'<div style="font-size:11px;color:#8a7a6a;text-align:center;margin-bottom:8px">+'+lot.item.val+' '+lot.item.stat+'</div>'+
'<div style="text-align:center;margin-bottom:8px"><div style="font-size:11px;color:#8a7a6a">Current Bid</div>'+
'<div style="font-size:16px;font-weight:700;color:'+(isWinning?'#38ef7d':'#ffd700')+'">üí∞ '+fmt(lot.curBid)+'</div>'+
(isWinning?'<div style="font-size:10px;color:#38ef7d">‚úÖ You\'re winning!</div>':'')+
'</div>'+
'<button class="bid-btn" style="width:100%" onclick="bidAuction('+i+',0)" '+(GS.gold<lot.curBid+Math.floor(lot.curBid*0.1)?'disabled':'')+'>'+
'üí∞ Bid '+fmt(lot.curBid+Math.floor(lot.curBid*0.1))+
'</button></div>';
});
h+='</div>';
}
h+='</div>';
const el=document.getElementById('auctionContent');
if(el)el.innerHTML=h;
}

// ================================================================
// RANKING BOARD
// ================================================================
function saveRun(){
const run={
date:new Date().toLocaleDateString(),
floor:GS.cf,
kills:GS.mk,
realm:GD.realms[GS.realm].n+' '+GD.realms[GS.realm].stages[GS.stage],
combo:GS.mc||0,
element:GS.element||'None',
gold:GS.tge||0,
prestige:GS.pc||0,
ts:Date.now()
};
GS.rankingBoard=GS.rankingBoard||[];
GS.rankingBoard.push(run);
// Keep top 10 by floor
GS.rankingBoard.sort(function(a,b){return b.floor-a.floor;});
if(GS.rankingBoard.length>10)GS.rankingBoard=GS.rankingBoard.slice(0,10);
}

function renderRanking(){
const board=GS.rankingBoard||[];
let h='<div style="background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.2);border-radius:12px;padding:16px;margin-bottom:14px">';
h+='<div style="font-size:18px;font-weight:900;color:#ffd700;margin-bottom:4px">üèÜ PERSONAL RANKING</div>';
h+='<div style="font-size:12px;color:#8a7a6a;margin-bottom:14px">Your best runs (saved each prestige)</div>';
if(!board.length){
h+='<div style="text-align:center;color:#8a7a6a;padding:30px">No runs saved yet.<br>Prestige to save your run!</div>';
}else{
['floor','kills','combo'].forEach(function(cat){
const label={floor:'üè∞ Best Floor',kills:'üíÄ Most Kills',combo:'üî• Highest Combo'}[cat];
const sorted=[...board].sort(function(a,b){return b[cat]-a[cat];});
h+='<div style="margin-bottom:16px"><div style="font-size:13px;font-weight:700;color:#ffd700;margin-bottom:8px">'+label+'</div>';
sorted.slice(0,5).forEach(function(run,i){
const colors=['#ffd700','#c0c0c0','#cd7f32','#8a7a6a','#8a7a6a'];
h+='<div class="rank-row">'+
'<div class="rank-num" style="color:'+colors[i]+'">'+(i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'#'+(i+1))+'</div>'+
'<div style="flex:1">'+
'<div style="font-size:12px;font-weight:700">'+run.realm+'</div>'+
'<div style="font-size:10px;color:#8a7a6a">Floor '+run.floor+' | '+fmt(run.kills)+' kills | '+run.element+' | '+run.date+'</div>'+
'</div>'+
'<div style="font-size:14px;font-weight:700;color:'+colors[i]+'">'+fmt(run[cat])+'</div>'+
'</div>';
});
h+='</div>';
});
}
h+='</div>';

// Current session stats
h+='<div style="background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.15);border-radius:12px;padding:14px">';
h+='<div style="font-size:14px;font-weight:700;color:#ffd700;margin-bottom:10px">üìä THIS SESSION</div>';
const stats=[
['üè∞ Current Floor',GS.cf+'/'+WORLD_MAX[GS.cworld]],
['üíÄ Total Kills',fmt(GS.mk)],
['üî• Max Combo',GS.mc||0],
['üí∞ Total Gold',fmt(GS.tge||0)],
[GS.element?(ELEMENTS[GS.element].e+' Element'):('‚ùì Element'),GS.element||'Not chosen'],
['üîÆ Skill Points',GS.skillPoints||0],
['üí° Insights',GS.insightTotal||0],
['‚è∞ AFK Time',Math.floor((GS.totalAFKTime||0)/3600)+'h '+Math.floor(((GS.totalAFKTime||0)%3600)/60)+'m'],
];
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
stats.forEach(function(s){
h+='<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,215,0,0.1);border-radius:8px;padding:8px"><div style="font-size:10px;color:#8a7a6a">'+s[0]+'</div><div style="font-size:14px;font-weight:700;color:#ffd700">'+s[1]+'</div></div>';
});
h+='</div></div>';
const el=document.getElementById('rankingContent');
if(el)el.innerHTML=h;
}

// ================================================================
// PATCH totalMult to include elemental + insight bonus
// ================================================================
// We add these to itemMult() which is already in the chain
const _baseItemMult=itemMult;
// Override itemMult (it's a regular function, not const arrow)
// Actually itemMult is const arrow - so we cannot reassign
// Instead, we expose the bonuses via separate function and use in heroAtk

function getExtraMult(){
const el=GS.element&&ELEMENTS[GS.element]?ELEMENTS[GS.element]:null;
const elBonus=el?1+(el.bonusDmg||0):1;
const insBonus=1+(GS.insightBonus||0);
return elBonus*insBonus;
}

// Patch heroAtk to include extra mult - find where pw is calculated
// heroAtk uses h.pw which is set at spawn time
// Better: patch spawnEnts to use getExtraMult
// Actually the cleanest way is patch the gold/damage in heroAtk directly

// ================================================================
// PATCH doPrestige to save ranking
// ================================================================
// Find prestige button and patch
// The prestige button calls 'doPrestige()' - find that function

// ================================================================
// PATCH updateUI for daily quest progress on gold earn
// ================================================================
// We track gold earn via comparing each tick

// ================================================================
// PATCH useSkill for daily quest
// ================================================================
// Actually just patch the internal useSkill function body by adding at the top
// This is messy - instead handle in the function directly

// WINDOW EXPORTS for all new functions
window.chooseElement=chooseElement;
window.upgradeSkillNode=upgradeSkillNode;
window.renderSkillTree=renderSkillTree;
window.renderQuests=renderQuests;
window.claimDailyQuest=claimDailyQuest;
window.spawnDungeonRoom=spawnDungeonRoom;
window.roomChoiceCb=roomChoiceCb;
window.closeDungeonRoom=closeDungeonRoom;
window.checkComboMilestone=checkComboMilestone;
window.bidAuction=bidAuction;
window.spawnAuction=spawnAuction;
window.renderAuction=renderAuction;
window.renderRanking=renderRanking;
window.saveRun=saveRun;
window.getExtraMult=getExtraMult;
window.triggerInsight=triggerInsight;

init();
</script>
</body>
</html>
